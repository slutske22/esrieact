"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9580],{29986:(e,t,r)=>{r.d(t,{A:()=>n});var s=r(98849),a=r(539),i=r(20698);function n(e,t,r,s,i){if(null==e)return null;const n=e.referencesGeometry()&&i?l(t,s,i):t,o=e.repurposeFeature(n);try{return e.evaluate({...r,$feature:o},e.services)}catch(c){return a.A.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",c),null}}const o=new Map;function l(e,t,r){const{transform:n,hasZ:l,hasM:c}=r;o.has(t)||o.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,r,s,a)=>(0,i.Tr)(r,t,e,s,a);case"esriGeometryPolygon":return(e,r,s,a)=>(0,i.$X)(r,t,e,s,a);case"esriGeometryPolyline":return(e,r,s,a)=>(0,i.P5)(r,t,e,s,a);case"esriGeometryMultipoint":return(e,r,s,a)=>(0,i.SW)(r,t,e,s,a);default:return a.A.getLogger("esri.views.2d.support.arcadeOnDemand").error(new s.A("mapview-arcade",`Unable to handle geometryType: ${e}`)),e=>e}}(t));const u=o.get(t)(e.geometry,n,l,c);return{...e,geometry:u}}},54421:(e,t,r)=>{r.d(t,{A:()=>l});var s=r(66866),a=r(52495),i=r(21564),n=(r(73446),r(85569),r(39831),r(63863));let o=class extends a.A{initialize(){}destroy(){}get supportsTileUpdates(){return!1}get spatialReference(){const e=this.tileStore.tileScheme.spatialReference;return e&&e.toJSON()||null}};(0,s._)([(0,i.MZ)({readOnly:!0})],o.prototype,"supportsTileUpdates",null),(0,s._)([(0,i.MZ)({constructOnly:!0})],o.prototype,"remoteClient",void 0),(0,s._)([(0,i.MZ)({constructOnly:!0})],o.prototype,"service",void 0),(0,s._)([(0,i.MZ)()],o.prototype,"spatialReference",null),(0,s._)([(0,i.MZ)({constructOnly:!0})],o.prototype,"tileInfo",void 0),(0,s._)([(0,i.MZ)({constructOnly:!0})],o.prototype,"tileStore",void 0),o=(0,s._)([(0,n.$)("esri.views.2d.layers.features.processors.BaseProcessor")],o);const l=o},32437:(e,t,r)=>{r.r(t),r.d(t,{default:()=>w});var s=r(66866),a=r(21870),i=(r(98849),r(39831),r(539),r(6267)),n=r(40189),o=(r(73446),r(85569),r(63863)),l=r(64442),c=r(78983),u=r(65065),d=r(79432),h=r(82547),f=r(23951),m=r(32964),y=r(9725),p=r(65126),g=r(54421);class _{constructor(e){this._remoteClient=e,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}async fetchResource(e,t){const r=this._resourceMap,s=r.get(e);if(s)return s;let a=this._inFlightResourceMap.get(e);if(a)return a;try{a=this._remoteClient.invoke("tileRenderer.fetchResource",{url:e},{...t}),this._inFlightResourceMap.set(e,a),a.then((t=>(this._inFlightResourceMap.delete(e),r.set(e,t),t)))}catch(i){return(0,n.zf)(i)?null:{width:0,height:0}}return a}getResource(e){return this._resourceMap.get(e)??null}loadFont(e){return Promise.resolve(null)}}function b(e,t){const r=t-t/4,s=t+t/2;return(!e.minScale||e.minScale>=r)&&(!e.maxScale||e.maxScale<=s)}function S(e){const t=e.message,r={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin,version:t.version},transferList:new Array};for(const s in t.data){const e=s,a=t.data[e];if(r.message.data[e]=null,null!=a){const t=a.stride,s=a.indices.slice(0),i=a.vertices.slice(0),n=a.records.slice(0),o=a.metrics?.slice(0),l={stride:t,indices:s,vertices:i,records:n,metrics:o};r.transferList.push(s,i,n),r.message.data[e]=l}}return r}let v=class extends g.A{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new _(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(e){this._bufferIds.forEach((t=>{t.forEach(e)}))}async update(e,t){const r=t.schema.processors[0];if("symbol"!==r.type)return;const s=(0,l.Ui)(this._schema,r);((0,l.EB)(s,"mesh")||(0,l.EB)(s,"target"))&&(e.mesh=!0,e.why?.mesh.push("Symbology changed"),this._schema=r,this._factory=this._createFactory(r),this._factory.update(r,this.tileStore.tileScheme.tileInfo))}onTileMessage(e,t,r,s){return(0,n.Te)(s),this._onTileData(e,t,r,s)}onTileClear(e,t){const r={clear:!0,end:t};return this._bufferData.delete(e.key.id),this._bufferIds.delete(e.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:r})}onTileError(e,t,r){const s=r.signal,a={tileKey:e.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",a,{signal:s})}onTileUpdate(e){for(const t of e.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of e.added)this._bufferData.forEach((e=>{for(const r of e)r.message.tileKey===t.id&&this._updateTileMesh("append",t,S(r),[],!1,!1,null)}))}_addBufferData(e,t){this._bufferData.has(e)||this._bufferData.set(e,[]),this._bufferData.get(e)?.push(S(t))}_createFactory(e){const{geometryType:t,objectIdField:r,fields:s}=this.service,a={geometryType:t,fields:s,spatialReference:c.A.fromJSON(this.spatialReference)},i=new m._y(((e,t)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",e,t)),this.tileStore.tileScheme.tileInfo),{matcher:n,aggregateMatcher:o}=e.mesh;return this._store=i,this._matchers.feature=(0,y.P7)(n,i,a,this._resourceManagerProxy),this._matchers.aggregate=o?(0,y.P7)(o,i,a,this._resourceManagerProxy):null,new f.K(t,r,i)}async _onTileData(e,t,r,s){(0,n.Te)(s);const{type:a,addOrUpdate:i,remove:o,clear:l,end:c}=t,u=!!this._schema.mesh.sortKey;if(!i){const t={type:a,addOrUpdate:null,remove:o,clear:l,end:c,sort:u};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:t},s)}const d=this._processFeatures(e,i,r,s,t.status?.version);try{const r=await d;if(null==r){const t={type:a,addOrUpdate:null,remove:o,clear:l,end:c,sort:u};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:t},s)}const i=[];for(const t of r){let r=!1;const s=t.message.bufferIds,a=e.key.id,n=t.message.tileKey;if(a!==n&&null!=s){if(!this.tileStore.get(n)){this._addBufferData(a,t),i.push(t);continue}let e=this._bufferIds.get(n);e||(e=new Set,this._bufferIds.set(n,e));const o=Array.from(s);for(const t of o){if(e.has(t)){r=!0;break}e.add(t)}}r||(this._addBufferData(a,t),i.push(t))}await Promise.all(i.map((r=>{const i=e.key.id===r.message.tileKey,n=i?t.remove:[],o=i&&t.end;return this._updateTileMesh(a,e,r,n,o,!!t.clear,s.signal)})))}catch(h){this._handleError(e,h,s)}}async _updateTileMesh(e,t,r,s,a,i,o){const l=e,c=r.message.tileKey,u=!!this._schema.mesh.sortKey;c!==t.key.id&&(a=!1);const d=r?.message,h={type:l,addOrUpdate:d,remove:s,clear:i,end:a,sort:u},f={transferList:r?.transferList??[],signal:o};return(0,n.Te)(f),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:c,data:h},f)}async _processFeatures(e,t,r,s,a){if(null==t||!t.hasFeatures)return null;const i={transform:e.transform,hasZ:!1,hasM:!1},o=this._factory,l={viewingMode:"",scale:e.scale},c=await this._matchers.feature,u=await this._matchers.aggregate;(0,n.Te)(s);const d=this._getLabelInfos(e,t);return await o.analyze(t.getCursor(),this._resourceManagerProxy,c,u,i,l),(0,n.Te)(s),this._writeFeatureSet(e,t,i,d,o,r,a)}_writeFeatureSet(e,t,r,s,a,i,n){const o=t.getSize(),l=this._schema.mesh.matcher.symbologyType,c=new h.U(e.key.id,{features:o,records:o,metrics:0},l,i,l!==d.w4.HEATMAP,n),u={viewingMode:"",scale:e.scale},f=t.getCursor();for(;f.next();)try{const t=f.getDisplayId(),i=null!=s?s.get(t):null;a.writeCursor(c,f,r,u,e.level,i,this._resourceManagerProxy)}catch(y){}const m=e.tileInfoView.tileInfo.isWrappable;return c.serialize(m)}_handleError(e,t,r){if(!(0,n.zf)(t)){const s={tileKey:e.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",s,{signal:r.signal})}return Promise.resolve()}_getLabelingSchemaForScale(e){const t=this._schema.mesh.labels;if(null==t)return null;if("subtype"===t.type){const r={type:"subtype",classes:{}};let s=!1;for(const a in t.classes){const i=t.classes[a].filter((t=>b(t,e.scale)));s=s||!!i.length,r.classes[a]=i}return s?r:null}const r=t.classes.filter((t=>b(t,e.scale)));return r.length?{type:"simple",classes:r}:null}_getLabels(e,t){if("subtype"===t.type){const r=this.service.subtypeField;(0,i.Lw)(r,"Expected to find subtype Field");const s=e.readAttribute(r);return null==s?[]:t.classes[s]??[]}return t.classes}_getLabelInfos(e,t){const r=this._getLabelingSchemaForScale(e);if(null==r)return null;const s=new Map,i=t.getCursor();for(;i.next();){const e=i.getDisplayId(),t=[],n=(0,u.h8)(e),o=n&&1!==i.readAttribute("cluster_count")?"aggregate":"feature",l=this._getLabels(i,r);for(const r of l){if(r.target!==o)continue;const s=i.getStorage(),l=n&&"feature"===o?s.getComputedStringAtIndex(i.readAttribute("referenceId"),r.fieldIndex):s.getComputedStringAtIndex(e,r.fieldIndex);if(!l)continue;const c=(0,a.y)(l.toString()),u=c[0],d=c[1];this._store.getMosaicItem(r.symbol,(0,p.N)(u)).then((e=>{t[r.index]={glyphs:e.glyphMosaicItems??[],rtl:d,index:r.index}}))}s.set(e,t)}return s}};v=(0,s._)([(0,o.$)("esri.views.2d.layers.features.processors.SymbolProcessor")],v);const w=v},7965:(e,t,r)=>{r.d(t,{L:()=>u,Z:()=>c});var s=r(80047),a=r(79432),i=r(59601);const n={marker:a.ZG.MARKER,fill:a.ZG.FILL,line:a.ZG.LINE,text:a.ZG.TEXT};class o{constructor(e,t,r,s){const o={minScale:t?.minScale,maxScale:t?.maxScale},l=function(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}(o);this.layers=e,this.data=t,this.hash=this._createHash()+l,this.rendererKey=r;const c={isOutline:!1,placement:null,symbologyType:a.w4.DEFAULT,vvFlags:r};for(const a of e){const e=n[a.type];c.isOutline="line"===a.type&&a.isOutline,a.materialKey=(0,i.Zl)(e,c),a.maxVVSize=s,a.scaleInfo=o,a.templateHash+=l}}get type(){return"expanded-cim"}_createHash(){let e="";for(const t of this.layers)e+=t.templateHash;return e}}const l=async(e,t,r)=>{const a=new s.U(r,t);return new o(await a.analyzeSymbolReference(e.data,!1),e.data,e.rendererKey,e.maxVVSize)};async function c(e,t,s,a){if(!e)return null;if("cim"===e.type)return l(e,t,s);if("web-style"===e.type){const{fetchCIMSymbolReference:i}=await Promise.all([r.e(2076),r.e(5204)]).then(r.bind(r,15204)),n={type:"cim",data:await i(e,null,a)??void 0,rendererKey:e.rendererKey,maxVVSize:e.maxVVSize};return l(n,t,s)}return e}function u(e){if(!e)return null;const{avoidSDFRasterization:t,type:r,cim:s,url:a,materialHash:i,maxVVSize:n}=e,o={cim:s,type:r,mosaicHash:i,url:a,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:t};switch(r){case"marker":n&&"size"in s&&(s.size=Math.max(n,s.size)),o.size=e.size,o.path=e.path,o.animatedSymbolProperties=e.animatedSymbolProperties;break;case"line":o.dashTemplate=e.dashTemplate;break;case"text":o.text=e.text,o.fontName=e.fontName}return o}}}]);