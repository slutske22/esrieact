"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[26174],{17504:(e,t,r)=>{r.d(t,{C:()=>v,b:()=>m});var i=r(1110),o=r(66012),n=r(33045),s=r(39739),a=r(23233),l=r(34328),c=r(89002),h=r(63592),d=r(1411),u=r(72196),g=r(50645),p=r(19274),f=r(96028);function m(e){const t=new f.N5,{vertex:r,fragment:m,attributes:v,varyings:y}=t,{vvColor:_,hasVertexColors:C}=e;return(0,h.NB)(r,e),t.include(o.d,e),t.include(s.c,e),t.include(l.A,e),t.include(n.g,e),m.include(i.HQ,e),t.include(p.z,e),t.include(a.Z,e),v.add(g.r.POSITION,"vec3"),_&&v.add(g.r.COLORFEATUREATTRIBUTE,"float"),C||y.add("vColor","vec4"),y.add("vpos","vec3",{invariant:!0}),r.uniforms.add(new d.E("uColor",(e=>e.color))),r.main.add(u.H`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${C?"vColor *= uColor;":_?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),m.include(c.a),m.main.add(u.H`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOID(vColor, vpos, vColor.rgb);`),t}const v=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},20072:(e,t,r)=>{r.d(t,{H:()=>p,b:()=>g});var i=r(4388),o=r(46653),n=r(96320),s=r(35449),a=r(72196),l=r(3445),c=r(79856),h=r(7568),d=r(61068),u=r(96028);function g(){const e=new u.N5;e.include(i.Q);const{fragment:t}=e;return t.uniforms.add(new c.N("blurInput",(e=>e.highlightBlurTexture)),new n.t("blurSize",(e=>e.blurSize)),new h.R("highlightTexture",(e=>e.highlightTexture)),new c.N("highlightOptionsTexture",(e=>e.highlightOptionsTexture)),new l.c("highlightLevel",(e=>e.highlightLevel)),new s.m("occludedIntensityFactor",(e=>e.occludedFactor))),t.constants.add("inner","float",1-(d.o-d.b)/d.o),e.include(o.y),t.main.add(a.H`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const p=Object.freeze(Object.defineProperty({__proto__:null,build:g},Symbol.toStringTag,{value:"Module"}))},63601:(e,t,r)=>{r.d(t,{H:()=>h,a:()=>u,b:()=>d});var i=r(59646),o=r(4388),n=r(96320),s=r(72196),a=r(52293),l=r(22005),c=r(96028);class h extends l.Y{constructor(){super(...arguments),this.blurSize=(0,i.vt)()}}function d(){const e=new c.N5;return e.include(o.Q),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new n.t("blurSize",(e=>e.blurSize)),new a.o("blurInput",(e=>e.blurInput))).main.add(s.H`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:h,build:d},Symbol.toStringTag,{value:"Module"}))},61068:(e,t,r)=>{r.d(t,{H:()=>l,a:()=>g,b:()=>u,c:()=>c,g:()=>h,o:()=>d});var i=r(16961),o=r(72196),n=r(7568),s=r(22005),a=r(96028);class l extends s.Y{}function c(){const e=new a.N5,{outputs:t,fragment:r}=e;return e.include(i.c),r.uniforms.add(new n.R("highlightTexture",(e=>e.highlightTexture))),r.constants.add("outlineWidth","int",Math.ceil(d)),r.constants.add("cellSize","int",h),t.add("fragGrid","uvec2"),r.main.add(o.H`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const h=32,d=9,u=.4,g=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:l,blurSize:u,build:c,gridCellPixelSize:h,outlineSize:d},Symbol.toStringTag,{value:"Module"}))},24633:(e,t,r)=>{r.d(t,{H:()=>h,b:()=>c});var i=r(4388),o=r(46653),n=r(72196),s=r(3445),a=r(7568),l=r(96028);function c(){const e=new l.N5;e.include(i.Q),e.include(o.y);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new a.R("highlightTexture",(e=>e.highlightTexture)),new s.c("highlightLevel",(e=>e.highlightLevel))),t.main.add(n.H`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},36004:(e,t,r)=>{r.d(t,{O:()=>d,a:()=>g,b:()=>u});var i=r(36572),o=r(16961),n=r(35449),s=r(72196),a=r(3445),l=r(79856),c=r(22005),h=r(96028);class d extends c.Y{constructor(){super(...arguments),this.overlayIndex=i.vr.INNER,this.opacity=1}}function u(){const e=new h.N5;return e.include(o.c),e.fragment.uniforms.add(new l.N("tex",(e=>e.texture))),e.fragment.uniforms.add(new a.c("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new n.m("opacity",(e=>e.opacity))),e.fragment.main.add(s.H`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const g=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:d,build:u},Symbol.toStringTag,{value:"Module"}))},52377:(e,t,r)=>{r.d(t,{T:()=>h,a:()=>u,b:()=>d});var i=r(58359),o=r(16961),n=r(60840),s=r(72196),a=r(79856),l=r(22005),c=r(96028);class h extends l.Y{constructor(){super(...arguments),this.color=(0,i.fA)(1,1,1)}}function d(){const e=new c.N5;return e.include(o.c),e.fragment.uniforms.add(new a.N("tex",(e=>e.texture)),new n.t("uColor",(e=>e.color))),e.fragment.main.add(s.H`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:h,build:d},Symbol.toStringTag,{value:"Module"}))},80912:(e,t,r)=>{r.d(t,{O:()=>i});class i{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get outerSize(){return this._outer.size}get(e,t){return this._outer.get(e)?.get(t)}getInner(e){return this._outer.get(e)}set(e,t,r){const i=this._outer.get(e);i?i.set(t,r):this._outer.set(e,new Map([[t,r]]))}delete(e,t){const r=this._outer.get(e);r&&(r.delete(t),0===r.size&&this._outer.delete(e))}forEach(e){this._outer.forEach(((t,r)=>e(t,r)))}forAll(e){this._outer.forEach(((t,r)=>t.forEach(((t,i)=>e(t,r,i)))))}}},69175:(e,t,r)=>{r.d(t,{$I:()=>v,AU:()=>p,Cr:()=>d,g7:()=>m,i4:()=>h,ui:()=>u,up:()=>_,vt:()=>c,yo:()=>f});var i=r(92504),o=r(21742),n=r(42927),s=r(38911),a=r(24121),l=r(58359);function c(e=_){return[e[0],e[1],e[2],e[3]]}function h(e,t,r=c()){return(0,a.c)(r,e),r[3]=t,r}function d(e,t,r){return(0,a.h)(r,e,t),(0,a.n)(r,r),r[3]=-(0,a.p)(e,t),r}function u(e,t=c()){const r=(0,o.l)(C,e);return y(t,(0,i.KJ)((0,n.Xd)(t,r))),t}function g(e,t,r=c()){return(0,n.x8)(C,e,v(e)),(0,n.x8)(w,t,v(t)),(0,n.lw)(C,w,C),y(r,(0,i.KJ)((0,n.Xd)(r,C)))}function p(e,t,r,i=c()){return h(l.Cw,e,x),h(l.JP,t,b),h(l.Cb,r,T),g(x,b,x),g(x,T,i),i}function f(e){return e}function m(e){return e[3]}function v(e){return(0,i.kU)(e[3])}function y(e,t){return e[3]=t,e}const _=[0,0,1,0],C=(0,s.vt)(),w=(0,s.vt)(),x=(c(),c()),b=c(),T=c()},52209:(e,t,r)=>{r.d(t,{b:()=>n});var i=r(92504),o=r(42965);function n(e,t,r){const n=Array.isArray(e),h=n?e.length/t:e.byteLength/(4*t),d=n?e:new Uint32Array(e,0,h*t),u=r?.minReduction??0,g=r?.originalIndices||null,p=g?g.length:0,f=r?.componentOffsets||null;let m=0;if(f)for(let i=0;i<f.length-1;i++){const e=f[i+1]-f[i];e>m&&(m=e)}else m=h;const v=Math.floor(1.1*m)+1;(null==c||c.length<2*v)&&(c=new Uint32Array((0,i.cU)(2*v)));for(let i=0;i<2*v;i++)c[i]=0;let y=0;const _=!!f&&!!g,C=_?p:h;let w=(0,o.my)(h);const x=new Uint32Array(p),b=1.96;let T=0!==u?Math.ceil(4*b*b/(u*u)*u*(1-u)):C,S=1,O=f?f[1]:C;for(let i=0;i<C;i++){if(i===T){const e=1-y/i;if(e+b*Math.sqrt(e*(1-e)/i)<u)return null;T*=2}if(i===O){for(let e=0;e<2*v;e++)c[e]=0;if(g)for(let e=f[S-1];e<f[S];e++)x[e]=w[g[e]];O=f[++S]}const e=_?g[i]:i,r=e*t,o=l(d,r,t);let n=o%v,a=y;for(;0!==c[2*n+1];){if(c[2*n]===o){const e=c[2*n+1]-1;if(s(d,r,e*t,t)){a=w[e];break}}n++,n>=v&&(n-=v)}a===y&&(c[2*n]=o,c[2*n+1]=e+1,y++),w[e]=a}if(0!==u&&1-y/h<u)return null;if(_){for(let e=f[S-1];e<x.length;e++)x[e]=w[g[e]];w=(0,o.uW)(x)}const M=n?new Array(y):new Uint32Array(y*t);y=0;for(let i=0;i<C;i++)w[i]===y&&(a(d,(_?g[i]:i)*t,M,y*t,t),y++);if(g&&!_){const e=new Uint32Array(p);for(let t=0;t<e.length;t++)e[t]=w[g[t]];w=(0,o.uW)(e)}return{buffer:Array.isArray(M)?M:M.buffer,indices:w,uniqueCount:y}}function s(e,t,r,i){for(let o=0;o<i;o++)if(e[t+o]!==e[r+o])return!1;return!0}function a(e,t,r,i,o){for(let n=0;n<o;n++)r[i+n]=e[t+n]}function l(e,t,r){let i=0;for(let o=0;o<r;o++)i=e[t+o]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let c=null},57829:(e,t,r)=>{r.d(t,{S:()=>l});var i=r(92504),o=r(92976),n=r(24121),s=r(58331),a=r(38774);function l(e,t,r){const l=function(e,t,r,i){const s=(e=>!Array.isArray(e[0]))(t)?(e,r)=>t[3*e+r]:(e,r)=>t[e][r],l=i?(0,o.GA)(i)/(0,o.G9)(i):1;return(0,a.lU)(e,((e,t)=>(0,n.i)(e,s(t,0)*l,s(t,1)*l,s(t,2))),r)}(c,e,t,r)?(0,a.Qj)(c):[0,0,1];return Math.abs(l[2])>Math.cos((0,i.kU)(80))?s._.Z:Math.abs(l[1])>Math.abs(l[0])?s._.Y:s._.X}const c=(0,a.vt)()},17566:(e,t,r)=>{r.d(t,{Wq:()=>i,lO:()=>d,oR:()=>u});var i,o=r(16528),n=r(58331),s=r(65319),a=r(90166),l=r(42965),c=r(57829),h=r(52209);function d(e){const t=u(e.rings,e.hasZ,i.CCW_IS_HOLE,e.spatialReference),r=new Array;let n=0,s=0;for(const i of t.polygons){const e=i.count,c=i.index,h=(0,a.l5)(t.position,3*c,3*e),d=i.holeIndices.map((e=>e-c)),u=(0,l.uW)((0,o.e)(h,d,3));r.push({position:h,faces:u}),n+=h.length,s+=u.length}const c=function(e,t,r){if(1===e.length)return e[0];const i=(0,a.jh)(t),o=new Array(r);let n=0,s=0,c=0;for(const a of e){for(let e=0;e<a.position.length;e++)i[n++]=a.position[e];for(const e of a.faces)o[s++]=e+c;c=n/3}return{position:i,faces:(0,l.uW)(o)}}(r,n,s),d=Array.isArray(c.position)?(0,h.b)(c.position,3,{originalIndices:c.faces}):(0,h.b)(c.position.buffer,6,{originalIndices:c.faces});return c.position=(0,a.xm)(new Float64Array(d.buffer)),c.faces=d.indices,c}function u(e,t,r,o){const n=e.length,s=new Array(n),l=new Array(n),c=new Array(n);let h=0;for(let i=0;i<n;++i)h+=e[i].length;let d=0,u=0,f=0;const m=(0,a.jh)(3*h);let v=0;for(let a=n-1;a>=0;a--){const h=e[a],y=r===i.CCW_IS_HOLE&&p(h,t,o);if(y&&1!==n)s[d++]=h;else{let e=h.length;for(let t=0;t<d;++t)e+=s[t].length;const r={index:v,pathLengths:new Array(d+1),count:e,holeIndices:new Array(d)};r.pathLengths[0]=h.length,h.length>0&&(c[f++]={index:v,count:h.length}),v=y?g(h,h.length-1,-1,m,v,h.length,t):g(h,0,1,m,v,h.length,t);for(let i=0;i<d;++i){const e=s[i];r.holeIndices[i]=v,r.pathLengths[i+1]=e.length,e.length>0&&(c[f++]={index:v,count:e.length}),v=g(e,0,1,m,v,e.length,t)}d=0,r.count>0&&(l[u++]=r)}}for(let i=0;i<d;++i){const e=s[i];e.length>0&&(c[f++]={index:v,count:e.length}),v=g(e,0,1,m,v,e.length,t)}return l.length=u,c.length=f,{position:m,polygons:l,outlines:c}}function g(e,t,r,i,o,n,s){o*=3;for(let a=0;a<n;++a){const n=e[t];i[o++]=n[0],i[o++]=n[1],i[o++]=s&&n[2]?n[2]:0,t+=r}return o/3}function p(e,t,r){if(!t)return!(0,s.$3)(e);const i=e.length-1;switch((0,c.S)(e,i,r)){case n._.X:return!(0,s.$3)(e,n._.Y,n._.Z);case n._.Y:return!(0,s.$3)(e,n._.X,n._.Z);case n._.Z:return!(0,s.$3)(e,n._.X,n._.Y)}}!function(e){e[e.NONE=0]="NONE",e[e.CCW_IS_HOLE=1]="CCW_IS_HOLE"}(i||(i={}))},12155:(e,t,r)=>{var i;r.d(t,{$:()=>i}),function(e){e[e.EnableFastUpdates=0]="EnableFastUpdates",e[e.DisableFastUpdates=1]="DisableFastUpdates",e[e.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"}(i||(i={}))},77573:(e,t,r)=>{r.d(t,{Fe:()=>g,KU:()=>v,Km:()=>n,Nk:()=>l});var i=r(96220),o=r(50072);function n(e,t,r,i){if(e)if("CIMTextSymbol"!==e.type){if(r&&e.effects)for(const r of e.effects)a(r,t);if(e.symbolLayers)for(const r of e.symbolLayers){switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":s(r,t,i);break;case"CIMPictureStroke":case"CIMSolidStroke":case"CIMGradientStroke":!i?.preserveOutlineWidth&&r.width&&(r.width*=t);break;case"CIMPictureFill":r.height&&(r.height*=t),r.offsetX&&(r.offsetX*=t),r.offsetY&&(r.offsetY*=t);break;case"CIMHatchFill":n(r.lineSymbol,t,!0,{...i,preserveOutlineWidth:!1}),r.offsetX&&(r.offsetX*=t),r.offsetY&&(r.offsetY*=t),r.separation&&(r.separation*=t)}if(r.effects)for(const e of r.effects)a(e,t)}}else null!=e.height&&(e.height*=t)}function s(e,t,r){if(e&&(e.markerPlacement&&function(e,t){switch((0,o.zr)(e)&&e.offset&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.placementTemplate&&e.placementTemplate.length){const r=e.placementTemplate.map((e=>e*t));e.placementTemplate=r}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset&&(e.maxRandomOffset*=t),e.placementTemplate&&e.placementTemplate.length){const r=e.placementTemplate.map((e=>e*t));e.placementTemplate=r}break;case"CIMMarkerPlacementOnLine":e.startPointOffset&&(e.startPointOffset*=t);break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine&&(e.offsetAlongLine*=t);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition&&(e.beginPosition*=t),e.endPosition&&(e.endPosition*=t);break;case"CIMMarkerPlacementPolygonCenter":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMMarkerPlacementInsidePolygon":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.stepX&&(e.stepX*=t),e.stepY&&(e.stepY*=t)}}(e.markerPlacement,t),e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.anchorPoint&&"Absolute"===e.anchorPointUnits&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size=null!=e.size?e.size*t:0,"CIMVectorMarker"===e.type&&e.markerGraphics))for(const i of e.markerGraphics)e.scaleSymbolsProportionally||n(i.symbol,t,!0,r)}function a(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width&&(e.width*=t);break;case"CIMGeometricEffectBuffer":e.size&&(e.size*=t);break;case"CIMGeometricEffectCut":e.beginCut&&(e.beginCut*=t),e.endCut&&(e.endCut*=t),e.middleCut&&(e.middleCut*=t);break;case"CIMGeometricEffectDashes":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.dashTemplate&&e.dashTemplate.length){const r=e.dashTemplate.map((e=>e*t));e.dashTemplate=r}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length&&(e.length*=t);break;case"CIMGeometricEffectMove":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset&&(e.offset*=t);break;case"CIMGeometricEffectRegularPolygon":e.radius&&(e.radius*=t);break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth&&(e.fromWidth*=t),e.length&&(e.length*=t),e.toWidth&&(e.toWidth*=t);break;case"CIMGeometricEffectWave":e.amplitude&&(e.amplitude*=t),e.period&&(e.period*=t)}}function l(e){const t=[];return c((0,o.lW)(e),t),t.length?new i.A((0,o.e6)(t[0])):null}function c(e,t){if(!e)return;let r;r="CIMTextSymbol"===e.type?e.symbol:e;const i="CIMPolygonSymbol"===e.type;if(r?.symbolLayers)for(const n of r.symbolLayers)if(!(n.colorLocked||i&&((0,o.mA)(n)||(0,o.MM)(n)&&n.markerPlacement&&(0,o.zr)(n.markerPlacement))))switch(n.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":n.tintColor&&h(t,n.tintColor);break;case"CIMVectorMarker":n.markerGraphics?.forEach((e=>{c(e.symbol,t)}));break;case"CIMSolidStroke":case"CIMSolidFill":h(t,n.color);break;case"CIMGradientFill":d(t,n);break;case"CIMHatchFill":c(n.lineSymbol,t)}}function h(e,t){for(const r of e)if(r.join(".")===t.join("."))return;e.push(t)}function d(e,t){const r=t.colorRamp?.type;switch(r){case"CIMMultipartColorRamp":t.colorRamp.colorRamps?.forEach((t=>{"CIMLinearContinuousColorRamp"===t.type&&u(e,t)}));break;case"CIMLinearContinuousColorRamp":case"CIMPolarContinuousColorRamp":u(e,t.colorRamp)}}function u(e,t){t&&(t.fromColor&&h(e,t.fromColor),t.toColor&&h(e,t.toColor))}function g(e,t,r){t instanceof i.A||(t=new i.A(t));const n=(0,o.lW)(e);n&&p(n,t,r)}function p(e,t,r){if(!e)return;let i;i="CIMTextSymbol"===e.type?e.symbol:e;const n="CIMPolygonSymbol"===i?.type;if(i?.symbolLayers)for(const s of i.symbolLayers){if(s.colorLocked)continue;if(n)if(r){const{layersToColor:e}=r;if(((0,o.mA)(s)||(0,o.MM)(s)&&s.markerPlacement&&(0,o.zr)(s.markerPlacement))&&"fill"===e||(0,o.jn)(s)&&"outline"===e)continue}else if((0,o.mA)(s)||(0,o.MM)(s)&&s.markerPlacement&&(0,o.zr)(s.markerPlacement))continue;const e=t.toArray();switch(s.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":s.tintColor=e;break;case"CIMVectorMarker":s.markerGraphics?.forEach((e=>{p(e.symbol,t,r)}));break;case"CIMSolidStroke":case"CIMSolidFill":s.color=e;break;case"CIMGradientFill":f(s,t);break;case"CIMHatchFill":p(s.lineSymbol,t,r)}}}function f(e,t){const r=e.colorRamp?.type;switch(r){case"CIMMultipartColorRamp":e.colorRamp.colorRamps?.forEach((e=>{"CIMLinearContinuousColorRamp"===e.type&&m(e,t)}));break;case"CIMLinearContinuousColorRamp":case"CIMPolarContinuousColorRamp":m(e.colorRamp,t)}}function m(e,t){if(e&&(e.fromColor&&(e.fromColor=t.toArray()),e.toColor)){const r=t.clone();r.a=0,e.toColor=r.toArray()}}function v(e,t,r=!1){const i=(0,o.lW)(e);if(r&&(t=360-t),"CIMTextSymbol"!==i?.type){if("CIMPointSymbol"===i?.type&&i.symbolLayers){const e=t-(i.angle||0);for(const t of i.symbolLayers)if((0,o.MM)(t)){let r=t.rotation||0;t.rotateClockwise?r-=e:r+=e,t.rotation=r}i.angle=t}}else i.angle=t}},41977:(e,t,r)=>{r.d(t,{$4:()=>_,O0:()=>C,O1:()=>w,Sw:()=>x,eH:()=>v,rc:()=>y});var i=r(99050),o=r(96220),n=r(86394),s=r(89926),a=r(89882),l=r(77573);const c="picture-fill",h="simple-fill",d="simple-line",u="simple-marker",g="text",p="cim",f=new Map([["dash",[4,3]],["dashdot",[4,3,1,3]],["dot",[1,3]],["longdash",[8,3]],["longdashdot",[8,3,1,3]],["longdashdotdot",[8,3,1,3,1,3]],["shortdash",[4,1]],["shortdashdot",[4,1,1,1]],["shortdashdotdot",[4,1,1,1,1,1]],["shortdot",[1,1]],["solid",[]]]),m=new s.q(1e3);function v(e){const t=e.style;let r=null;if(e)switch(e.type){case u:"cross"!==t&&"x"!==t&&(r=e.color);break;case h:t&&"solid"!==t?"none"!==t&&(r={type:"pattern",x:0,y:0,src:(0,i.s)(`esri/symbols/patterns/${t}.png`),width:5,height:5}):r=e.color;break;case c:r={type:"pattern",src:e.url,width:(0,a.Lz)(e.width)*e.xscale,height:(0,a.Lz)(e.height)*e.yscale,x:(0,a.Lz)(e.xoffset),y:(0,a.Lz)(e.yoffset)};break;case g:r=e.color;break;case p:r=(0,l.Nk)(e)}return r}function y(e,t){const r=e+"-"+t;return void 0!==m.get(r)?Promise.resolve(m.get(r)):(0,n.A)(e,{responseType:"image"}).then((e=>{const i=e.data,o=i.naturalWidth,n=i.naturalHeight,s=document.createElement("canvas");s.width=o,s.height=n;const a=s.getContext("2d");a.fillStyle=t,a.fillRect(0,0,o,n),a.globalCompositeOperation="destination-in",a.drawImage(i,0,0);const l=s.toDataURL();return m.put(r,l),l}))}function _(e){if(!e)return null;let t=null;switch(e.type){case h:case c:case u:t=_(e.outline);break;case d:{const r=(0,a.Lz)(e.width);null!=e.style&&"none"!==e.style&&0!==r&&(t={color:e.color,style:w(e.style),width:r,cap:e.cap,join:"miter"===e.join?(0,a.Lz)(e.miterLimit):e.join},t.dashArray=C(t).join(",")||"none");break}default:t=null}return t}function C(e){if(!e?.style)return[];const{dashArray:t,style:r,width:i}=e;if("string"==typeof t&&"none"!==t)return t.split(",").map((e=>Number(e)));const o=i??0,n=f.has(r)?f.get(r).map((e=>e*o)):[];if("butt"!==e.cap)for(const[s,a]of n.entries())n[s]=s%2==1?a+o:Math.max(a-o,1);return n}const w=(()=>{const e={};return t=>{if(e[t])return e[t];const r=t.replaceAll("-","");return e[t]=r,r}})(),x=new o.A([128,128,128])},55056:(e,t,r)=>{r.d(t,{$d:()=>p,GG:()=>T,N7:()=>f,Sx:()=>m,UQ:()=>b,di:()=>S,dt:()=>y,f3:()=>O,k_:()=>g});var i=r(96220),o=r(12690),n=(r(39831),r(89882)),s=r(58359),a=r(27664),l=r(77573),c=r(41977),h=r(5159),d=r(66961);const u=new i.A("white");function g(e){if(!e)return 0;if((0,d.wk)(e)){const t=function(e){const t=e.symbolLayers?.at(-1);if(t&&"outline"in t)return t?.outline?.size}(e);return null!=t?t:0}return(0,n.PN)((0,c.$4)(e)?.width)}function p(e){if(null==e||!("symbolLayers"in e)||null==e.symbolLayers)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function f(e){return e.resource?.href??""}function m(e,t){if(!e)return null;let r=null;return(0,d.wk)(e)?r=function(e){const t=e.symbolLayers;if(!t)return null;let r=null;return t.forEach((e=>{"object"===e.type&&e.resource?.href||(r="water"===e.type?e.color:e.material?e.material.color:null)})),r?new i.A(r):null}(e):(0,d.$y)(e)&&(r="cim"===e.type?(0,l.Nk)(e):e.color?new i.A(e.color):null),r?v(r,t):null}function v(e,t){if(null==t||null==e)return e;const r=e.toRgba();return r[3]=r[3]*t,new i.A(r)}function y(e,t,r){e&&(t||null!=r)&&(t&&(t=new i.A(t)),(0,d.wk)(e)?function(e,t,r){const i=e.symbolLayers;if(!i)return;const o=e=>v(t??e??(null!=r?u:null),r);i.forEach((e=>{if("object"!==e.type||!e.resource?.href||t)if("water"===e.type)e.color=o(e.color);else{const t=null!=e.material?e.material.color:null,i=o(t);if(null==e.material?e.material=new h.N({color:i}):e.material.color=i,null!=r&&"outline"in e&&null!=e.outline?.color&&(e.outline.color=v(e.outline.color,r)),"marker"in e&&null!=e.marker){const t=o(e.marker.color);e.marker.color=t}}}))}(e,t,r):(0,d.$y)(e)&&function(e,t,r){(t=t??e.color)&&(e.color=v(t,r)),null!=r&&"outline"in e&&e.outline?.color&&(e.outline.color=v(e.outline.color,r))}(e,t,r))}async function _(e,t){const i=e.symbolLayers;i&&await(0,o.jJ)(i,(async e=>async function(e,t){switch(e.type){case"extrude":!function(e,t){const r=t[2];"number"==typeof r&&(e.size=r)}(e,t);break;case"icon":case"line":case"text":!function(e,t){const r=C(t);null!=r&&(e.size=r)}(e,t);break;case"path":!function(e,t){const r=w(t,s.Un,[e.width,void 0,e.height]);null!=r&&(e.width=x(t[0],e.width,1,r),e.height=x(t[2],e.height,1,r))}(e,t);break;case"object":await async function(e,t){const{resourceSize:i,symbolSize:o}=await async function(e){const{computeObjectLayerResourceSize:t}=await r.e(63867).then(r.bind(r,63867)),i=await t(e,10),{width:o,height:n,depth:s}=e,a=[o,s,n];let l=1;for(let r=0;r<3;r++){const e=a[r];if(null!=e){l=e/i[r];break}}for(let r=0;r<3;r++)null==a[r]&&(a[r]=i[r]*l);return{resourceSize:i,symbolSize:a}}(e),n=w(t,i,o);null!=n&&(e.width=x(t[0],o[0],i[0],n),e.depth=x(t[1],o[1],i[1],n),e.height=x(t[2],o[2],i[2],n))}(e,t)}}(e,t)))}function C(e){for(const t of e)if("number"==typeof t)return t;return null}function w(e,t,r){for(let i=0;i<3;i++){const o=e[i];switch(o){case"symbol-value":{const e=r[i];return null!=e?e/t[i]:1}case"proportional":break;default:if(o&&t[i])return o/t[i]}}return null}function x(e,t,r,i){switch(e){case"proportional":return r*i;case"symbol-value":return null!=t?t:r;default:return e}}async function b(e,t){if(e&&t)return(0,d.wk)(e)?_(e,t):void((0,d.$y)(e)&&function(e,t){const r=C(t);if(null!=r)switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}(e,t))}function T(e,t,r){if(e&&null!=t)if((0,d.wk)(e)){const i=e.symbolLayers;i&&i.forEach((e=>{if("object"===e.type)switch(r){case"tilt":e.tilt=(e.tilt??0)+t;break;case"roll":e.roll=(e.roll??0)+t;break;default:e.heading=(e.heading??0)+t}"icon"===e.type&&(e.angle+=t)}))}else(0,d.$y)(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle+=t))}function S(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return(0,a.zu)(t)}function O(e){return null!=e&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))}},5842:(e,t,r)=>{var i,o;function n(e){return null!=e&&!e.running}r.d(t,{c:()=>o,pi:()=>n,tf:()=>i}),function(e){e[e.Idle=0]="Idle",e[e.Rendering=1]="Rendering",e[e.Ready=2]="Ready",e[e.Fading=3]="Fading"}(i||(i={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA",e[e.COUNT=2]="COUNT"}(o||(o={}))},58718:(e,t,r)=>{r.d(t,{c:()=>i,n:()=>f});var i,o=r(73345),n=r(92504),s=r(40315),a=r(21742),l=r(86128),c=r(24121),h=r(58359),d=r(69175),u=r(99817),g=r(5842),p=r(84323);class f{constructor(){this.startTime=0,this._data=(0,s.v)(null),this.coverage=0,this.absorption=0,this._readChannels=g.c.RG,this.parallax=new m,this.parallaxNew=new m,this._anchorPoint=(0,h.vt)(),this._fadeState=(0,s.v)(i.HIDE),this._fadeFactor=(0,s.v)(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case i.HIDE:return 0;case i.FADE_OUT:return 1-this.fadeFactor;case i.FADE_IN:return this.fadeFactor;case i.SHOW:case i.CROSS_FADE:return 1}}fade(e,t,r){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=r?(0,n.qE)((t-this.startTime)/(C*r),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const r=e.relativeElevation,o=this._updateAnchorPoint(e);(r>1.7*p.zF||r<-1e4||o>x)&&this.opacity>0?this._startFade(i.HIDE,t):this.isFading||(r>p.zF||r<-.35*p.zF||o>w*x?this.opacity>0&&this._startFade(i.FADE_OUT,t):(0,g.pi)(this.data)&&(0===this.opacity?this._startFade(i.FADE_IN,t):this.data.state===g.tf.Ready&&(this.fadeState===i.SHOW?this._startFade(i.CROSS_FADE,t):this._startFade(i.SHOW,t))))}_updateParallax(e){const t=(0,c.k)(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-u.$O.radius*u.$O.radius,0))/Math.sqrt(t),(0,d.Cr)(v,this.parallax.anchorPoint,y),(0,a.e$)(this.parallax.transform,l.zK,y[3],(0,d.yo)(y)),(0,d.Cr)(v,this.parallaxNew.anchorPoint,y),(0,a.e$)(this.parallaxNew.transform,l.zK,y[3],(0,d.yo)(y))}_updateAnchorPoint(e){return(0,c.n)(this._anchorPoint,e.eye),(0,c.g)(this._anchorPoint,this._anchorPoint,u.$O.radius),this.fadeState===i.HIDE&&this.data?.state===g.tf.Ready?((0,c.c)(this.parallax.anchorPoint,this._anchorPoint),0):(0,c.l)((0,c.d)(_,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case i.CROSS_FADE:this.requestFade(),this._switchReadChannels(),(0,c.c)(this.parallaxNew.anchorPoint,this._anchorPoint);break;case i.FADE_IN:this.requestFade(),this._switchReadChannels(),(0,c.c)(this.parallax.anchorPoint,this._anchorPoint),(0,c.c)(this.parallaxNew.anchorPoint,this._anchorPoint);break;case i.FADE_OUT:this.requestFade();break;case i.SHOW:this._switchReadChannels(),(0,c.c)(this.parallax.anchorPoint,this._anchorPoint),(0,c.c)(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case i.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==g.tf.Ready&&(this.data.state=g.tf.Idle),this.fadeState){case i.CROSS_FADE:(0,c.c)(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=i.SHOW;break;case i.FADE_IN:this._fadeState.value=i.SHOW;break;case i.FADE_OUT:this._fadeState.value=i.HIDE;break;case i.SHOW:case i.HIDE:break;default:(0,o.Xb)(this.fadeState)}}_switchReadChannels(){this.data?.state===g.tf.Ready&&(this._readChannels=1-this._readChannels,this.data.state=g.tf.Fading)}get isFading(){return this.fadeState===i.FADE_OUT||this.fadeState===i.FADE_IN||this.fadeState===i.CROSS_FADE}}!function(e){e[e.HIDE=0]="HIDE",e[e.FADE_IN=1]="FADE_IN",e[e.SHOW=2]="SHOW",e[e.CROSS_FADE=3]="CROSS_FADE",e[e.FADE_OUT=4]="FADE_OUT"}(i||(i={}));class m{constructor(){this.anchorPoint=(0,h.vt)(),this.radiusCurvatureCorrection=0,this.transform=(0,l.vt)()}}const v=(0,h.fA)(0,0,1),y=(0,d.vt)(),_=(0,h.vt)(),C=1.25,w=.5,x=2e5},84323:(e,t,r)=>{r.d(t,{k9:()=>T,zF:()=>b});var i,o=r(66866),n=r(21877),s=r(21564),a=(r(39831),r(539),r(9272),r(28902)),l=r(63863);let c=i=class extends n.A{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new i({cloudCover:this.cloudCover})}};(0,o._)([(0,a.e)({cloudy:"cloudy"}),(0,s.MZ)({json:{write:{isRequired:!0}}})],c.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=i=(0,o._)([(0,l.$)("esri.views.3d.environment.CloudyWeather")],c);const h=c;var d;let u=d=class extends n.A{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new d({fogStrength:this.fogStrength})}};(0,o._)([(0,a.e)({foggy:"foggy"}),(0,s.MZ)({json:{write:{isRequired:!0}}})],u.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],u.prototype,"fogStrength",void 0),u=d=(0,o._)([(0,l.$)("esri.views.3d.environment.FoggyWeather")],u);const g=u;var p;let f=p=class extends n.A{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new p({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,o._)([(0,a.e)({rainy:"rainy"}),(0,s.MZ)({json:{write:{isRequired:!0}}})],f.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],f.prototype,"cloudCover",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],f.prototype,"precipitation",void 0),f=p=(0,o._)([(0,l.$)("esri.views.3d.environment.RainyWeather")],f);const m=f;var v;let y=v=class extends n.A{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new v({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,o._)([(0,a.e)({snowy:"snowy"}),(0,s.MZ)({json:{write:{isRequired:!0}}})],y.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],y.prototype,"cloudCover",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],y.prototype,"precipitation",void 0),(0,o._)([(0,s.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],y.prototype,"snowCover",void 0),y=v=(0,o._)([(0,l.$)("esri.views.3d.environment.SnowyWeather")],y);const _=y;var C;let w=C=class extends n.A{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new C({cloudCover:this.cloudCover})}};(0,o._)([(0,a.e)({sunny:"sunny"}),(0,s.MZ)({json:{write:{isRequired:!0}}})],w.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],w.prototype,"cloudCover",void 0),w=C=(0,o._)([(0,l.$)("esri.views.3d.environment.SunnyWeather")],w);const x={key:"type",base:w,typeMap:{sunny:w,cloudy:h,rainy:m,snowy:_,foggy:g}};Object.keys(x.typeMap);const b=1e4,T=1e5},15788:(e,t,r)=>{r.d(t,{U:()=>n});var i=r(41746),o=r(69955);function n(e,t=0){const r=e.stride;return Array.from(e.fields.keys()).map((i=>{const n=e.fields.get(i),a=n.constructor.ElementCount,l=s(n.constructor.ElementType),c=n.offset,h=n.optional?.glNormalized??!1;return new o._(i,a,l,c,r,h,t)}))}function s(e){const t=a[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const a={u8:i.pe.UNSIGNED_BYTE,u16:i.pe.UNSIGNED_SHORT,u32:i.pe.UNSIGNED_INT,i8:i.pe.BYTE,i16:i.pe.SHORT,i32:i.pe.INT,f16:i.pe.HALF_FLOAT,f32:i.pe.FLOAT}},46684:(e,t,r)=>{r.d(t,{t:()=>m,z:()=>_});var i=r(60704),o=r(59646),n=r(28152),s=r(47936),a=r(12943),l=r(90166),c=r(50961),h=r(42965),d=r(10714),u=r(70807),g=r(59816),p=r(50645),f=r(27514);function m(e,t,r=null){const o=[],m=t.mapPositions;!function(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:i}=e,o=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&i,n=r.length/3-(o?1:0),s=new Array(2*(n-1)),a=o?r.slice(0,-3):r;let l=0;for(let c=0;c<n-1;c++)s[l++]=c,s[l++]=c+1;t.push([p.r.POSITION,new u.n(a,s,3,o)])}(t,o);const _=o[0][1].data,C=o[0][1].indices.length,w=(0,h.EH)(C);return function(e,t,r){if(null!=e.attributeData.colorFeature)return;const i=e.attributeData.color;t.push([p.r.COLOR,new u.n(i??n.Un,r,4)])}(t,o,w),function(e,t,r){null==e.attributeData.sizeFeature&&t.push([p.r.SIZE,new u.n([e.attributeData.size??1],r,1,!0)])}(t,o,w),function(e,t,r){e.attributeData.normal&&t.push([p.r.NORMAL,new u.n(e.attributeData.normal,r,3)])}(t,o,w),function(e,t,r){null!=e.attributeData.colorFeature&&t.push([p.r.COLORFEATUREATTRIBUTE,new u.n([e.attributeData.colorFeature],r,1,!0)])}(t,o,w),function(e,t,r){null!=e.attributeData.sizeFeature&&t.push([p.r.SIZEFEATUREATTRIBUTE,new u.n([e.attributeData.sizeFeature],r,1,!0)])}(t,o,w),function(e,t,r){null!=e.attributeData.opacityFeature&&t.push([p.r.OPACITYFEATUREATTRIBUTE,new u.n([e.attributeData.opacityFeature],r,1,!0)])}(t,o,w),function(e,t,r){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==d.RT.Global||!e.overlayInfo.spatialReference.isGeographic)return;const o=(0,l.jh)(r.length),n=(0,s.tO)(e.overlayInfo.spatialReference);for(let i=0;i<o.length;i+=3)(0,a.RC)(r,i,o,i,n);const h=r.length/3,g=(0,c.oe)(h+1);let f=v,m=y,_=0,C=0;(0,i.hZ)(f,o[C++],o[C++]),C++,g[0]=0;for(let s=1;s<h+1;++s)s===h&&(C=0),(0,i.hZ)(m,o[C++],o[C++]),C++,_+=(0,i.xg)(f,m),g[s]=_,[f,m]=[m,f];t.push([p.r.DISTANCETOSTART,new u.n(g,t[0][1].indices,1,!0)])}(t,o,_),new g.V(e,o,m,f.d.Line,r)}const v=(0,o.vt)(),y=(0,o.vt)();function _(e,t){if(null==e||0===e.length)return[];const r=[];return e.forEach((e=>{const i=e.length,o=(0,l.jh)(3*i);e.forEach(((e,t)=>{o[3*t]=e[0],o[3*t+1]=e[1],o[3*t+2]=e[2]}));const n={attributeData:{position:o,normal:t},removeDuplicateStartEnd:!1};r.push(n)})),r}},4062:(e,t,r)=>{r.d(t,{A:()=>c,C:()=>l});var i=r(84119),o=r(90166),n=r(17566),s=r(27716),a=r(42490);function l(e,t,r,i){const a="polygon"===e.type?n.Wq.CCW_IS_HOLE:n.Wq.NONE,l="polygon"===e.type?e.rings:e.paths,{position:c,outlines:d}=(0,n.oR)(l,!!e.hasZ,a,e.spatialReference),u=(0,o.jh)(c.length),g=(0,s.au)(c,e.spatialReference,0,u,0,c,0,c.length/3,t,r,i),p=null!=g;return{lines:p?h(d,c,u):[],projectionSuccess:p,sampledElevation:g}}function c(e,t){const r="polygon"===e.type?n.Wq.CCW_IS_HOLE:n.Wq.NONE,o="polygon"===e.type?e.rings:e.paths,{position:s,outlines:l}=(0,n.oR)(o,!1,r),c=(0,i.projectBuffer)(s,e.spatialReference,0,s,t,0);for(let i=2;i<s.length;i+=3)s[i]=a.bi;return{lines:c?h(l,s):[],projectionSuccess:c}}function h(e,t,r=null){const i=new Array;for(const{index:n,count:s}of e){if(s<=1)continue;const e=3*n,a=3*s;i.push({position:(0,o.l5)(t,3*n,3*s),mapPositions:null!=r?(0,o.l5)(r,e,a):void 0})}return i}},42490:(e,t,r)=>{r.d(t,{bi:()=>Pt});var i,o=r(66866),n=r(17306),s=r(39831),a=r(82256),l=r(6267),c=r(63678),h=r(85251),d=r(76286),u=r(21564),g=r(539),p=(r(9272),r(63863)),f=r(21742),m=r(24121),v=r(58359),y=r(56867),_=r(19620),C=r(36572),w=r(80510),x=r(10545);class b{constructor(){this._extent=(0,w.vt)(),this.resolution=0,this.renderLocalOrigin=(0,x.f)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new T}get extent(){return this._extent}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,w.cY)(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,w.cY)(this._extent,-e.range,0,t)}}_setupGeometryView(){this.canvasGeometries.numViews=1,(0,w.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class T{constructor(){this.extents=[(0,w.vt)(),(0,w.vt)(),(0,w.vt)()],this.numViews=0}}!function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(i||(i={}));class S{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){return null!=this._handle?.getTexture()}dispose(){this._handle=(0,l.Gz)(this._handle)}get texture(){return this._handle?.getTexture()}bind(e,t,r){this._handle&&this._handle.fbo?.width===t&&this._handle.fbo?.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(t,r,this._name,this._format)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}}var O=r(79320),M=r(55274),R=r(36340);class I{constructor(e,t,r,i,o=O.NV.RGBA8UNORM_MIPMAP){this.output=r,this.content=i,this.fbo=new S(e,o,t)}get valid(){return this.fbo.valid}}class P{constructor(e){this.targets=[new I(e,"overlay color",M.V.Color,i.Color),new I(e,"overlay IM color",M.V.Color,i.ColorNoRasterImage),new I(e,"overlay highlight",M.V.Highlight,i.Highlight,O.NV.RG8UINT),new I(e,"overlay water",M.V.Normal,i.WaterNormal),new I(e,"overlay occluded",M.V.Color,i.Occluded)],(0,R.E)()&&this.targets.push(new I(e,"overlay olid",M.V.ObjectAndLayerIdColor,i.ObjectAndLayerIdColor,O.NV.RGBA8UNORM))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,r)=>t.valid?e|=1<<r:e),0)}}var D,A=r(99369),E=r(28152);!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight",e[e.ViewshedShadowMap=3]="ViewshedShadowMap"}(D||(D={}));r(696),r(39486),r(548),r(84674),r(35449),r(72196),r(79856),r(7568);var F,N=r(99120);!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(F||(F={}));(0,E.vt)();N.n;var L=r(52377),H=r(38931),z=r(60704),k=r(11041),V=r(43196),W=r(47705),j=r(28347),U=r(20072),G=r(2449);class q extends j.w{constructor(e,t){super(e,t,new W.$(U.H,(()=>r.e(25636).then(r.bind(r,25636)))))}initializePipeline(){return(0,G.Ey)({blending:G.T8,colorWrite:G.kn})}}var B=r(63601);class Z extends j.w{constructor(e,t){super(e,t,new W.$(B.a,(()=>r.e(28765).then(r.bind(r,28765)))))}initializePipeline(){return(0,G.Ey)({colorWrite:G.kn})}}var $=r(61068);class Y extends j.w{constructor(e,t){super(e,t,new W.$($.a,(()=>r.e(74688).then(r.bind(r,74688)))))}initializePipeline(){return(0,G.Ey)({colorWrite:G.kn})}}var Q=r(29736),X=r(22005);class K extends X.Y{constructor(){super(...arguments),this.occludedFactor=Q.cD,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}var J=r(24633);class ee extends j.w{constructor(e,t){super(e,t,new W.$(J.H,(()=>r.e(4037).then(r.bind(r,4037)))))}initializePipeline(){return(0,G.Ey)({colorWrite:G.kn})}}var te=r(91013),re=r(13148),ie=r(50645),oe=r(41746),ne=r(69955);const se=[];new ne._(ie.r.POSITION,3,oe.pe.FLOAT,0,12),new ne._(ie.r.POSITION,2,oe.pe.FLOAT,0,8),new ne._(ie.r.POSITION,2,oe.pe.FLOAT,0,12),new ne._(ie.r.UV0,2,oe.pe.HALF_FLOAT,8,12),new ne._(ie.r.POSITION,2,oe.pe.FLOAT,0,16),new ne._(ie.r.UV0,2,oe.pe.FLOAT,8,16);var ae=r(11459),le=r(89423),ce=r(8595),he=r(45758);let de=class extends V.A{constructor(){super(...arguments),this.produces=k.OG.HIGHLIGHTS,this.consumes={required:[k.OG.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new $.H,this._passParameters=new K,this._highlightBlurDrawParameters=new B.H,this._grid=new ue}initialize(){this.addHandles([(0,h.wB)((()=>this._updateOptionsTexture()),(()=>{}),h.Vh)])}destroy(){this._grid.coverage=(0,l.Gz)(this._grid.coverage),this._grid.vao=(0,l.WD)(this._grid.vao),this._passParameters.highlightOptionsTexture=(0,l.Gz)(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new he.R(16,2);e.internalFormat=oe.Ab.RGBA,e.samplingMode=oe.Cj.NEAREST,this._passParameters.highlightOptionsTexture=new ce.g(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let r=0;for(const i of e){const e=4*r,o=4*r+64;++r;const{color:n}=i,s=i.haloColor??n;t[e+0]=n.r,t[e+1]=n.g,t[e+2]=n.b,t[e+3]=i.fillOpacity*n.a*255,t[o+0]=s.r,t[o+1]=s.g,t[o+2]=s.b,t[o+3]=i.haloOpacity*s.a*255}return t}(this.view.state.highlights)),this.requestRender(te.C7.UPDATE)}precompile(){this.techniques.precompile(Y),this.techniques.precompile(ee),this.techniques.precompile(Z),this.techniques.precompile(q)}render(e){const t=e.find((({name:e})=>e===k.OG.HIGHLIGHTS)),{techniques:r,bindParameters:i,_passParameters:o,renderingContext:n}=this;if(!i.decorations)return t;const s=r.get(Y);if(!s.compiled)return this.requestRender(te.C7.UPDATE),t;const a=e.find((({name:e})=>"highlights"===e)).getTexture();o.highlightTexture=a;const{camera:l}=i;return this._renderHighlightPostprocess(a,(()=>{this._gridUpdateResources(a);const e=this._gridComputeCoverage(s,a,i),{horizontalCellCount:t,verticalCellCount:r}=e;return o.horizontalCellCount=t,o.verticalCellCount=r,o.coverageTexture=e.coverage?.getTexture(),e}),(e=>{const t=e.verticalCellCount*e.horizontalCellCount;n.bindVAO(e.vao),n.drawElementsInstanced(oe.WR.TRIANGLES,6,oe.pe.UNSIGNED_BYTE,0,t)}),(()=>{n.bindFramebuffer(t.fbo),n.setViewport4fv(l.fullViewport)})),o.highlightTexture=null,o.coverageTexture=null,t}_renderHighlightPostprocess(e,t,r,i){const{fboCache:o,techniques:n,bindParameters:s,_passParameters:a,renderingContext:l}=this,c=n.get(ee),h=n.get(Z),d=n.get(q);if(!d.compiled||!h.compiled||!c.compiled)return void this.requestRender(te.C7.UPDATE);a.highlightTexture=e;const u=t(),{width:g,height:p}=e.descriptor;a.highlightTexture=e;const{camera:f}=s,{fullWidth:m,fullHeight:v,pixelRatio:y}=f,_=Math.ceil(m/y),C=Math.ceil(v/y),{_highlightBlurDrawParameters:w}=this,x=this.view.stage.renderView.renderer,{highlights:b}=s;for(let T=0;T<b.length;++T){const{name:e}=b[T];if(!x.hasHighlight(e))continue;a.highlightLevel=T,l.setClearColor(0,0,0,0);const t=o.acquire(g,p,"single highlight",O.NV.RG8UNORM);l.bindFramebuffer(t.fbo),l.setViewport(0,0,g,p),l.clear(oe.NV.COLOR),l.bindTechnique(c,s,a),r(u),w.blurInput=t.getTexture(),(0,z.hZ)(w.blurSize,1/_,0);const n=o.acquire(_,C,"single highlight blur h",O.NV.RG8UNORM);l.unbindTexture(n.fbo?.colorTexture),l.bindFramebuffer(n.fbo),l.setViewport(0,0,_,C),l.clear(oe.NV.COLOR),l.bindTechnique(h,s,a,w),r(u),t.release(),(0,z.hZ)(w.blurSize,0,1/C),a.highlightBlurTexture=n.getTexture(),i(),l.bindTechnique(d,s,a,w),r(u),n.release()}}_gridUpdateResources(e){const t=this._grid,{width:r,height:i}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/$.g),t.verticalCellCount=Math.ceil(i/$.g),t.vao)return;const o=this.renderingContext,n=le.g.createIndex(o,oe._U.STATIC_DRAW,pe);t.vao=new ae.Z(o,re.D,new Map([["geometry",se]]),new Map([["geometry",le.g.createVertex(o,oe._U.STATIC_DRAW)]]),n)}_gridComputeCoverage(e,t,r){const i=this.renderingContext,o=this._grid,n=t.descriptor,s=Math.ceil(n.width/$.g),a=Math.ceil(n.height/$.g);this._downsampleDrawParameters.input=t;const{highlights:l}=r;o.coverage?.release();const c=this.fboCache.acquire(s,a,"highlight coverage",l.length>fe?O.NV.RG8UINT:O.NV.R8UINT);return o.coverage=c,i.bindFramebuffer(c.fbo),i.bindTechnique(e,r,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,s,a),i.screen.draw(),o}get test(){}};(0,o._)([(0,u.MZ)()],de.prototype,"produces",void 0),(0,o._)([(0,u.MZ)()],de.prototype,"consumes",void 0),de=(0,o._)([(0,p.$)("esri.views.3d.webgl-engine.effects.highlight.Highlight")],de);class ue{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let ge=0;const pe=new Uint8Array([0,1,2,2,1,3]);const fe=4;var me=r(80912);class ve{constructor(e,t,r,i){this.material=e,this.output=t,this.techniques=r,this.textures=i}}var ye=r(58947);class _e{constructor(e,t,r,i){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new me.O}dispose(){this._textures.destroy()}acquire(e,t,r){this._ownMaterial(e);const i=e.produces.get(t);if(!i?.(r))return null;let o=this._id2glMaterialRef.get(r,e.id);if(null==o){const t=e.createGLMaterial(new ve(e,r,this._techniques,this._textures));o=new Ce(t),this._id2glMaterialRef.set(r,e.id,o)}return o.ref(),o.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);null!=r&&(r.unref(),r.referenced||((0,l.WD)(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&g.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class Ce{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,ye.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}var we,xe=r(24734),be=r(45722),Te=r(69338),Se=r(60882),Oe=r(86128),Me=r(59646),Re=r(58718),Ie=r(15354),Pe=r(38323);!function(e){e[e.Immediate=0]="Immediate",e[e.FadeWithWeather=1]="FadeWithWeather"}(we||(we={}));var De=r(9409);class Ae{constructor(e){this.shadowMap=e,this.slot=Pe.N.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=Te.Y.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new A.A,this._inverseViewport=(0,Me.vt)(),this._oldLighting=new De.TA,this._newLighting=new De.TA,this._fadedLighting=new De.TA,this._lighting=this._newLighting,this.ssr=new Ee,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=(0,Me.vt)(),this.highlightMixTexture=null,this.hudRenderStyle=Ie.D.Occluded,this.hudOccludedFragmentOpacity=1,this.snowCover=!1,this.clouds=new Re.n,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),i===we.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return null==this.highlightLevel?null:this.highlights[this.highlightLevel]}}class Ee{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,Oe.vt)()}}class Fe{constructor(e,t,r){this.rctx=e,this.techniques=r,this.lastFrameCamera=new A.A,this.output=M.V.Color,this.renderOccludedMask=Ne,this.time=(0,Se.l5)(0),this.bind=new Ae(t),this.bind.alignPixelEnabled=!0}}const Ne=be.m$.Occlude|be.m$.OccludeAndTransparent|be.m$.OccludeAndTransparentStencil;var Le=r(92504),He=r(78607),ze=r(2662),ke=r(10714);let Ve=class extends A.A{constructor(){super(...arguments),this._projectionMatrix=(0,Oe.vt)()}get projectionMatrix(){return this._projectionMatrix}};(0,o._)([(0,u.MZ)()],Ve.prototype,"_projectionMatrix",void 0),(0,o._)([(0,u.MZ)({readOnly:!0})],Ve.prototype,"projectionMatrix",null),Ve=(0,o._)([(0,p.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],Ve);var We,je=r(84147);!function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"}(We||(We={}));class Ue{constructor(){this.camera=new Ve,this.lightMat=(0,Oe.vt)()}}class Ge{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class qe{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ge,this._projectionView=(0,Oe.vt)(),this._projectionViewInverse=(0,Oe.vt)(),this._modelViewLight=(0,Oe.vt)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,E.vt)(),this._cascades=[new Ue,new Ue,new Ue,new Ue],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min((0,s.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(oe.nI)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,ze.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=(0,l.Gz)(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=(0,Le.qE)(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)tt[e]=this._cascades[e];return tt.length=this._numCascades,tt}start(e,t,r,i,o){(0,ye.vA)(this.enabled);const{near:n,far:s}=function(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}(r);this._computeCascadeDistances(n,s,i),this._textureHeight=this._computeTextureHeight(e,o,i),this._setupMatrices(e,t);const{viewMatrix:a,projectionMatrix:l}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,l,a,t);this._lastOrigin=null,this.clear()}finish(){(0,ye.vA)(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!(0,m.q)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,v.vt)(),(0,m.c)(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){(0,f.Tl)(rt,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)it[16*t+e]=rt[e]}}return it}moveSnapshot(e){(0,ye.vA)(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===We.Highlight?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled)return;const t=this._handle?.getTexture(oe.nI)?.descriptor;if(!t)return;this._snapshots[e]?.release();const r=e===We.Highlight?"shadow map highlight":"shadow map excluding highlight",i=this._acquireFBO(r);this._snapshots[e]=i;const o=this._handle?.fbo;if(!o||!i?.fbo)return void console.error("No FBO");const{rctx:n}=this._fbos;n.blitFramebuffer(o,i.fbo,oe.NV.DEPTH)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(oe.nI):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(oe.NV.DEPTH)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:r},i,o){const n=Math.min(window.devicePixelRatio,i)/e,s=o?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return(0,je.Mv)(Math.max(t,r)*n*s,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,O.zd.DEPTH16);return t.getTexture(oe.nI)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=(0,l.Gz)(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,r,i){const o=this._cascades[e],n=-this._cascadeDistances[e],s=-this._cascadeDistances[e+1],a=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),l=(t[10]*s+t[14])/Math.abs(t[11]*s+t[15]);(0,ye.vA)(a<l);for(let u=0;u<8;++u){(0,ze.s)(Ze,u%4==0||u%4==3?-1:1,u%4==0||u%4==1?-1:1,u<4?a:l,1);const e=$e[u];(0,ze.t)(e,Ze,this._projectionViewInverse),e[0]/=e[3],e[1]/=e[3],e[2]/=e[3]}(0,m.u)(et,$e[0]),o.camera.viewMatrix=(0,f.Tl)(Be,this._modelViewLight,et);for(let u=0;u<8;++u)(0,m.t)($e[u],$e[u],o.camera.viewMatrix);let c=$e[0][2],h=$e[0][2];for(let u=1;u<8;++u)c=Math.min(c,$e[u][2]),h=Math.max(h,$e[u][2]);c-=200,h+=200,o.camera.near=-h,o.camera.far=-c,function(e,t,r,i,o){const n=1/$e[0][3],s=1/$e[4][3];(0,ye.vA)(n<s);let a=n+Math.sqrt(n*s);const l=Math.sin((0,Le.XM)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));a/=l,function(e,t,r,i,o,n,s,a){(0,z.hZ)(ot,0,0);for(let w=0;w<4;++w)(0,z.WQ)(ot,ot,e[w]);(0,z.hs)(ot,ot,.25),(0,z.hZ)(nt,0,0);for(let w=4;w<8;++w)(0,z.WQ)(nt,nt,e[w]);(0,z.hs)(nt,nt,.25),(0,z.Cc)(st[0],e[4],e[5],.5),(0,z.Cc)(st[1],e[5],e[6],.5),(0,z.Cc)(st[2],e[6],e[7],.5),(0,z.Cc)(st[3],e[7],e[4],.5);let l=0,c=(0,z.hG)(st[0],ot);for(let w=1;w<4;++w){const e=(0,z.hG)(st[w],ot);e<c&&(c=e,l=w)}(0,z.Re)(at,st[l],e[l+4]);const h=at[0];let d,u;at[0]=-at[1],at[1]=h,(0,z.Re)(lt,nt,ot),(0,z.Om)(lt,at)<0&&(0,z.ze)(at,at),(0,z.Cc)(at,at,lt,r),(0,z.S8)(at,at),d=u=(0,z.Om)((0,z.Re)(ct,e[0],ot),at);for(let w=1;w<8;++w){const t=(0,z.Om)((0,z.Re)(ct,e[w],ot),at);t<d?d=t:t>u&&(u=t)}(0,z.C)(i,ot),(0,z.hs)(ct,at,d-t),(0,z.WQ)(i,i,ct);let g=-1,p=1,f=0,m=0;for(let w=0;w<8;++w){(0,z.Re)(ht,e[w],i),(0,z.S8)(ht,ht);const t=at[0]*ht[1]-at[1]*ht[0];t>0?t>g&&(g=t,f=w):t<p&&(p=t,m=w)}(0,ye.MX)(g>0,"leftArea"),(0,ye.MX)(p<0,"rightArea"),(0,z.hs)(dt,at,d),(0,z.WQ)(dt,dt,ot),(0,z.hs)(ut,at,u),(0,z.WQ)(ut,ut,ot),gt[0]=-at[1],gt[1]=at[0];const v=(0,ye.L)(i,e[m],ut,(0,z.WQ)(ct,ut,gt),1,o),y=(0,ye.L)(i,e[f],ut,ct,1,n),_=(0,ye.L)(i,e[f],dt,(0,z.WQ)(ct,dt,gt),1,s),C=(0,ye.L)(i,e[m],dt,ct,1,a);(0,ye.MX)(v,"rayRay"),(0,ye.MX)(y,"rayRay"),(0,ye.MX)(_,"rayRay"),(0,ye.MX)(C,"rayRay")}($e,a,l,Ye,Qe,Xe,Ke,Je),function(e,t,r,i,o){(0,z.Re)(vt,r,i),(0,z.hs)(vt,vt,.5),yt[0]=vt[0],yt[1]=vt[1],yt[2]=0,yt[3]=vt[1],yt[4]=-vt[0],yt[5]=0,yt[6]=vt[0]*vt[0]+vt[1]*vt[1],yt[7]=vt[0]*vt[1]-vt[1]*vt[0],yt[8]=1,yt[pt(0,2)]=-(0,z.Om)(mt(yt,0),e),yt[pt(1,2)]=-(0,z.Om)(mt(yt,1),e);let n=(0,z.Om)(mt(yt,0),r)+yt[pt(0,2)],s=(0,z.Om)(mt(yt,1),r)+yt[pt(1,2)],a=(0,z.Om)(mt(yt,0),i)+yt[pt(0,2)],l=(0,z.Om)(mt(yt,1),i)+yt[pt(1,2)];n=-(n+a)/(s+l),yt[pt(0,0)]+=yt[pt(1,0)]*n,yt[pt(0,1)]+=yt[pt(1,1)]*n,yt[pt(0,2)]+=yt[pt(1,2)]*n,n=1/((0,z.Om)(mt(yt,0),r)+yt[pt(0,2)]),s=1/((0,z.Om)(mt(yt,1),r)+yt[pt(1,2)]),yt[pt(0,0)]*=n,yt[pt(0,1)]*=n,yt[pt(0,2)]*=n,yt[pt(1,0)]*=s,yt[pt(1,1)]*=s,yt[pt(1,2)]*=s,yt[pt(2,0)]=yt[pt(1,0)],yt[pt(2,1)]=yt[pt(1,1)],yt[pt(2,2)]=yt[pt(1,2)],yt[pt(1,2)]+=1,n=(0,z.Om)(mt(yt,1),t)+yt[pt(1,2)],s=(0,z.Om)(mt(yt,2),t)+yt[pt(2,2)],a=(0,z.Om)(mt(yt,1),r)+yt[pt(1,2)],l=(0,z.Om)(mt(yt,2),r)+yt[pt(2,2)],n=-.5*(n/s+a/l),yt[pt(1,0)]+=yt[pt(2,0)]*n,yt[pt(1,1)]+=yt[pt(2,1)]*n,yt[pt(1,2)]+=yt[pt(2,2)]*n,n=(0,z.Om)(mt(yt,1),t)+yt[pt(1,2)],s=(0,z.Om)(mt(yt,2),t)+yt[pt(2,2)],a=-s/n,yt[pt(1,0)]*=a,yt[pt(1,1)]*=a,yt[pt(1,2)]*=a,o[0]=yt[0],o[1]=yt[1],o[2]=0,o[3]=yt[2],o[4]=yt[3],o[5]=yt[4],o[6]=0,o[7]=yt[5],o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=yt[6],o[13]=yt[7],o[14]=0,o[15]=yt[8]}(Ye,Qe,Ke,Je,o.projectionMatrix),o.projectionMatrix[10]=2/(r-i),o.projectionMatrix[14]=-(r+i)/(r-i)}(r,i,c,h,o.camera),(0,f.lw)(o.lightMat,o.camera.projectionMatrix,o.camera.viewMatrix);const d=this._textureHeight;o.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,t){(0,f.lw)(this._projectionView,e.projectionMatrix,e.viewMatrix),(0,f.B8)(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===ke.RT.Global?e.eye:(0,m.i)(et,0,0,1);(0,f.t5)(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,r){const i=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,ye.kL)(t/e,4)),i);const o=(t-e)/this._numCascades,n=(t/e)**(1/this._numCascades);let s=e,a=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=(0,Le.Cc)(s,a,this.settings.splitSchemeLambda),s*=n,a+=o}get test(){}}const Be=(0,Oe.vt)(),Ze=(0,E.vt)(),$e=[];for(let Et=0;Et<8;++Et)$e.push((0,E.vt)());const Ye=(0,Me.vt)(),Qe=(0,Me.vt)(),Xe=(0,Me.vt)(),Ke=(0,Me.vt)(),Je=(0,Me.vt)(),et=(0,v.vt)(),tt=[],rt=(0,Oe.vt)(),it=Oe.zK.concat(Oe.zK,Oe.zK,Oe.zK,Oe.zK),ot=(0,Me.vt)(),nt=(0,Me.vt)(),st=[(0,Me.vt)(),(0,Me.vt)(),(0,Me.vt)(),(0,Me.vt)()],at=(0,Me.vt)(),lt=(0,Me.vt)(),ct=(0,Me.vt)(),ht=(0,Me.vt)(),dt=(0,Me.vt)(),ut=(0,Me.vt)(),gt=(0,Me.vt)();function pt(e,t){return 3*t+e}const ft=(0,Me.vt)();function mt(e,t){return(0,z.hZ)(ft,e[t],e[t+3]),ft}const vt=(0,Me.vt)(),yt=(0,He.vt)();class _t extends j.w{constructor(e,t){super(e,t,new W.$(L.a,(()=>r.e(76792).then(r.bind(r,76792)))))}initializePipeline(e){return e.hasAlpha?(0,G.Ey)({blending:G.T8,colorWrite:G.kn}):(0,G.Ey)({colorWrite:G.kn})}}var Ct=r(77941);class wt extends Ct.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,o._)([(0,Ct.W)()],wt.prototype,"hasAlpha",void 0);var xt=r(68699),bt=r(75268),Tt=r(36004);class St extends j.w{constructor(e,t){super(e,t,new W.$(Tt.a,(()=>r.e(26008).then(r.bind(r,26008)))))}}var Ot=r(22167);let Mt=class extends H.RW{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Tt.O,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new c.A,this._passParameters=new L.T,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new A.A,this.events=new n.A,this.longitudeCyclical=null,this.produces=new Map([[Pe.N.DRAPED_MATERIAL,e=>e!==M.V.Highlight||this.hasHighlights],[Pe.N.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:i,techniques:o}=t.renderView;this._renderContext=new Fe(this._rctx,new qe(r,e.state.viewingMode),o),this.addHandles([(0,h.wB)((()=>i.updating),(()=>this.events.emit("content-changed")),h.pc),(0,h.wB)((()=>this.spatialReference),(e=>this._localOriginFactory=new xe.g(e)),h.pc),(0,h.on)((()=>e.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0)),(0,h.wB)((()=>function(e){let t=0;for(const i of e){const{name:e}=i;t+=e.length;const{color:r,fillOpacity:o,haloColor:n,haloOpacity:s}=i;t+=r.r+r.g+r.b+r.a+o,t+=n?n.r+n.g+n.b+n.a+s:0}const r=e.at(0);if(r){const{shadowOpacity:e,shadowDifference:i,shadowColor:o}=r;t+=e+i+o.r+o.g+o.b+o.a}return ge+++(t>=0?0:1)}(e.state.highlights)),(()=>this._sortedDrapeSourceRenderersDirty=!0),h.Vh),(0,h.wB)((()=>e.state.highlights),(t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap}),h.Vh),e.resourceController.scheduler.registerTask(Ot.W6.OVERLAY_RENDERER,this)]);const{_bindParameters:n,_camera:s}=this;s.near=1,s.far=1e4,s.relativeElevation=null,n.slot=Pe.N.DRAPED_MATERIAL,n.mainDepth=null,n.camera=s,n.oitPass=Te.Y.NONE,n.updateLighting([new bt.$p((0,v.S)())],0,0,we.Immediate)}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._passParameters.texture=(0,l.WD)(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new _e(this._view.stage.renderView.textures,this._techniques,(()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed")));this._pluginContext={...e,materials:t},this._techniques.precompile(St)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,a.Bs)(this._renderers,(e=>e.updating||e.canCompact))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map((e=>e.drapeSource.layer)).filter((e=>!!e))}registerDrapeSource(e,t){const r=this._renderers.get(e);null!=r&&r.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles((0,h.wB)((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e)}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,d.bw)(e,(e=>e.drapeTargetType===y.sv.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=(0,d.bw)(e,(e=>e.drapeSourceType===y.Om.Features)),this._hasDrapedRasterSource=(0,d.bw)(e,(e=>e.drapeSourceType===y.Om.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new P(this._stage.renderer.fboCache),this._overlays=[new b,new b]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=(0,l.WD)(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){return e===i.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(i.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[i,o]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&o.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=(0,a.Bs)(this._renderers,(e=>e.hasHighlights)),this.notifyChange("rendersOccludedDraped"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return(0,a.Bs)(this._renderers,(t=>t.hasHighlight(e)))}processSyncDrapeSources(){this._processDrapeSources(Ot.Bb,(e=>e.updatePolicy===xt.q.SYNC))}get isEmpty(){return!_.b.OVERLAY_DRAW_DEBUG_TEXTURE&&!(0,a.Bs)(this._renderers,(e=>!e.isEmpty))}get hasWater(){const e=(0,a.Bs)(this._renderers,(({hasWater:e})=>e));return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=Dt,++this._techniques.precompiling;const t=this._sortedRenderers.some((({renderer:e})=>e.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=e,t}renders(e){if(_.b.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==i.Occluded&&e!==i.Highlight)return!0;if(!this._overlays)return!1;const t=this._overlays[C.vr.INNER];for(const i of this._overlays)i.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find((t=>t.content===e))?.output??M.V.Color,++this._techniques.precompiling;const o=this._sortedRenderers.some((({renderer:e})=>e.precompile(this._renderContext)));return--this._techniques.precompiling,this._renderContext.output=r,o}get mode(){return this.isEmpty?F.Disabled:this.hasWater&&this.renders(i.WaterNormal)?F.EnabledWithWater:this._renderTargets?.getTexture(i.Color)?F.Enabled:F.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((r=>t=r.updateAnimation(e)||t)),t&&this.parent.requestRender(te.C7.BACKGROUND),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const r of this._renderTargets.targets){if(r.content===i.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const e=r.output;this._renderContext.output=e,t.slot=e===M.V.Normal?Pe.N.DRAPED_WATER:Pe.N.DRAPED_MATERIAL,e===M.V.Highlight&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null),r.content===i.Occluded&&(this._renderContext.renderOccludedMask=Dt),this._sortedRenderers.forAll((({drapeSource:e,renderer:t})=>{r.content===i.ColorNoRasterImage&&e.drapeSourceType===y.Om.RasterImage||t.precompile(this._renderContext)})),this._renderContext.renderOccludedMask=Ne,t.highlightMixTexture=null}--this._techniques.precompiling}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;for(const e of this._renderTargets.targets){if(e.content===i.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const t=this._drawTarget(C.vr.INNER,e),r=this._drawTarget(C.vr.OUTER,e);(t||r)&&e.fbo.generateMipMap()}}}_drawTarget(e,t){const r=this._overlays[e],o=r.canvasGeometries;if(0===o.numViews)return!1;const n=this._view.state.contentPixelRatio;this._screenToWorldRatio=n*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:s}=t;if(this.isEmpty||s===M.V.Normal&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:a,_camera:l,_renderContext:c,_bindParameters:h}=this;if(l.pixelRatio=r.pixelRatio*n,c.output=s,h.screenToWorldRatio=this._screenToWorldRatio,h.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,h.slot=s===M.V.Normal?Pe.N.DRAPED_WATER:Pe.N.DRAPED_MATERIAL,t.content===i.Occluded&&(c.renderOccludedMask=Dt),!this.renders(t.content))return c.renderOccludedMask=Ne,!1;const{resolution:d}=r,u=e===C.vr.INNER,g=u?0:d;if(a.setViewport(g,0,d,d),this._bindTargetFBO(t),u)if(t.output!==M.V.Highlight)a.setClearColor(0,0,0,0),a.clear(oe.NV.COLOR);else{const{gl:e}=a;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(_.b.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==i.Occluded&&t.content!==i.Highlight){this._techniques.precompile(_t,At);const t=this._techniques.get(_t,At);for(let i=0;i<o.numViews;i++)this._setViewParameters(o.extents[i],r),this._ensureDebugPatternResources(r.resolution,It[e]),a.bindTechnique(t,h,this._passParameters),a.screen.draw()}if(t.output===M.V.Highlight){const{fboCache:r}=this._stage.renderer,i=this._resolution;this._bindTargetFBO(t),function(e,t,r,i,o,n=0){const{highlights:s}=i,a=s.length>1?t.acquire(r.width,r.height,"highlight mix",s.length>fe?O.NV.RG8UINT:O.NV.R8UINT):null,{gl:l}=e;if(a){const t=e.getBoundFramebufferObject();e.bindFramebuffer(a.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const c=a?.getTexture();i.highlightMixTexture=c,(0,z.hZ)(i.highlightMixOrigin,n,0),s.forEach(((t,s)=>{if(s>0){const t=ce.g.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(c,t),e.setActiveTexture(t),l.copyTexSubImage2D(oe.Ap.TEXTURE_2D,0,0,0,n,0,r.width,r.height),e.bindTexture(null,t)}e.clear(oe.NV.DEPTH),i.highlightLevel=s,o()})),i.highlightLevel=null,i.highlightMixTexture=null,a?.release()}(a,r,{width:i,height:i},h,(()=>this._renderAllGeometry(e,t)),g)}else this._renderAllGeometry(e,t);return a.bindFramebuffer(null),c.renderOccludedMask=Ne,!0}_renderAllGeometry(e,t){const r=this._overlays[e],o=r.canvasGeometries;this._sortedRenderers.forAll((({drapeSource:n,renderer:s})=>{if(t.content===i.ColorNoRasterImage&&n.drapeSourceType===y.Om.RasterImage)return;const{fullOpacity:a}=n,l=null!=a&&a<1&&t.output===M.V.Color&&this._bindTemporaryFBO();for(let e=0;e<o.numViews;e++)this._setViewParameters(o.extents[e],r),s.render(this._renderContext);if(l){this._bindTargetFBO(t),this._overlayParameters.texture=l.getTexture(),this._overlayParameters.opacity=a,this._overlayParameters.overlayIndex=e;const r=this._techniques.get(St);this._rctx.bindTechnique(r,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),l.release()}}))}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.bind(this._rctx,r,t)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,i=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(oe.NV.COLOR),i}get _resolution(){return this._overlays?.[C.vr.INNER].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let o=0;for(const{renderer:n}of this._sortedRenderers)o=n.intersect?.(e,t,r,i,o)??o}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this._view.map.allLayers,t=e.length;this._renderers.forEach(((r,i)=>{const o=e.indexOf(i.layer),n=o>=0,s=i.renderGroup??(n?y.O7.MapLayer:y.O7.ViewLayer),a=i.drapeSourcePriorityOffset??0,l=t*s+(n?o:0)+a;this._sortedRenderers.push(new Rt(i,r,l))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],(0,f.v3)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,f.kN)(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if((0,m.i)(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let n=0;n<e;n++)for(let t=0;t<e;t++){const o=Math.floor(t/10),s=Math.floor(n/10);o<2||s<2||10*o>e-20||10*s>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&o&&1&s?1&t^1&n?0:255:1&o^1&s?0:128)}const o=new he.R(e);o.samplingMode=oe.Cj.NEAREST,this._passParameters.texture=new ce.g(this._rctx,o,r)}get test(){}};(0,o._)([(0,u.MZ)()],Mt.prototype,"hasHighlights",void 0),(0,o._)([(0,u.MZ)()],Mt.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,o._)([(0,u.MZ)({constructOnly:!0})],Mt.prototype,"parent",void 0),(0,o._)([(0,u.MZ)({readOnly:!0})],Mt.prototype,"_techniques",null),(0,o._)([(0,u.MZ)({type:Boolean,readOnly:!0})],Mt.prototype,"updating",null),(0,o._)([(0,u.MZ)()],Mt.prototype,"isEmpty",null),(0,o._)([(0,u.MZ)({readOnly:!0})],Mt.prototype,"rendersOccludedDraped",null),Mt=(0,o._)([(0,p.$)("esri.views.3d.terrain.OverlayRenderer")],Mt);class Rt{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const It=[[1,.5,.5],[.5,.5,1]],Pt=-2,Dt=be.m$.OccludeAndTransparent,At=new wt;At.hasAlpha=!0},36572:(e,t,r)=>{var i,o,n;r.d(t,{vr:()=>i}),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(i||(i={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(o||(o={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(n||(n={}))},4388:(e,t,r)=>{r.d(t,{Q:()=>u});var i=r(60704),o=r(59646),n=r(72196),s=r(11809),a=r(99120);class l extends a.n{constructor(e,t){super(e,"ivec2",s.c.Pass,((r,i,o)=>r.setUniform2iv(e,t(i,o))))}}var c=r(3445),h=r(7568),d=r(61068);function u(e){const{vertex:t}=e;t.uniforms.add(new h.R("coverageTexture",(e=>e.coverageTexture)),new l("highlightRenderCellCount",(e=>(0,i.hZ)(g,e.horizontalCellCount,e.verticalCellCount))),new l("highlightTextureResolution",(({highlightTexture:e})=>(0,i.hZ)(g,e.descriptor.width,e.descriptor.height))),new c.c("highlightLevel",(e=>e.highlightLevel))).constants.add("cellSize","int",d.g),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(n.H`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(n.H`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const g=(0,o.vt)()},79870:(e,t,r)=>{r.d(t,{v:()=>n,z:()=>o});var i=r(72196);function o(e){e.code.add(i.H`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function n(e){e.code.add(i.H`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},548:(e,t,r)=>{r.d(t,{E:()=>P});var i=r(79870),o=r(31415),n=r(72196);function s(e){e.code.add(n.H`
    const float GAMMA = ${n.H.float(o.Tf)};
    const float INV_GAMMA = ${n.H.float(1/o.Tf)};

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.a);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)}var a=r(17666),l=r(23606),c=r(65743),h=r(74767),d=r(17983),u=r(82088),g=r(96390);function p(e,t){if(!t.screenSpaceReflections)return;const r=e.fragment;r.include(c.E),r.uniforms.add(new h.E("nearFar",(e=>e.camera.nearFar)),new g.x("depthMap",(e=>e.depth?.attachment)),new u.F("proj",(e=>e.camera.projectionMatrix)),new d.U("invResolutionHeight",(e=>1/e.camera.height)),new u.F("reprojectionMatrix",(e=>e.ssr.reprojectionMatrix))).code.add(n.H`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);
    float dDepthBefore = 0.0;

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        float weight = dDepth / (dDepth - dDepthBefore);
        vec2 Pf = mix(P - dP, P, 1.0 - weight);
        if (abs(Pf.y - projectedCoordStart.y) > invResolutionHeight) {
          return vec3(Pf, depth);
        }
        else {
          return vec3(P, depth);
        }
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
      dDepthBefore = dDepth;
    }
    return vec3(P, 0.0);
  }
  `)}var f=r(58359),m=r(99817),v=r(5842),y=r(58718),_=r(84323),C=r(696);function w(e){e.fragment.uniforms.add(new d.U("cloudAbsorption",(e=>e.clouds.absorption)),new d.U("cloudCoverage",(e=>e.clouds.coverage))).code.add(n.H`vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {
int faceIndex;
vec2 uv;
if(rayDir.z <= 0.0) {
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));
float shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);
float totalTransmittance = hazeFactor;
return vec4(shading, totalTransmittance, shading, totalTransmittance);
}
if (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {
if(rayDir.x > 0.0) {
faceIndex = 0;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, uv.y);
} else {
faceIndex = 1;
uv = rayDir.yz / rayDir.x;
uv = vec2(-uv.x, -uv.y);
}
} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {
if(rayDir.y > 0.0) {
faceIndex = 2;
uv = rayDir.xz / rayDir.y;
} else {
faceIndex = 3;
uv = rayDir.xz / rayDir.y;
uv = vec2(uv.x, -uv.y);
}
} else {
if(rayDir.y < 0.0) {
faceIndex = 4;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
} else {
faceIndex = 5;
uv = rayDir.xy / rayDir.z;
uv = vec2(uv.x, -uv.y);
}
}
uv = 0.5 * (uv + 1.0);
if(faceIndex != 5) {
uv.y = uv.y - 0.5;
}
uv.y = uv.y * 2.0;
vec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));
return s;
}`)}var x=r(10561),b=r(81598),T=r(11809),S=r(99120);class O extends S.n{constructor(e,t){super(e,"sampler2DArray",T.c.Bind,((r,i)=>r.bindTexture(e,t(i))))}}function M(e){const t=e.fragment;t.constants.add("radiusCloudsSquared","float",R).code.add(n.H`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),t.uniforms.add(new d.U("radiusCurvatureCorrection",(({clouds:e})=>e.parallax.radiusCurvatureCorrection))).code.add(n.H`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),t.code.add(n.H`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),(0,C.Gc)(t),(0,C.O4)(t);const r=(0,f.fA)(.28,.175,.035);t.constants.add("RIM_COLOR","vec3",r);t.code.add(n.H`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${n.H.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${n.H.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${n.H.float(.2)} * pow(dirDotLight, ${n.H.float(10)}) * (1. - pow(sunsetTransition, ${n.H.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),e.include(w),t.uniforms.add(new x.o("readChannelsRG",(e=>e.clouds.readChannels===v.c.RG)),new O("cubeMap",(e=>e.clouds.data?.cubeMap?.colorTexture))).code.add(n.H`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),t.uniforms.add(new b.d("anchorPoint",(e=>e.clouds.parallax.anchorPoint)),new b.d("anchorPointNew",(e=>e.clouds.parallaxNew.anchorPoint)),new u.F("rotationClouds",(e=>e.clouds.parallax.transform)),new u.F("rotationCloudsNew",(e=>e.clouds.parallaxNew.transform)),new d.U("cloudsOpacity",(e=>e.clouds.opacity)),new d.U("fadeFactor",(e=>e.clouds.fadeFactor)),new x.o("crossFade",(e=>e.clouds.fadeState===y.c.CROSS_FADE))).code.add(n.H`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const R=(m.$O.radius+_.k9)**2;var I=r(85856);function P(e,t){const r=e.fragment;r.include(a.f,t),r.include(s),r.include(i.v),t.cloudReflections&&e.include(M),e.include(p,t),r.include(I.b,t),r.constants.add("fresnelSky","vec3",[.02,1,15]),r.constants.add("fresnelMaterial","vec2",[.02,.1]),r.constants.add("roughness","float",.015),r.constants.add("foamIntensityExternal","float",1.7),r.constants.add("ssrIntensity","float",.65),r.constants.add("ssrHeightFadeStart","float",l.O),r.constants.add("ssrHeightFadeEnd","float",l.b),r.constants.add("waterDiffusion","float",.92),r.constants.add("waterSeaColorMod","float",.8),r.constants.add("correctionViewingPowerFactor","float",.4),r.constants.add("skyZenitColor","vec3",[.52,.68,.9]),r.constants.add("skyColor","vec3",[.67,.79,.9]),r.constants.add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(n.H`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new d.U("lightingSpecularStrength",(e=>e.lighting.mainLight.specularStrength)),new d.U("lightingEnvironmentStrength",(e=>e.lighting.mainLight.environmentStrength))),r.code.add(n.H`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
float NdotL = clamp(dot(n, l), 0.0, 1.0);
specular = lightingSpecularStrength * NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.cloudReflections&&r.uniforms.add(new d.U("cloudsOpacity",(e=>e.clouds.opacity))).code.add(n.H`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * cloudsOpacity;`),t.screenSpaceReflections?r.uniforms.add(new u.F("view",(e=>e.camera.viewMatrix)),new g.x("lastFrameColorTexture",(e=>e.ssr.lastFrameColor?.getTexture())),new d.U("fadeFactorSSR",(e=>e.ssr.fadeFactor))).code.add(n.H`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view * vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`):r.code.add(n.H`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.cloudReflections?t.screenSpaceReflections?r.code.add(n.H`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(n.H`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(n.H`return waterRenderedColor;
}`)}},7568:(e,t,r)=>{r.d(t,{R:()=>n});var i=r(11809),o=r(99120);class n extends o.n{constructor(e,t){super(e,"usampler2D",i.c.Pass,((r,i,o)=>r.bindTexture(e,t(i,o))))}}},38931:(e,t,r)=>{r.d(t,{Cc:()=>c,RW:()=>l});var i=r(52495),o=r(55274),n=r(45722);const s={required:[]};o.V.Depth;class a extends i.A{precompile(e){return!!this.acquireTechniques(e)}consumes(){return s}get usedMemory(){return 0}get renderOccludedFlags(){return n.m$.Occlude}get isDecoration(){return!1}get running(){return!1}modify(e,t){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}}class l extends a{}class c extends a{}},23183:(e,t,r)=>{var i,o;r.d(t,{k:()=>o,q:()=>i}),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(i||(i={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(o||(o={}))},2007:(e,t,r)=>{r.d(t,{$:()=>c});var i=r(65061),o=r(21742),n=r(86128),s=r(24121),a=r(31803),l=r(72699);class c{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=(0,n.vt)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,i.c)(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){(0,o.C)(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=(0,n.vt)(),(0,o.lw)(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=(0,a.c)(),(0,s.t)((0,a.a)(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,l.hG)(this.shaderTransformation)),this._boundingSphere):a.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}},11459:(e,t,r)=>{r.d(t,{Z:()=>o});var i=r(80976);class o extends i.Z{}},32504:(e,t,r)=>{r.d(t,{v:()=>P});var i=r(28152),o=r(11110),n=r(55274),s=r(36340),a=r(91013),l=r(67341),c=r(1931),h=r(38323),d=r(50645),u=r(25146),g=r(52873),p=r(17745),f=r(47705),m=r(28347),v=r(69338),y=r(98546),_=r(17504),C=r(2449);p.S;class w extends m.w{constructor(e,t){super(e,t,new f.$(_.C,(()=>r.e(34788).then(r.bind(r,34788)))))}_createPipeline(e,t){const{oitPass:r,output:i,transparent:o,cullFace:s,draped:a,hasOccludees:l,polygonOffset:h}=e,d=r===v.Y.NONE;return(0,C.Ey)({blending:(0,n.RN)(i)&&o?(0,c.Yf)(r):null,culling:(0,C.Xt)(s),depthTest:a?null:{func:(0,c.K_)(r)},depthWrite:(0,c.z5)(e),drawBuffers:(0,m.L)(i,(0,c.m6)(r,i)),colorWrite:C.kn,stencilWrite:l?y.v0:null,stencilTest:l?t?y.a9:y.qh:null,polygonOffset:d?h?x:null:(0,c.mE)(e)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}const x={factor:1,units:1};var b=r(66866),T=r(26139),S=r(15420),O=r(77941),M=r(9319);class R extends M.E{constructor(){super(...arguments),this.cullFace=a.s2.None,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=T.I.None,this.emissionSource=S.ZX.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.vvSize=!1,this.vvOpacity=!1,this.snowCover=!1}}(0,b._)([(0,O.W)({count:a.s2.COUNT})],R.prototype,"cullFace",void 0),(0,b._)([(0,O.W)()],R.prototype,"hasVertexColors",void 0),(0,b._)([(0,O.W)()],R.prototype,"transparent",void 0),(0,b._)([(0,O.W)()],R.prototype,"discardInvisibleFragments",void 0),(0,b._)([(0,O.W)()],R.prototype,"polygonOffset",void 0),(0,b._)([(0,O.W)()],R.prototype,"enableOffset",void 0),(0,b._)([(0,O.W)()],R.prototype,"writeDepth",void 0),(0,b._)([(0,O.W)()],R.prototype,"hasOccludees",void 0),(0,b._)([(0,O.W)()],R.prototype,"terrainDepthTest",void 0),(0,b._)([(0,O.W)()],R.prototype,"cullAboveTerrain",void 0),(0,b._)([(0,O.W)()],R.prototype,"objectAndLayerIdColorInstanced",void 0),(0,b._)([(0,O.W)()],R.prototype,"vvColor",void 0),(0,b._)([(0,O.W)()],R.prototype,"draped",void 0);var I=r(63199);class P extends g.W{constructor(e){super(e,A),this._configuration=new R,this.supportsEdges=!0,this.produces=new Map([[h.N.OPAQUE_MATERIAL,e=>this._isOpaqueMaterialPass(e)],[h.N.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>this._isOpaqueNoSSAODepthPass(e)],[h.N.TRANSPARENT_MATERIAL,e=>(0,n.QG)(e)&&this._transparent&&this.parameters.writeDepth],[h.N.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,e=>(0,n.eh)(e)&&this._transparent&&this.parameters.writeDepth],[h.N.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,e=>(0,n.QG)(e)&&this._transparent&&!this.parameters.writeDepth],[h.N.DRAPED_MATERIAL,e=>(0,n.i3)(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<c.xt,this._configuration.terrainDepthTest=t.terrainDepthTest&&(0,n.RN)(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=I.Q}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===n.V.Highlight||(0,n.QG)(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return(0,n.eh)(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new D(e)}createBufferWriter(){const e=(0,o.BP)().vec3f(d.r.POSITION);return(0,s.E)()&&e.vec4u8(d.r.OLIDCOLOR),this.parameters.vvColor?e.f32(d.r.COLORFEATUREATTRIBUTE):e.vec4u8(d.r.COLOR),new u.Z(e)}}class D extends l.A{beginSlot(e){return this.getTechnique(w,e)}}class A extends p.S{constructor(){super(...arguments),this.color=i.uY,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=a.s2.None,this.draped=!1,this.discardInvisibleFragments=!1}}},27776:(e,t,r)=>{r.d(t,{Ci:()=>n,KL:()=>l,dB:()=>a,l5:()=>s,wB:()=>c});var i=r(11110),o=r(50645);const n=(0,i.BP)().vec3f(o.r.POSITION),s=(0,i.BP)().vec3f(o.r.POSITION).vec2f16(o.r.UV0),a=(0,i.BP)().vec3f(o.r.POSITION).vec4u8(o.r.COLOR),l=((0,i.BP)().vec3f(o.r.POSITION).vec2f16(o.r.UV0).vec4u8(o.r.OLIDCOLOR),(0,i.BP)().vec3f(o.r.POSITION).vec2f(o.r.UV0)),c=(0,i.BP)().vec3f(o.r.POSITION).vec2f(o.r.UV0).vec4u8(o.r.OLIDCOLOR)},52873:(e,t,r)=>{r.d(t,{W:()=>s});var i=r(58359),o=r(45722),n=r(6833);class s extends o.im{constructor(){super(...arguments),this._pp0=(0,i.fA)(0,0,1),this._pp1=(0,i.fA)(0,0,0)}intersect(e,t,r,i,o,s){return(0,n.Uy)(e,r,i,o,void 0,s)}intersectDraped(e,t,r,i){return this._pp0[0]=this._pp1[0]=r[0],this._pp0[1]=this._pp1[1]=r[1],(0,n.Uy)(e,t,this._pp0,this._pp1,void 0,i)}}},86868:(e,t,r)=>{r.d(t,{Xq:()=>a,wk:()=>s});const i={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},o={dash:i.dash,"dash-dot":[...i.dash,...i.dot],dot:i.dot,"long-dash":i["long-dash"],"long-dash-dot":[...i["long-dash"],...i.dot],"long-dash-dot-dot":[...i["long-dash"],...i.dot,...i.dot],none:null,"short-dash":i["short-dash"],"short-dash-dot":[...i["short-dash"],...i["short-dot"]],"short-dash-dot-dot":[...i["short-dash"],...i["short-dot"],...i["short-dot"]],"short-dot":i["short-dot"],solid:null},n=8;function s(e){return{pattern:[e,e],pixelRatio:2}}function a(e){return"style"===e?.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(o[e],n):null}(e.style):null}}}]);