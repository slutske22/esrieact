"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[569],{84858:(t,e,i)=>{var n;i.d(e,{u:()=>n}),function(t){t[t.KILOBYTES=1024]="KILOBYTES",t[t.MEGABYTES=1048576]="MEGABYTES",t[t.GIGABYTES=1073741824]="GIGABYTES"}(n||(n={}))},775:(t,e,i)=>{i.d(e,{$:()=>b,N2:()=>g,QP:()=>D,RH:()=>y,Vl:()=>z,Ws:()=>_,ZD:()=>w,_L:()=>$,bJ:()=>T,e$:()=>O,f6:()=>L,pW:()=>M,pf:()=>S});var n=i(96220),a=(i(25102),i(52712));function r(t){return"h"in t&&"s"in t&&"v"in t}function l(t){return"l"in t&&"a"in t&&"b"in t}function o(t){return"l"in t&&"c"in t&&"h"in t}const s=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],h=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function c(t,e){const i=[];let n,a;if(t[0].length!==e.length)throw new Error("dimensions do not match");const r=t.length,l=t[0].length;let o=0;for(n=0;n<r;n++){for(o=0,a=0;a<l;a++)o+=t[n][a]*e[a];i.push(o)}return i}function u(t){const e=[t.r/255,t.g/255,t.b/255].map((t=>t<=.04045?t/12.92:((t+.055)/1.055)**2.4)),i=c(s,e);return{x:100*i[0],y:100*i[1],z:100*i[2]}}function f(t){const e=c(h,[t.x/100,t.y/100,t.z/100]).map((t=>{const e=t<=.0031308?12.92*t:1.055*t**(1/2.4)-.055;return Math.min(1,Math.max(e,0))}));return{r:Math.round(255*e[0]),g:Math.round(255*e[1]),b:Math.round(255*e[2])}}function p(t){const e=[t.x/95.047,t.y/100,t.z/108.883].map((t=>t>(6/29)**3?t**(1/3):1/3*(29/6)**2*t+4/29));return{l:116*e[1]-16,a:500*(e[0]-e[1]),b:200*(e[1]-e[2])}}function m(t){const e=t.l,i=[(e+16)/116+t.a/500,(e+16)/116,(e+16)/116-t.b/200].map((t=>t>6/29?t**3:3*(6/29)**2*(t-4/29)));return{x:95.047*i[0],y:100*i[1],z:108.883*i[2]}}function d(t){return function(t){const e=t.l,i=t.a,n=t.b,a=Math.sqrt(i*i+n*n);let r=Math.atan2(n,i);return r=r>0?r:r+2*Math.PI,{l:e,c:a,h:r}}(p(u(t)))}function v(t){return f(m(function(t){const e=t.l,i=t.c,n=t.h;return{l:e,a:i*Math.cos(n),b:i*Math.sin(n)}}(t)))}function b(t){return function(t){return"r"in t&&"g"in t&&"b"in t}(t)?t:o(t)?v(t):l(t)?function(t){return f(m(t))}(t):function(t){return"x"in t&&"y"in t&&"z"in t}(t)?f(t):r(t)?function(t){const e=(t.h+360)%360/60,i=t.s/100,n=t.v/100*255,a=n*i,r=a*(1-Math.abs(e%2-1));let l;switch(Math.floor(e)){case 0:l={r:a,g:r,b:0};break;case 1:l={r:r,g:a,b:0};break;case 2:l={r:0,g:a,b:r};break;case 3:l={r:0,g:r,b:a};break;case 4:l={r:r,g:0,b:a};break;case 5:case 6:l={r:a,g:0,b:r};break;default:l={r:0,g:0,b:0}}return l.r=Math.round(l.r+n-a),l.g=Math.round(l.g+n-a),l.b=Math.round(l.b+n-a),l}(t):t}function g(t){return r(t)?t:function(t){const e=t.r,i=t.g,n=t.b,a=Math.max(e,i,n),r=a-Math.min(e,i,n);let l=a,o=0===r?0:a===e?(i-n)/r%6:a===i?(n-e)/r+2:(e-i)/r+4,s=0===r?0:r/l;return o<0&&(o+=6),o*=60,s*=100,l*=100/255,{h:o,s:s,v:l}}(b(t))}function w(t){return l(t)?t:function(t){return p(u(t))}(b(t))}function y(t){return o(t)?t:d(b(t))}function A(t){let{r:e,g:i,b:a,a:r}=t;return r<1&&(e=Math.round(r*e+255*(1-r)),i=Math.round(r*i+255*(1-r)),a=Math.round(r*a+255*(1-r))),new n.A({r:e,g:i,b:a})}function _(t,e){const{r:i,g:n,b:a}=e?.ignoreAlpha?t:A(t);return.2126*i+.7152*n+.0722*a}var M;function T(t,e=M.High){return _(t,{ignoreAlpha:!0})>e?new n.A([0,0,0,t.a]):new n.A([255,255,255,t.a])}function O(t,e){const i=w(t);i.l*=1-e;const n=b(i),a=t.clone();return a.setColor(n),a.a=t.a,a}function $(t,e){const i=t.clone();return i.a*=e,i}function z(t,e){const i=g(t);i.s*=e;const n=b(i),a=t.clone();return a.setColor(n),a.a=t.a,a}function D(t){return n.A.toUnitRGBA(t)}function S(t){return(0,a.f)(t[0],t[1],t[2],t.length>3?t[3]:1)}function L(t,e){const i=n.A.toUnitRGBA(t);return i[3]*=e,i}!function(t){t[t.Low=160]="Low",t[t.High=225]="High"}(M||(M={}))},35787:(t,e,i)=>{i.d(e,{d:()=>T});var n,a=i(66866),r=i(86394),l=i(52495),o=i(84858),s=i(98849),h=i(20464),c=i(89926),u=i(63678),f=i(40189),p=i(85251),m=i(61449),d=i(20909),v=i(21564),b=(i(73446),i(85569)),g=(i(39831),i(63863)),w=i(88061),y=i(19251),A=i(86942);class _{constructor(t){this._validateJSON(t);const{location:e,data:i}=t;this.location=Object.freeze((0,y.o8)(e));const n=this.location.width,a=this.location.height;let r=!0,l=!0;const o=function(t,e=!1){return t<=A.y9?e?new Array(t).fill(0):new Array(t):new Uint32Array(t)}(Math.ceil(n*a/32));let s=0;for(let h=0;h<i.length;h++){const t=h%32;i[h]?(l=!1,o[s]|=1<<t):r=!1,31===t&&++s}l?(this._availability="unavailable",this.byteSize=40):r?(this._availability="available",this.byteSize=40):(this._availability=o,this.byteSize=40+(0,A.Ek)(o))}getAvailability(t,e){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const i=(t-this.location.top)*this.location.width+(e-this.location.left),n=i%32,a=i>>5,r=this._availability;return a<0||a>r.length?"unknown":r[a]&1<<n?"available":"unavailable"}static fromDefinition(t,e){const i=t.service.request||r.A,{row:n,col:a,width:l,height:o}=t,h={query:{f:"json"}};return e=e?{...h,...e}:h,i(function(t){let e;if(t.service.tileServers?.length){const i=t.service.tileServers;e=`${i&&i.length?i[t.row%i.length]:t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}else e=`${t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;const i=t.service.query;return i&&(e=`${e}?${i}`),e}(t),e).then((t=>t.data)).catch((t=>{if(t&&t.details&&422===t.details.httpStatus)return{location:{top:n,left:a,width:l,height:o},valid:!0,data:(0,b.dY)(l*o,0)};throw t})).then((t=>{if(t.location&&(t.location.top!==n||t.location.left!==a||t.location.width!==l||t.location.height!==o))throw new s.A("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:n,left:a,width:l,height:o}});return _.fromJSON(t)}))}static fromJSON(t){return Object.freeze(new _(t))}_validateJSON(t){if(!t?.location)throw new s.A("tilemap:missing-location","Location missing from tilemap response");if(!1===t.valid)throw new s.A("tilemap:invalid","Tilemap response was marked as invalid");if(!t.data)throw new s.A("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(t.data))throw new s.A("tilemap:data-mismatch","Data must be an array of numbers");if(t.data.length!==t.location.width*t.location.height)throw new s.A("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}function M(t){return`${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}let T=n=class extends l.A{constructor(t){super(t),this._pendingTilemapRequests={},this.request=r.A,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new c.q(2*o.u.MEGABYTES),this.addHandles([(0,p.wB)((()=>{const{layer:t}=this;return[t?.parsedUrl,t?.tileServers,t?.apiKey,t?.customParameters]}),(()=>this._initializeTilemapDefinition()),p.Vh)])}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}fetchTilemap(t,e,i,n){if(!this.layer.tileInfo.lodAt(t)||t<this.effectiveMinLOD||t>this.effectiveMaxLOD)return Promise.reject(new s.A("tilemap-cache:level-unavailable",`Level ${t} is unavailable in the service`));const a=this._tmpTilemapDefinition,r=this._tilemapFromCache(t,e,i,a);if(r)return Promise.resolve(r);const l=n?.signal;return n={...n,signal:null},new Promise(((t,e)=>{(0,f.u7)(l,(()=>e((0,f.NK)())));const i=M(a);let r=this._pendingTilemapRequests[i];if(!r){r=_.fromDefinition(a,n).then((t=>(this._tilemapCache.put(i,t,t.byteSize),t)));const t=()=>{delete this._pendingTilemapRequests[i]};this._pendingTilemapRequests[i]=r,r.then(t,t)}r.then(t,e)}))}getAvailability(t,e,i){if(!this.layer.tileInfo.lodAt(t)||t<this.effectiveMinLOD||t>this.effectiveMaxLOD)return"unavailable";const n=this._tilemapFromCache(t,e,i,this._tmpTilemapDefinition);return n?n.getAvailability(e,i):"unknown"}fetchAvailability(t,e,i,n){return!this.layer.tileInfo.lodAt(t)||t<this.effectiveMinLOD||t>this.effectiveMaxLOD?Promise.reject(new s.A("tile-map:tile-unavailable","Tile is not available",{level:t,row:e,col:i})):this.fetchTilemap(t,e,i,n).catch((t=>t)).then((n=>{if(n instanceof _){const a=n.getAvailability(e,i);if("unavailable"===a)throw new s.A("tile-map:tile-unavailable","Tile is not available",{level:t,row:e,col:i});return a}if((0,f.zf)(n))throw n;return"unknown"}))}fetchAvailabilityUpsample(t,e,i,n,a){n.level=t,n.row=e,n.col=i;const r=this.layer.tileInfo;r.updateTileInfo(n);const l=this.fetchAvailability(t,e,i,a).catch((t=>{if((0,f.zf)(t))throw t;if(r.upsampleTile(n))return this.fetchAvailabilityUpsample(n.level,n.row,n.col,n,a);throw t}));return this._fetchAvailabilityUpsamplePrefetch(n.id,t,e,i,a,l),l}async _fetchAvailabilityUpsamplePrefetch(t,e,i,a,r,l){if(!this._prefetchingEnabled||null==t)return;const o=`prefetch-${t}`;if(this.hasHandles(o))return;const s=new AbortController;l.then((()=>s.abort()),(()=>s.abort()));let c=!1;const u=(0,h.hA)((()=>{c||(c=!0,s.abort())}));if(this.addHandles(u,o),await(0,m.md)(10,s.signal).catch((()=>{})),c||(c=!0,this.removeHandles(o)),(0,f.G4)(s))return;const p=new w.U(t,e,i,a),d={...r,signal:s.signal},v=this.layer.tileInfo;for(let h=0;n._prefetches.length<n._maxPrefetch&&v.upsampleTile(p);++h){const t=this.fetchAvailability(p.level,p.row,p.col,d);n._prefetches.push(t);const e=()=>{n._prefetches.removeUnordered(t)};t.then(e,e)}}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const{parsedUrl:t,apiKey:e,customParameters:i}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:t.path,query:(0,d.x0)({...t.query,...i,token:e??t.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(t,e,i,n){n.level=t,n.row=e-e%this.size,n.col=i-i%this.size;const a=M(n);return this._tilemapCache.get(a)}get test(){const t=this;return{get prefetchingEnabled(){return t._prefetchingEnabled},set prefetchingEnabled(e){t._prefetchingEnabled=e},hasTilemap:(e,i,n)=>!!t._tilemapFromCache(e,i,n,t._tmpTilemapDefinition)}}};T._maxPrefetch=4,T._prefetches=new u.A({initialSize:n._maxPrefetch}),(0,a._)([(0,v.MZ)({constructOnly:!0})],T.prototype,"layer",void 0),(0,a._)([(0,v.MZ)({constructOnly:!0})],T.prototype,"minLOD",void 0),(0,a._)([(0,v.MZ)({constructOnly:!0})],T.prototype,"maxLOD",void 0),(0,a._)([(0,v.MZ)({constructOnly:!0})],T.prototype,"request",void 0),(0,a._)([(0,v.MZ)({constructOnly:!0})],T.prototype,"size",void 0),T=n=(0,a._)([(0,g.$)("esri.layers.support.TilemapCache")],T)}}]);