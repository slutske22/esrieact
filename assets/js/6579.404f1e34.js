"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6579],{17504:(e,t,r)=>{r.d(t,{C:()=>T,b:()=>O});var i=r(40641),o=r(55274),n=r(1110),s=r(66012),a=r(33045),l=r(39739),c=r(56178),d=r(63269),h=r(80600),u=r(34328),p=r(33448),f=r(89002),m=r(63592),g=r(1411),v=r(99152),_=r(4274),y=r(81868),w=r(50645);function O(e){const t=new _.N5,{vertex:r,fragment:O,attributes:T,varyings:C}=t;(0,m.NB)(r,e),t.include(s.d,e),t.include(l.c,e),t.include(u.A,e),t.include(a.g,e),T.add(w.r.POSITION,"vec3"),e.vvColor&&T.add(w.r.COLORFEATUREATTRIBUTE,"float"),C.add("vColor","vec4"),C.add("vpos","vec3");const S=e.multipassEnabled&&(e.output===o.V.Color||e.output===o.V.Alpha);S&&C.add("depth","float"),r.uniforms.add(new g.E("eColor",(e=>e.color)));const b=e.output===o.V.Depth;b&&(t.include(c.L,e),(0,i.xJ)(t),(0,i.Mu)(t)),r.code.add(v.H`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${e.hasVertexColors?"vColor *= eColor;":e.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${S?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${b?v.H`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:v.H`transformPosition(proj, view, vpos);`}
    }
  `),t.include(n.HQ,e),S&&t.include(h.Q,e),O.include(f.a);const x=e.output===o.V.Highlight;return x&&t.include(d.Qh,e),O.code.add(v.H`
  void main() {
    discardBySlice(vpos);
    ${S?"terrainDepthTest(depth);":""}
    vec4 fColor = vColor;

    ${e.output===o.V.ObjectAndLayerIdColor?v.H`fColor.a = 1.0;`:""}

    if (fColor.a < ${v.H.float(p.y)}) {
      discard;
    }

    ${e.output===o.V.Alpha?v.H`fragColor = vec4(fColor.a);`:""}

    ${e.output===o.V.Color?v.H`fragColor = highlightSlice(fColor, vpos); ${e.transparencyPassType===y.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
    ${x?v.H`outputHighlight();`:""};
    ${e.output===o.V.Depth?v.H`outputDepth(linearDepth);`:""};
    ${e.output===o.V.ObjectAndLayerIdColor?v.H`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const T=Object.freeze(Object.defineProperty({__proto__:null,build:O},Symbol.toStringTag,{value:"Module"}))},69726:(e,t,r)=>{r.d(t,{H:()=>M,b:()=>A,c:()=>P});var i=r(58680),o=r(78286),n=r(52712),s=r(55274),a=r(1110),l=r(33045),c=r(16917),d=r(97085),h=r(36985),u=r(3097),p=r(63269),f=r(34328),m=r(33448),g=r(89002),v=r(70224),_=r(6916),y=r(63592),w=r(54473),O=r(1411),T=r(35449),C=r(99152),S=r(4274),b=r(79856),x=r(81868),R=r(50645);function A(e){const t=new S.N5,r=e.signedDistanceFieldEnabled;if(t.include(d.Q,e),t.include(a.HQ,e),e.occlusionPass)return t.include(h.I,e),t;const{vertex:o,fragment:A}=t;t.include(_.Y6),A.include(v.W),A.include(g.a),t.include(f.A,e),t.include(l.g,e),t.include(u.y),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),t.varyings.add("voccluded","float"),o.uniforms.add(new O.E("viewport",((e,t)=>t.camera.fullViewport)),new w.G("screenOffset",((e,t)=>(0,i.s)(D,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio))),new w.G("anchorPosition",(e=>P(e))),new O.E("materialColor",(e=>e.color))),(0,y.Nz)(o),r&&(o.uniforms.add(new O.E("outlineColor",(e=>e.outlineColor))),A.uniforms.add(new O.E("outlineColor",(e=>E(e)?e.outlineColor:n.Z)),new T.m("outlineSize",(e=>E(e)?e.outlineSize:0)))),e.pixelSnappingEnabled&&o.include(c.K),e.hasScreenSizePerspective&&((0,_.pM)(o),(0,_.OH)(o)),e.debugDrawLabelBorder&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(R.r.UV0,"vec2"),t.attributes.add(R.r.COLOR,"vec4"),t.attributes.add(R.r.SIZE,"vec2"),t.attributes.add(R.r.FEATUREATTRIBUTE,"vec4"),o.code.add(C.H`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.hasScreenSizePerspective?C.H`
            inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
            vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:C.H`
            inputSize = size;
            vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(featureAttribute).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);
      bool visible = testHUDVisibility(posProj);
      voccluded = visible ? 0.0 : 1.0;
    `);const M=C.H`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,I=e.pixelSnappingEnabled?r?C.H`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:C.H`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:C.H`posProj += quadOffset;`;o.code.add(C.H`
    ${e.occlusionTestEnabled?"if (visible) {":""}
    ${M}
    ${e.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${e.output===s.V.ObjectAndLayerIdColor?C.H`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${C.H.float(m.y)};
    ${r?`alphaDiscard = alphaDiscard && outlineColor.a < ${C.H.float(m.y)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${I}
      gl_Position = posProj;
    }

    vtc = uv;

    ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${e.occlusionTestEnabled?C.H`} else { vtc = vec2(0.0);
      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),A.uniforms.add(new b.N("tex",(e=>e.texture)));const N=e.debugDrawLabelBorder?C.H`(isBorder > 0.0 ? 0.0 : ${C.H.float(m.H)})`:C.H.float(m.H),L=C.H`
    ${e.debugDrawLabelBorder?C.H`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${e.sampleSignedDistanceFieldTexelCenter?C.H`
      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;
      `:C.H`
      vec2 samplePos = vtc;
      `}

    ${r?C.H`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${N} ||
          fillPixelColor.a + outlinePixelColor.a < ${C.H.float(m.y)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        fragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${N}) {
          discard;
        }

        fragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:C.H`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${N}) {
            discard;
          }
          fragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?C.H`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;switch(e.output){case s.V.Color:A.code.add(C.H`
        void main() {
          ${L}
          ${e.transparencyPassType===x.y.FrontFace?"fragColor.rgb /= fragColor.a;":""}
        }`);break;case s.V.Alpha:A.code.add(C.H`
        void main() {
          ${L}
          fragColor = vec4(fragColor.a);
        }`);break;case s.V.ObjectAndLayerIdColor:A.code.add(C.H`
        void main() {
          ${L}
          outputObjectAndLayerIdColor();
        }`);break;case s.V.Highlight:A.constants.add("occludedHighlightFlag","vec4",p.U).add("unoccludedHighlightFlag","vec4",p.bO),A.code.add(C.H`
        void main() {
          ${L}
          if (voccluded == 1.0) {
            fragColor = occludedHighlightFlag;
          } else {
            fragColor = unoccludedHighlightFlag;
          }
        }`)}return t}function E(e){return e.outlineColor[3]>0&&e.outlineSize>0}function P(e,t=D){return e.textureIsSignedDistanceField?function(e,t,r){null!=t?(0,i.s)(r,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):(0,i.s)(r,0,0)}(e.anchorPosition,e.distanceFieldBoundingBox,t):(0,i.j)(t,e.anchorPosition),t}const D=(0,o.a)(),M=Object.freeze(Object.defineProperty({__proto__:null,build:A,calculateAnchorPosForRendering:P},Symbol.toStringTag,{value:"Module"}))},36004:(e,t,r)=>{r.d(t,{O:()=>d,a:()=>u,b:()=>h});var i=r(36572),o=r(16961),n=r(35449),s=r(3445),a=r(99152),l=r(4274),c=r(79856);class d extends a.Y{constructor(){super(...arguments),this.overlayIndex=i.vr.INNER,this.opacity=1}}function h(){const e=new l.N5;return e.include(o.c),e.fragment.uniforms.add(new c.N("tex",(e=>e.texture))),e.fragment.uniforms.add(new s.c("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new n.m("opacity",(e=>e.opacity))),e.fragment.code.add(a.H`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),e}const u=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:d,build:h},Symbol.toStringTag,{value:"Module"}))},50126:(e,t,r)=>{r.d(t,{R:()=>A,b:()=>R,r:()=>x});var i=r(40641),o=r(55274),n=r(1110),s=r(33045),a=r(56289),l=r(56178),c=r(6821),d=r(2119),h=r(80600),u=r(66579),p=r(33448),f=r(89002),m=r(63592),g=r(54473),v=r(1411),_=r(35449),y=r(99152),w=r(20778),O=r(4274),T=r(81868),C=r(50645),S=r(58376),b=r(16906);const x=1;function R(e){const t=new O.N5,{vertex:r,fragment:R}=t,A=e.multipassEnabled&&(e.output===o.V.Color||e.output===o.V.Alpha);t.include(u.p),t.include(a.s,e),t.include(c.q,e);const E=e.applyMarkerOffset&&!e.draped;E&&(r.uniforms.add(new _.m("markerScale",(e=>e.markerScale))),t.include(d.r,{space:S.lM.World,draped:!1})),e.output===o.V.Depth&&t.include(l.L,e),t.include(s.g,e),(0,m.NB)(r,e),r.uniforms.add(new w.X("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new g.G("nearFar",((e,t)=>t.camera.nearFar)),new _.m("miterLimit",(e=>"miter"!==e.join?0:e.miterLimit)),new v.E("viewport",((e,t)=>t.camera.fullViewport))),r.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(C.r.POSITION,"vec3"),t.attributes.add(C.r.SUBDIVISIONFACTOR,"float"),t.attributes.add(C.r.UV0,"vec2"),t.attributes.add(C.r.AUXPOS1,"vec3"),t.attributes.add(C.r.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),(0,i.Mu)(t),A&&t.varyings.add("depth","float");const P=e.stippleEnabled;P&&t.varyings.add("vLineSizeInv","float");const D=e.capType===b.x.ROUND,M=P||D;M&&t.varyings.add("vLineWidth","float");const I=e.innerColorEnabled||D;I&&t.varyings.add("vLineDistance","float");const N=e.stippleEnabled&&D,L=e.falloffEnabled||N;L&&t.varyings.add("vLineDistanceNorm","float"),D&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),r.code.add(y.H`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(y.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),(0,i.i$)(t),r.code.add(y.H`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${A?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),(0,m.Nz)(r),r.code.add(y.H`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${M?y.H`vLineWidth = lineWidth;`:""}
      ${P?y.H`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);
  `),E&&r.code.add(y.H`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),r.code.add(y.H`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(e.stippleEnabled||D)&&r.code.add(y.H`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${D?y.H`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.code.add(y.H`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?r.code.add(y.H`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?y.H`min(1.0, subdivisionFactor * ${y.H.float((x+2)/(x+1))})`:y.H`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):r.code.add(y.H`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const F=e.capType!==b.x.BUTT;return r.code.add(y.H`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${F?y.H`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.code.add(y.H`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${L||I?y.H`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${I?y.H`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${L?y.H`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),D&&r.code.add(y.H`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped?r.uniforms.add(new _.m("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):r.code.add(y.H`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(y.H`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?r.code.add(y.H`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.code.add(y.H`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new _.m("stipplePatternPixelSize",(e=>(0,c.h)(e)))),r.code.add(y.H`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),r.code.add(y.H`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),A&&t.include(h.Q,e),t.include(n.HQ,e),R.include(f.a),R.code.add(y.H`
  void main() {
    discardBySlice(vpos);
    ${A?"terrainDepthTest(depth);":""}
  `),e.wireframe?R.code.add(y.H`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(D&&R.code.add(y.H`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${y.H.float(p.y)}) {
        discard;
      }
    `),N?R.code.add(y.H`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${y.H.float(p.y)}, stippleCoverage);
      `):R.code.add(y.H`float stippleAlpha = getStippleAlpha();`),e.output!==o.V.ObjectAndLayerIdColor&&R.code.add(y.H`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),R.uniforms.add(new v.E("intrinsicColor",(e=>e.color))),R.code.add(y.H`vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&(R.uniforms.add(new v.E("innerColor",(e=>e.innerColor??e.color)),new _.m("innerWidth",((e,t)=>e.innerWidth*t.camera.pixelRatio))),R.code.add(y.H`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),R.code.add(y.H`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&(R.uniforms.add(new _.m("falloff",(e=>e.falloff))),R.code.add(y.H`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),R.code.add(y.H`
    ${e.output===o.V.ObjectAndLayerIdColor?y.H`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${y.H.float(p.y)}) {
      discard;
    }

    ${e.output===o.V.Alpha?y.H`fragColor = vec4(finalColor.a);`:""}
    ${e.output===o.V.Color?y.H`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===o.V.Color&&e.transparencyPassType===T.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${e.output===o.V.Highlight?y.H`fragColor = vec4(1.0);`:""}
    ${e.output===o.V.Depth?y.H`outputDepth(linearDepth);`:""}
    ${e.output===o.V.ObjectAndLayerIdColor?y.H`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const A=Object.freeze(Object.defineProperty({__proto__:null,build:R,ribbonlineNumRoundJoinSubdivisions:x},Symbol.toStringTag,{value:"Module"}))},52377:(e,t,r)=>{r.d(t,{T:()=>c,a:()=>h,b:()=>d});var i=r(52712),o=r(16961),n=r(1411),s=r(99152),a=r(4274),l=r(79856);class c extends s.Y{constructor(){super(...arguments),this.color=(0,i.f)(1,1,1,1)}}function d(){const e=new a.N5;return e.include(o.c),e.fragment.uniforms.add(new l.N("tex",(e=>e.texture)),new n.E("uColor",(e=>e.color))),e.fragment.code.add(s.H`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * uColor;
}`),e}const h=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:c,build:d},Symbol.toStringTag,{value:"Module"}))},33006:(e,t,r)=>{r.d(t,{W:()=>R,b:()=>x});var i=r(40641),o=r(55274),n=r(1110),s=r(66012),a=r(33045),l=r(63269),c=r(52636),d=r(696),h=r(80600),u=r(22455),p=r(39486),f=r(64062),m=r(65554),g=r(41679),v=r(33448),_=r(89002),y=r(63592),w=r(1411),O=r(35449),T=r(99152),C=r(4274),S=r(81868),b=r(50645);function x(e){const t=new C.N5,{vertex:r,fragment:x}=t;(0,y.NB)(r,e),t.include(s.d,e),t.attributes.add(b.r.POSITION,"vec3"),t.attributes.add(b.r.UV0,"vec2");const R=new w.E("waterColor",(e=>e.color));if(e.output===o.V.Color&&e.isDraped)return t.varyings.add("vpos","vec3"),r.uniforms.add(R),r.code.add(T.H`
        void main(void) {
          if (waterColor.a < ${T.H.float(v.y)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),x.uniforms.add(R),x.code.add(T.H`void main() {
fragColor = waterColor;
}`),t;switch(e.output!==o.V.Color&&e.output!==o.V.Alpha||(t.include(u.n,e),t.include(i.oD,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassEnabled&&t.varyings.add("depth","float"),r.uniforms.add(R),r.code.add(T.H`
      void main(void) {
        if (waterColor.a < ${T.H.float(v.y)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===o.V.Color?"forwardLinearDepth();":""}
      }
    `)),t.include(h.Q,e),e.output){case o.V.Alpha:t.include(n.HQ,e),x.uniforms.add(R),x.code.add(T.H`
        void main() {
          discardBySlice(vpos);
          ${e.multipassEnabled?"terrainDepthTest(depth);":""}

          fragColor = vec4(waterColor.a);
        }
      `);break;case o.V.Color:t.include(d.qU),t.include(c.W,{pbrMode:p.A9.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(g.V),t.include(n.HQ,e),t.include(f.Bz,e),t.include(m.E,e),x.uniforms.add(R,new O.m("timeElapsed",(e=>e.timeElapsed)),r.uniforms.get("view"),r.uniforms.get("localOrigin")),(0,y.yu)(x,e),x.include(_.a),(0,d.Gc)(x),(0,d.O4)(x),x.code.add(T.H`
      void main() {
        discardBySlice(vpos);
        ${e.multipassEnabled?"terrainDepthTest(depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?T.H`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        fragColor = delinearizeGamma(final);
        fragColor = highlightSlice(fragColor, vpos);
        ${e.transparencyPassType===S.y.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `);break;case o.V.Normal:t.include(u.n,e),t.include(g.V,e),t.include(n.HQ,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),r.uniforms.add(R),r.code.add(T.H`
        void main(void) {
          if (waterColor.a < ${T.H.float(v.y)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),x.uniforms.add(new O.m("timeElapsed",(e=>e.timeElapsed))),x.code.add(T.H`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
fragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case o.V.Highlight:t.include(l.Qh,e),t.varyings.add("vpos","vec3"),r.uniforms.add(R),r.code.add(T.H`
      void main(void) {
        if (waterColor.a < ${T.H.float(v.y)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(n.HQ,e),x.code.add(T.H`void main() {
discardBySlice(vpos);
outputHighlight();
}`);break;case o.V.ObjectAndLayerIdColor:t.include(a.g,e),t.varyings.add("vpos","vec3"),r.uniforms.add(R),r.code.add(T.H`
      void main(void) {
        if (waterColor.a < ${T.H.float(v.y)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
        forwardObjectAndLayerIdColor();
      }
    `),t.include(n.HQ,e),x.code.add(T.H`void main() {
discardBySlice(vpos);
outputObjectAndLayerIdColor();
}`)}return t}const R=Object.freeze(Object.defineProperty({__proto__:null,build:x},Symbol.toStringTag,{value:"Module"}))},80715:(e,t,r)=>{r.d(t,{O:()=>n});var i=r(22279),o=r(84119);function n(e,t,r){return(0,o.projectBuffer)(e,t,0,s,r.spatialReference,0,1)?(r.x=s[0],r.y=s[1],r.z=s[2],r):null}const s=(0,i.c)()},6214:(e,t,r)=>{r.d(t,{$e:()=>a,j1:()=>l,mO:()=>c,vt:()=>s});var i=r(92114),o=r(21839),n=r(32532);function s(e){return e?{ray:(0,n.vt)(e.ray),c0:e.c0,c1:e.c1}:{ray:(0,n.vt)(),c0:0,c1:Number.MAX_VALUE}}function a(e,t=s()){return(0,n.C)(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function l(e,t){return d(e,e.c0,t)}function c(e,t){return d(e,e.c1,t)}function d(e,t,r){return(0,o.g)(r,e.ray.origin,(0,o.i)(r,e.ray.direction,t))}new i.I((()=>s()))},94982:(e,t,r)=>{r.d(t,{C:()=>g,FB:()=>i,ig:()=>y,m7:()=>_,ui:()=>v,vt:()=>m});var i,o,n,s=r(92114),a=r(37046),l=r(21839),c=r(22279),d=r(25102),h=r(52712),u=r(6214),p=r(38774),f=r(45573);function m(e){return e?[(0,p.vt)(e[0]),(0,p.vt)(e[1]),(0,p.vt)(e[2]),(0,p.vt)(e[3]),(0,p.vt)(e[4]),(0,p.vt)(e[5])]:[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()]}function g(e,t){for(let r=0;r<w;r++)(0,p.C)(e[r],t[r]);return e}function v(e,t,r,n=C){const s=(0,a.m)(f.Rc.get(),t,e);(0,a.i)(s,s);for(let i=0;i<O;++i){const e=(0,d.t)(f.Km.get(),T[i],s);(0,l.s)(n[i],e[0]/e[3],e[1]/e[3],e[2]/e[3])}!function(e,t){(0,p.Cr)(t[o.FAR_BOTTOM_LEFT],t[o.NEAR_BOTTOM_LEFT],t[o.NEAR_TOP_LEFT],e[i.LEFT]),(0,p.Cr)(t[o.NEAR_BOTTOM_RIGHT],t[o.FAR_BOTTOM_RIGHT],t[o.FAR_TOP_RIGHT],e[i.RIGHT]),(0,p.Cr)(t[o.FAR_BOTTOM_LEFT],t[o.FAR_BOTTOM_RIGHT],t[o.NEAR_BOTTOM_RIGHT],e[i.BOTTOM]),(0,p.Cr)(t[o.NEAR_TOP_LEFT],t[o.NEAR_TOP_RIGHT],t[o.FAR_TOP_RIGHT],e[i.TOP]),(0,p.Cr)(t[o.NEAR_BOTTOM_LEFT],t[o.NEAR_BOTTOM_RIGHT],t[o.NEAR_TOP_RIGHT],e[i.NEAR]),(0,p.Cr)(t[o.FAR_BOTTOM_RIGHT],t[o.FAR_BOTTOM_LEFT],t[o.FAR_TOP_LEFT],e[i.FAR])}(r,n)}function _(e,t){for(let r=0;r<w;r++){const i=e[r];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0}function y(e,t){for(let r=0;r<w;r++){const i=e[r];if(!(0,p.b6)(i,t))return!1}return!0}(n=i||(i={}))[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR",function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(o||(o={}));o.FAR_BOTTOM_RIGHT,o.NEAR_BOTTOM_RIGHT,o.NEAR_BOTTOM_LEFT,o.FAR_BOTTOM_LEFT,o.NEAR_BOTTOM_LEFT,o.NEAR_BOTTOM_RIGHT,o.NEAR_TOP_RIGHT,o.NEAR_TOP_LEFT,o.FAR_BOTTOM_RIGHT,o.FAR_BOTTOM_LEFT,o.FAR_TOP_LEFT,o.FAR_TOP_RIGHT,o.NEAR_BOTTOM_RIGHT,o.FAR_BOTTOM_RIGHT,o.FAR_TOP_RIGHT,o.NEAR_TOP_RIGHT,o.FAR_BOTTOM_LEFT,o.NEAR_BOTTOM_LEFT,o.NEAR_TOP_LEFT,o.FAR_TOP_LEFT,o.FAR_TOP_LEFT,o.NEAR_TOP_LEFT,o.NEAR_TOP_RIGHT,o.FAR_TOP_RIGHT;const w=6,O=8,T=[(0,h.f)(-1,-1,-1,1),(0,h.f)(1,-1,-1,1),(0,h.f)(1,1,-1,1),(0,h.f)(-1,1,-1,1),(0,h.f)(-1,-1,1,1),(0,h.f)(1,-1,1,1),(0,h.f)(1,1,1,1),(0,h.f)(-1,1,1,1)],C=(new s.I(u.vt),[(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)()])},80009:(e,t,r)=>{function i(e){return"point"===e.type}r.d(t,{v:()=>i})},66386:(e,t,r)=>{var i,o;function n(e){return null!=e&&!e.running}r.d(t,{c:()=>o,c2:()=>i,pi:()=>n}),function(e){e[e.RENDERING=0]="RENDERING",e[e.FADING=1]="FADING",e[e.FINISHED=2]="FINISHED"}(i||(i={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(o||(o={}))},58718:(e,t,r)=>{r.d(t,{OQ:()=>i,ny:()=>f});var i,o=r(92504),n=r(37046),s=r(56192),a=r(21839),l=r(22279),c=r(69175),d=r(99817),h=r(66386),u=r(84323),p=r(40695);class f{constructor(){this.readChannels=h.c.RG,this.renderingStage=h.c2.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=(0,l.c)(),this.parallax=new m,this.parallaxNew=new m,this.pointOnGround=(0,l.c)(),this.fadeMode=i.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const t=this.parallax,r=(0,a.l)(e.eye);if(t.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-d.$O.radius*d.$O.radius,0))/r,(0,c.Cr)(g,t.anchorPointClouds,v),(0,n.k)(t.transform,s.I,v[3],(0,c.yo)(v)),this.fadeMode===i.CROSS_FADE){const e=this.parallaxNew;(0,c.Cr)(g,e.anchorPointClouds,v),(0,n.k)(e.transform,s.I,v[3],(0,c.yo)(v))}}updateFading(e,t,r,i){this.isFading&&this._advanceFading(r,i),this._evaluateFading(e,t,r)}_evaluateFading(e,t,r){const o=e.relativeElevation,n=this._calculateDistanceToAnchorPoint(e);if((o>1.7*u.ni||o<-u.ni||n>T)&&this.opacity>0)this._setFade(i.HIDE,r);else if(!this.isFading)if((o>u.ni||o<-.35*u.ni||n>O)&&this.opacity>0)this._setFade(i.FADE_OUT,r);else if(o<=u.ni&&o>=-.35*u.ni&&t===p.M.IDLE&&(0,h.pi)(this.data)){if(0===this.opacity)return void this._setFade(i.FADE_IN,r);(n>w||this.renderingStage===h.c2.FADING)&&this._setFade(i.CROSS_FADE,r)}}_advanceFading(e,t){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,t)}_advanceFadingFactorAndOpacity(e,t){if(this.fadeFactor<1)return this.fadeFactor=t?(0,o.qE)((e-this.startTime)/(y*t),0,1):1,this.fadeMode===i.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===i.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===i.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===i.FADE_OUT&&(this.opacity=0),this.fadeMode===i.FADE_IN&&(this.opacity=1),this.fadeMode===i.CROSS_FADE&&(this.opacity=1),this.fadeMode=i.NONE}_switchReadChannels(){const e=this.fadeMode===i.CROSS_FADE&&1===this.fadeFactor,t=this.fadeMode===i.FADE_IN&&0===this.fadeFactor;this.renderingStage===h.c2.FADING&&(e||t)&&(this.readChannels=1-this.readChannels,this.renderingStage=h.c2.FINISHED)}_calculateDistanceToAnchorPoint(e){return(0,a.n)(this.pointOnGround,e.eye),(0,a.i)(this.pointOnGround,this.pointOnGround,d.$O.radius),(0,a.l)((0,a.f)(_,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===i.CROSS_FADE&&(0===this.fadeFactor&&(0,a.c)(this.parallaxNew.anchorPointClouds,this.pointOnGround),1===this.fadeFactor&&(0,a.c)(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===i.FADE_IN&&0===this.fadeFactor&&(0,a.c)(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,t){switch(e){case i.HIDE:this.opacity=0;break;case i.FADE_OUT:this.opacity=1;break;case i.FADE_IN:this.opacity=0;break;case i.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=t}get isFading(){return this.fadeMode===i.FADE_OUT||this.fadeMode===i.FADE_IN||this.fadeMode===i.CROSS_FADE}}!function(e){e[e.NONE=0]="NONE",e[e.HIDE=1]="HIDE",e[e.FADE_OUT=2]="FADE_OUT",e[e.FADE_IN=3]="FADE_IN",e[e.CROSS_FADE=4]="CROSS_FADE"}(i||(i={}));class m{constructor(){this.anchorPointClouds=(0,l.c)(),this.radiusCurvatureCorrectionFactor=0,this.transform=(0,s.a)()}}const g=(0,l.f)(0,0,1),v=(0,c.vt)(),_=(0,l.c)(),y=1.25,w=34e3,O=64e3,T=2e5},84323:(e,t,r)=>{r.d(t,{k9:()=>S,ni:()=>C});var i,o=r(66866),n=r(21877),s=r(21564),a=(r(73446),r(85569),r(39831),r(28902)),l=r(63863);let c=i=class extends n.oY{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new i({cloudCover:this.cloudCover})}};(0,o._)([(0,a.e)({cloudy:"cloudy"})],c.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],c.prototype,"cloudCover",void 0),c=i=(0,o._)([(0,l.$)("esri.views.3d.environment.CloudyWeather")],c);const d=c;var h;let u=h=class extends n.oY{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new h({fogStrength:this.fogStrength})}};(0,o._)([(0,a.e)({foggy:"foggy"})],u.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],u.prototype,"fogStrength",void 0),u=h=(0,o._)([(0,l.$)("esri.views.3d.environment.FoggyWeather")],u);const p=u;var f;let m=f=class extends n.oY{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new f({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,o._)([(0,a.e)({rainy:"rainy"})],m.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],m.prototype,"cloudCover",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],m.prototype,"precipitation",void 0),m=f=(0,o._)([(0,l.$)("esri.views.3d.environment.RainyWeather")],m);const g=m;var v;let _=v=class extends n.oY{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new v({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,o._)([(0,a.e)({snowy:"snowy"})],_.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],_.prototype,"cloudCover",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],_.prototype,"precipitation",void 0),(0,o._)([(0,s.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],_.prototype,"snowCover",void 0),_=v=(0,o._)([(0,l.$)("esri.views.3d.environment.SnowyWeather")],_);const y=_;var w;let O=w=class extends n.oY{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new w({cloudCover:this.cloudCover})}};(0,o._)([(0,a.e)({sunny:"sunny"})],O.prototype,"type",void 0),(0,o._)([(0,s.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],O.prototype,"cloudCover",void 0),O=w=(0,o._)([(0,l.$)("esri.views.3d.environment.SunnyWeather")],O);const T={key:"type",base:O,typeMap:{sunny:O,cloudy:d,rainy:g,snowy:y,foggy:p}};Object.keys(T.typeMap);const C=1e4,S=1e5},58343:(e,t,r)=>{r.d(t,{F:()=>n});var i=r(97046),o=r(9104);class n{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=(0,i.Ao)(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const r=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?r:e+r}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return null!=r&&(t+=(0,o.g7)(r)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=(0,i.Tg)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,t,r){if(null==e)return void(this._featureExpressionInfoContext=null);const i=e?.arcade;i&&null!=t&&null!=r?(this._featureExpressionInfoContext=(0,o.o8)(e),(0,o.gf)(this._featureExpressionInfoContext,(0,o.VG)(i.modules,t,r))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new n;return null!=e&&t.setFromElevationInfo(e),t}}},27716:(e,t,r)=>{r.d(t,{I2:()=>m,Kf:()=>v,Uk:()=>y,au:()=>u,fe:()=>_,nG:()=>f,nu:()=>g,sE:()=>p,uw:()=>i});var i,o=r(37046),n=r(56192),s=r(22279),a=r(59538),l=r(84119),c=r(80009),d=r(54096),h=r(27054);function u(e,t,r,i,o,n,s,a,c,d,h){const u=w[h.mode];let p,f,m=0;if((0,l.projectBuffer)(e,t,r,i,c.spatialReference,o,a))return u.requiresAlignment(h)?(m=u.applyElevationAlignmentBuffer(i,o,n,s,a,c,d,h),p=n,f=s):(p=i,f=o),(0,l.projectBuffer)(p,c.spatialReference,f,n,d.spatialReference,s,a)?m:void 0}function p(e,t,r,i,o){const n=((0,c.v)(e)?e.z:(0,h.cN)(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":{const r=(0,h.R1)(t,e,"ground")??0;return o.verticalDistanceToGround=0,o.sampledElevation=r,void(o.z=r)}case"relative-to-ground":{const s=(0,h.R1)(t,e,"ground")??0,a=r.geometryZWithOffset(n,i);return o.verticalDistanceToGround=a,o.sampledElevation=s,void(o.z=a+s)}case"relative-to-scene":{const s=(0,h.R1)(t,e,"scene")??0,a=r.geometryZWithOffset(n,i);return o.verticalDistanceToGround=a,o.sampledElevation=s,void(o.z=a+s)}case"absolute-height":{const s=r.geometryZWithOffset(n,i),a=(0,h.R1)(t,e,"ground")??0;return o.verticalDistanceToGround=s-a,o.sampledElevation=a,void(o.z=s)}default:return void(o.z=0)}}function f(e,t,r,i){return p(e,t,r,i,T),T.z}function m(e,t,r){return null==t||null==r?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===r?e.staysOnTheGround:t===r||"on-the-ground"!==t&&"on-the-ground"!==r?i.UPDATE:e.onTheGroundChanged}function g(e){return"relative-to-ground"===e||"relative-to-scene"===e}function v(e){return"absolute-height"!==e}function _(e,t,r,i,n){p(t,r,n,i,T),(0,d.Ig)(e,T.verticalDistanceToGround);const s=T.sampledElevation,l=(0,o.h)(O,e.transformation);return C[0]=t.x,C[1]=t.y,C[2]=T.z,(0,a.l)(t.spatialReference,C,l,i.spatialReference)?e.transformation=l:console.warn("Could not locate symbol object properly, it might be misplaced"),s}class y{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}!function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"}(i||(i={}));const w={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,r,i,o,n,s,a){const l=a.calculateOffsetRenderUnits(s),c=a.featureExpressionInfoContext;t*=3,i*=3;for(let d=0;d<o;++d){const o=e[t],n=e[t+1],s=e[t+2];r[i]=o,r[i+1]=n,r[i+2]=null==c?s+l:l,t+=3,i+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return 0!==t||null!=r}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,o,n){let s=0;const a=n.spatialReference;t*=3,i*=3;for(let l=0;l<o;++l){const o=e[t],l=e[t+1],c=e[t+2],d=n.getElevation(o,l,c,a,"ground")??0;s+=d,r[i]=o,r[i+1]=l,r[i+2]=d,t+=3,i+=3}return s/o},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,r,i,o,n,s,a){let l=0;const c=a.calculateOffsetRenderUnits(s),d=a.featureExpressionInfoContext,h=n.spatialReference;t*=3,i*=3;for(let u=0;u<o;++u){const o=e[t],s=e[t+1],a=e[t+2],u=n.getElevation(o,s,a,h,"ground")??0;l+=u,r[i]=o,r[i+1]=s,r[i+2]=null==d?a+u+c:u+c,t+=3,i+=3}return l/o},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,r,i,o,n,s,a){let l=0;const c=a.calculateOffsetRenderUnits(s),d=a.featureExpressionInfoContext,h=n.spatialReference;t*=3,i*=3;for(let u=0;u<o;++u){const o=e[t],s=e[t+1],a=e[t+2],u=n.getElevation(o,s,a,h,"scene")??0;l+=u,r[i]=o,r[i+1]=s,r[i+2]=null==d?a+u+c:u+c,t+=3,i+=3}return l/o},requiresAlignment:()=>!0}},O=(0,n.a)(),T=new y,C=(0,s.c)()},9104:(e,t,r)=>{r.d(t,{KF:()=>f,MF:()=>p,VG:()=>d,g7:()=>u,gf:()=>h,o8:()=>l,q6:()=>c});var i=r(539),o=r(40189),n=r(85174),s=r(28965);const a=i.A.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function l(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function c(e,t,r,i){const n=e?.expression;if("string"!=typeof n)return null;const a=g(n);if(null!=a)return{cachedResult:a};const l=await(0,s.lw)();(0,o.Te)(r);const c=l.arcadeUtils,d=c.createSyntaxTree(n);return c.dependsOnView(d)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:c.createFunction(d),context:c.createExecContext(null,{sr:t}),modules:l}}}function d(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)}function h(e,t){if(null!=e&&!m(e)){if(!t||!e.arcade)return void a.errorOncePerTick("Arcade support required but not provided");const r=t;r._geometry&&(r._geometry=(0,n.wZ)(r._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function u(e){if(null!=e){if(m(e))return e.cachedResult;const t=e.arcade;let r=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof r&&(e.cachedResult=0,r=0),r}return 0}function p(e,t=!1){let r=e?.featureExpressionInfo;const i=r?.expression;return t||"0"===i||(r=null),r??null}const f={cachedResult:0};function m(e){return null!=e.cachedResult}function g(e){return"0"===e?0:null}},54096:(e,t,r)=>{r.d(t,{$2:()=>x,$C:()=>T,Hj:()=>S,Ig:()=>O,Mh:()=>b,W$:()=>v,pW:()=>C,t8:()=>w,vY:()=>R});var i=r(92976),o=r(37046),n=r(56192),s=r(22279),a=r(25102),l=r(52712),c=r(97303),d=r(4675),h=r(80510),u=r(23806),p=r(65319),f=r(29394),m=r(85174),g=r(50645);function v(e,t){if("point"===e.type)return y(e,t,!1);if((0,m.gr)(e))switch(e.type){case"extent":return y(e.center,t,!1);case"polygon":return y(e.centroid,t,!1);case"polyline":return y(_(e),t,!0);case"mesh":return y(e.origin,t,!1)}else switch(e.type){case"extent":return y(function(e){return(0,f.T)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),null!=e.zmin&&null!=e.zmax&&isFinite(e.zmin)&&isFinite(e.zmax)?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return y(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const r=(0,u.S8)(e.rings,!!e.hasZ);return(0,f.T)(r[0],r[1],r[2],e.spatialReference)}(e),t,!0);case"polyline":return y(_(e),t,!0)}}function _(e){const t=e.paths[0];if(!t||0===t.length)return null;const r=(0,p.$H)(t,(0,p.Yl)(t)/2);return(0,f.T)(r[0],r[1],r[2],e.spatialReference)}function y(e,t,r){const i=r?e:(0,m.EL)(e);return t&&e?(0,c.projectPoint)(e,i,t)?i:null:i}function w(e,t,r,i=0){if(e){t||(t=(0,h.vt)());const o=e;let n=.5*o.width*(r-1),s=.5*o.height*(r-1);return o.width<1e-7*o.height?n+=s/20:o.height<1e-7*o.width&&(s+=n/20),(0,a.s)(t,o.xmin-n-i,o.ymin-s-i,o.xmax+n+i,o.ymax+s+i),t}return null}function O(e,t){for(let r=0;r<e.geometries.length;++r){const i=e.geometries[r].getMutableAttribute(g.r.AUXPOS1);i&&i.data[3]!==t&&(i.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[r],g.r.AUXPOS1))}}function T(e,t,r=null){const i=(0,l.d)(l.O);return null!=e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),null!=t?i[3]=t:null!=e&&e.length>3&&(i[3]=e[3]),r&&(i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r),i}function C(e=s.O,t,r,i=1){const o=new Array(3);if(null==t||null==r)o[0]=1,o[1]=1,o[2]=1;else{let i,n=0;for(let s=2;s>=0;s--){const a=e[s];let l;const c=null!=a,d=0===s&&!i&&!c,h=r[s];"symbol-value"===a||d?l=0!==h?t[s]/h:1:c&&"proportional"!==a&&isFinite(a)&&(l=0!==h?a/h:1),null!=l&&(o[s]=l,i=l,n=Math.max(n,Math.abs(l)))}for(let e=2;e>=0;e--)null==o[e]?o[e]=i:0===o[e]&&(o[e]=.001*n)}for(let n=2;n>=0;n--)o[n]/=i;return(0,s.e)(o)}function S(e){return b(function(e){return null!=e.isPrimitive}(e)?[e.width,e.depth,e.height]:e)?null:"Symbol sizes may not be negative values"}function b(e){const t=e=>null==e||e>=0;return Array.isArray(e)?e.every(t):t(e)}function x(e,t,r,i=(0,n.a)()){return e&&(0,o.o)(i,i,-e/180*Math.PI),t&&(0,o.r)(i,i,t/180*Math.PI),r&&(0,o.n)(i,i,r/180*Math.PI),i}function R(e,t,r){if(null!=r.minDemResolution)return r.minDemResolution;const o=(0,i.GA)(t),n=(0,d.VL)(e)*o,s=(0,d.yr)(e)*o,a=(0,d.uJ)(e)*(t.isGeographic?1:o);return 0===n&&0===s&&0===a?r.minDemResolutionForPoints:.01*Math.max(n,s,a)}},56867:(e,t,r)=>{var i,o,n;r.d(t,{O7:()=>o,Om:()=>i,sv:()=>n}),function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(i||(i={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(o||(o={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(n||(n={}))},27054:(e,t,r)=>{r.d(t,{R1:()=>s,aY:()=>o,cN:()=>n});var i=r(80009);class o{constructor(e,t=null,r=0){this.array=e,this.spatialReference=t,this.offset=r}}function n(e){return"array"in e}function s(e,t,r="ground"){if((0,i.v)(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,r);if(n(t)){let i=t.offset;return e.getElevation(t.array[i++],t.array[i++],t.array[i]||0,t.spatialReference??e.spatialReference,r)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,r)}},15788:(e,t,r)=>{r.d(t,{U:()=>n});var i=r(41746),o=r(69955);function n(e,t=0){const r=e.stride;return Array.from(e.fields.keys()).map((i=>{const n=e.fields.get(i),a=n.constructor.ElementCount,l=s(n.constructor.ElementType),c=n.offset,d=!(!n.optional||!n.optional.glNormalized);return new o._(i,a,l,c,r,d,t)}))}function s(e){const t=a[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const a={u8:i.pe.UNSIGNED_BYTE,u16:i.pe.UNSIGNED_SHORT,u32:i.pe.UNSIGNED_INT,i8:i.pe.BYTE,i16:i.pe.SHORT,i32:i.pe.INT,f32:i.pe.FLOAT}},46684:(e,t,r)=>{r.d(t,{t:()=>v,z:()=>w});var i=r(58680),o=r(21839),n=r(22279),s=r(52712),a=r(47936),l=r(12943),c=r(90166),d=r(50961),h=r(42965),u=r(10714),p=r(70807),f=r(52997),m=r(59568),g=r(50645);function v(e,t,r=null){const n=[],v=t.mapPositions;!function(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:i}=e,o=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&i,n=r.length/3-(o?1:0),s=new Array(2*(n-1)),a=o?r.slice(0,-3):r;let l=0;for(let c=0;c<n-1;c++)s[l++]=c,s[l++]=c+1;t.push([g.r.POSITION,new p.n(a,s,3,o)])}(t,n);const w=n[0][1].data,O=n[0][1].indices.length,T=(0,h.EH)(O);return function(e,t,r){if(null!=e.attributeData.colorFeature)return;const i=e.attributeData.color;t.push([g.r.COLOR,new p.n(i??s.O,r,4)])}(t,n,T),function(e,t,r){null==e.attributeData.sizeFeature&&t.push([g.r.SIZE,new p.n([e.attributeData.size??1],r,1,!0)])}(t,n,T),function(e,t,r){e.attributeData.normal&&t.push([g.r.NORMAL,new p.n(e.attributeData.normal,r,3)])}(t,n,T),function(e,t,r){null!=e.attributeData.colorFeature&&t.push([g.r.COLORFEATUREATTRIBUTE,new p.n([e.attributeData.colorFeature],r,1,!0)])}(t,n,T),function(e,t,r){null!=e.attributeData.sizeFeature&&t.push([g.r.SIZEFEATUREATTRIBUTE,new p.n([e.attributeData.sizeFeature],r,1,!0)])}(t,n,T),function(e,t,r){null!=e.attributeData.opacityFeature&&t.push([g.r.OPACITYFEATUREATTRIBUTE,new p.n([e.attributeData.opacityFeature],r,1,!0)])}(t,n,T),function(e,t,r){if(null==e.overlayInfo||e.overlayInfo.renderCoordsHelper.viewingMode!==u.RT.Global||!e.overlayInfo.spatialReference.isGeographic)return;const n=(0,c.jh)(r.length),s=(0,a.tO)(e.overlayInfo.spatialReference);for(let i=0;i<n.length;i+=3)(0,l.RC)(r,i,n,i,s);const h=r.length/3,f=(0,d.oe)(h+1);let m=_,v=y,w=0,O=0;(0,o.s)(m,n[O++],n[O++],n[O++]),f[0]=0;for(let a=1;a<h+1;++a)a===h&&(O=0),(0,o.s)(v,n[O++],n[O++],n[O++]),w+=(0,i.p)(m,v),f[a]=w,[m,v]=[v,m];t.push([g.r.DISTANCETOSTART,new p.n(f,t[0][1].indices,1,!0)])}(t,n,w),new m.V(e,n,v,f.X.Line,r)}const _=(0,n.c)(),y=(0,n.c)();function w(e,t){if(null==e||0===e.length)return[];const r=[];return e.forEach((e=>{const i=e.length,o=(0,c.jh)(3*i);e.forEach(((e,t)=>{o[3*t]=e[0],o[3*t+1]=e[1],o[3*t+2]=e[2]}));const n={attributeData:{position:o,normal:t},removeDuplicateStartEnd:!1};r.push(n)})),r}},50980:(e,t,r)=>{r.d(t,{Cz:()=>o,DZ:()=>a,PV:()=>s,vO:()=>i});r(97213),r(41746),r(6940),r(45758);const i=64,o=i/2,n=o/5,s=i/n,a=.25},97213:(e,t,r)=>{r.d(t,{CN:()=>a,Q_:()=>s,ny:()=>l,sZ:()=>c});r(39831);var i=r(51859),o=r(28443),n=r(41746);const s=128,a=.5;function l(e){return"cross"===e||"x"===e}function c(e,t=s,r=t*a,i=0){const l=d(e,t,r,i);return new o.g(l,{mipmap:!1,wrap:{s:n.pF.CLAMP_TO_EDGE,t:n.pF.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}function d(e,t=s,r=t*a,i=0){switch(e){case"circle":default:return function(e,t){const r=e/2-.5;return m(e,p(r,r,t/2))}(t,r);case"square":return function(e,t){return h(e,t,!1)}(t,r);case"cross":return function(e,t,r=0){return u(e,t,!1,r)}(t,r,i);case"x":return function(e,t,r=0){return u(e,t,!0,r)}(t,r,i);case"kite":return function(e,t){return h(e,t,!0)}(t,r);case"triangle":return function(e,t){return m(e,f(e/2,t,t/2))}(t,r);case"arrow":return function(e,t){const r=t,i=t/2,o=e/2,n=.8*r,s=p(o,(e-t)/2-n,Math.sqrt(n*n+i*i)),a=f(o,r,i);return m(e,((e,t)=>Math.max(a(e,t),-s(e,t))))}(t,r)}}function h(e,t,r){return r&&(t/=Math.SQRT2),m(e,((i,o)=>{let n=i-.5*e+.25,s=.5*e-o-.75;if(r){const e=(n+s)/Math.SQRT2;s=(s-n)/Math.SQRT2,n=e}return Math.max(Math.abs(n),Math.abs(s))-.5*t}))}function u(e,t,r,i=0){t-=i,r&&(t*=Math.SQRT2);const o=.5*t;return m(e,((t,n)=>{let s,a=t-.5*e,l=.5*e-n-1;if(r){const e=(a+l)/Math.SQRT2;l=(l-a)/Math.SQRT2,a=e}return a=Math.abs(a),l=Math.abs(l),s=a>l?a>o?Math.sqrt((a-o)*(a-o)+l*l):l:l>o?Math.sqrt(a*a+(l-o)*(l-o)):a,s-=i/2,s}))}function p(e,t,r){return(i,o)=>{const n=i-e,s=o-t;return Math.sqrt(n*n+s*s)-r}}function f(e,t,r){const i=Math.sqrt(t*t+r*r);return(o,n)=>{const s=Math.abs(o-e)-r,a=n-e+t/2+.75,l=(t*s+r*a)/i,c=-a;return Math.max(l,c)}}function m(e,t){const r=new Uint8Array(4*e*e);for(let o=0;o<e;o++)for(let n=0;n<e;n++){const s=n+e*o;let a=t(n,o);a=a/e+.5,(0,i.U)(a,r,4*s)}return r}},4062:(e,t,r)=>{r.d(t,{A:()=>c,C:()=>l});var i=r(84119),o=r(90166),n=r(17566),s=r(27716),a=r(93471);function l(e,t,r,i){const a="polygon"===e.type?n.Wq.CCW_IS_HOLE:n.Wq.NONE,l="polygon"===e.type?e.rings:e.paths,{position:c,outlines:h}=(0,n.jp)(l,!!e.hasZ,a,e.spatialReference),u=(0,o.jh)(c.length),p=(0,s.au)(c,e.spatialReference,0,u,0,c,0,c.length/3,t,r,i),f=null!=p;return{lines:f?d(h,c,u):[],projectionSuccess:f,sampledElevation:p}}function c(e,t){const r="polygon"===e.type?n.Wq.CCW_IS_HOLE:n.Wq.NONE,o="polygon"===e.type?e.rings:e.paths,{position:s,outlines:l}=(0,n.jp)(o,!1,r),c=(0,i.projectBuffer)(s,e.spatialReference,0,s,t,0,s.length/3);for(let i=2;i<s.length;i+=3)s[i]=a.bi;return{lines:c?d(l,s):[],projectionSuccess:c}}function d(e,t,r=null){const i=new Array;for(const{index:n,count:s}of e){if(s<=1)continue;const e=3*n,a=3*s;i.push({position:(0,o.l5)(t,3*n,3*s),mapPositions:null!=r?(0,o.l5)(r,e,a):void 0})}return i}},93471:(e,t,r)=>{r.d(t,{bi:()=>sr});var i=r(66866),o=r(17306),n=r(82256),s=r(6267),a=r(63678),l=r(85251),c=r(76286),d=r(21564),h=(r(73446),r(85569)),u=r(39831),p=r(63863),f=r(37046),m=r(21839),g=r(22279),v=r(10714),_=r(56867),y=r(19620),w=r(36572),O=r(80510),T=r(32926);class C{constructor(){this._extent=(0,O.vt)(),this.resolution=0,this.renderLocalOrigin=(0,T.f)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new S}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,O.cY)(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,O.cY)(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,O.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class S{constructor(){this.extents=[(0,O.vt)(),(0,O.vt)(),(0,O.vt)()],this.numViews=0}}var b;!function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(b||(b={}));class x{constructor(e,t){this._fbos=e,this._format=t}get valid(){return null!=this._handle}dispose(){this._handle=(0,s.Gz)(this._handle)}get texture(){return this._handle?.colorTexture}bind(e,t,r){this._handle&&this._handle.fbo.width===t&&this._handle.fbo.height===r||(this._handle?.release(),this._handle=this._fbos.acquire(this._format,t,r)),e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.colorTexture?.descriptor?.hasMipmap&&this._handle?.colorTexture?.generateMipmap()}}var R=r(4588),A=r(55274);class E{constructor(e,t,r,i=R.NV.RGBA_MIPMAP){this.output=t,this.content=r,this.fbo=new x(e,i)}get valid(){return this.fbo.valid}}class P{constructor(e){this.targets=[new E(e,A.V.Color,b.Color),new E(e,A.V.Color,b.ColorNoRasterImage),new E(e,A.V.Highlight,b.Highlight,R.NV.RGBA4),new E(e,A.V.Normal,b.WaterNormal),new E(e,A.V.Color,b.Occluded)],(0,u.A)("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new E(e,A.V.ObjectAndLayerIdColor,b.ObjectAndLayerIdColor))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce(((e,t,r)=>t.valid?e|=1<<r:e),0)}}var D,M=r(52712),I=r(82089);I.Zo;!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(D||(D={}));r(696),r(39486),r(65554);var N=r(99198);r(57198);N.n;var L;r(35449),r(99152),r(79856);!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(L||(L={}));N.n;(0,M.c)();var F=r(52377),H=r(80912),V=r(69948);class z{constructor(e){this._context=e,this._perConstructorInstances=new H.O,this._frameCounter=0,this._keepAliveFrameCount=W}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=U){const r=t.key;let i=this._perConstructorInstances.get(e,r);if(null==i){const o=new e(this._context,t,(()=>this.release(o)));i=new j(o),this._perConstructorInstances.set(e,r,i)}return++i.refCount,i.technique}releaseAndAcquire(e,t,r){if(null!=r){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}release(e){if(null==e||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);null!=t&&(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==W&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,r)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,r))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{e.push((async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,r))})),await Promise.all(e)}}class j{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const W=-1,U=new V.K;var B=r(38931),G=r(36549),k=r(539),q=r(58947);class Z{constructor(e,t,r,i){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new H.O}dispose(){this._textureRepository.destroy()}acquire(e,t,r){if(this._ownMaterial(e),!e.produces(t,r))return null;let i=this._id2glMaterialRef.get(r,e.id);if(null==i){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRepository:this._textureRepository,output:r});i=new $(t),this._id2glMaterialRef.set(r,e.id,i)}return i.ref(),i.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);null!=r&&(r.unref(),r.referenced||((0,s.WD)(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&k.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class ${constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,q.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}var X=r(13148),Y=r(50645),Q=r(41746),J=r(69955);new J._(Y.r.POSITION,3,Q.pe.FLOAT,0,12),new J._(Y.r.POSITION,3,Q.pe.FLOAT,0,20),new J._(Y.r.UV0,2,Q.pe.FLOAT,12,20),new J._(Y.r.POSITION,3,Q.pe.FLOAT,0,32),new J._(Y.r.NORMAL,3,Q.pe.FLOAT,12,32),new J._(Y.r.UV0,2,Q.pe.FLOAT,24,32),new J._(Y.r.POSITION,3,Q.pe.FLOAT,0,16),new J._(Y.r.COLOR,4,Q.pe.UNSIGNED_BYTE,12,16),new J._(Y.r.POSITION,2,Q.pe.FLOAT,0,8),new J._(Y.r.POSITION,2,Q.pe.FLOAT,0,16),new J._(Y.r.UV0,2,Q.pe.FLOAT,8,16);var K=r(11459),ee=r(89423),te=r(6940),re=r(45758);var ie=r(24734),oe=r(45722),ne=(r(60882),r(56192)),se=r(78286),ae=r(58718),le=r(15354),ce=r(46823),de=r(80600),he=r(91013),ue=r(38323),pe=r(81868),fe=r(9409);class me{constructor(e,t){this.shadowMap=e,this.slicePlane=t,this.slot=ue.N.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=pe.y.NONE,this.alignPixelEnabled=!1,this.decorations=he.ID.ON,this.overlayStretch=1,this._camera=new G.i,this._inverseViewport=(0,se.a)(),this.oldLighting=new fe.T,this.newLighting=new fe.T,this._fadedLighting=new fe.T,this._lighting=this.newLighting,this.ssr=new ge,this.multipassEnabled=!1,this.multipassTerrain=new de.h,this.multipassGeometry=new ce.U,this.hudRenderStyle=le.D.Occluded,this.cloudsFade=new ae.ny}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:r}=this;e>=1?this._lighting=r:(this._fadedLighting.lerpLighting(t,r,e),this._lighting=this._fadedLighting)}}class ge{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,ne.a)()}}class ve{constructor(e,t,r=null){this.rctx=e,this.sliceHelper=r,this.lastFrameCamera=new G.i,this.output=A.V.Color,this.renderOccludedMask=_e,this.bindParameters=new me(t,null!=r?r.plane:null),this.bindParameters.alignPixelEnabled=!0}resetRenderOccludedMask(){this.renderOccludedMask=_e}}const _e=oe.m$.Occlude|oe.m$.OccludeAndTransparent|oe.m$.OccludeAndTransparentStencil;var ye=r(92504),we=r(76287),Oe=r(58680),Te=r(25102);let Ce=class extends G.i{constructor(){super(...arguments),this._projectionMatrix=(0,ne.a)()}get projectionMatrix(){return this._projectionMatrix}};(0,i._)([(0,d.MZ)()],Ce.prototype,"_projectionMatrix",void 0),(0,i._)([(0,d.MZ)({readOnly:!0})],Ce.prototype,"projectionMatrix",null),Ce=(0,i._)([(0,p.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],Ce);var Se,be=r(84147);!function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"}(Se||(Se={}));class xe{constructor(){this.camera=new Ce,this.lightMat=(0,ne.a)()}}class Re{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class Ae{get depthTexture(){return this._handle?.colorTexture}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,Te.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,t){this._fbos=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Re,this._projectionView=(0,ne.a)(),this._projectionViewInverse=(0,ne.a)(),this._modelViewLight=(0,ne.a)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,M.c)(),this._cascades=[new xe,new xe,new xe,new xe],this._lastOrigin=null,this._maxTextureWidth=Math.min((0,u.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._handle=(0,s.Gz)(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=(0,ye.qE)(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)Ve[e]=this._cascades[e];return Ve.length=this._numCascades,Ve}start(e,t,r,i,o){(0,q.vA)(this.enabled);const{near:n,far:s}=this._clampNearFar(r);this._computeCascadeDistances(n,s,i),this._textureHeight=this._computeTextureHeight(e,o,i),this._setupMatrices(e,t);const{viewMatrix:a,projectionMatrix:l}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,l,a,t);this._lastOrigin=null,this.clear()}finish(){(0,q.vA)(this.enabled),this._handle?.releaseDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!(0,m.h)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,g.c)(),(0,m.c)(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){(0,f.w)(ze,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)je[16*t+e]=ze[e]}}return je}moveSnapshot(e){(0,q.vA)(this.enabled),this._handle?.releaseDepth(),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle=null}copySnapshot(e){const t=this._handle?.colorTexture?.descriptor;if(!this.enabled||!t)return;this._snapshots[e]?.release();const{width:r,height:i}=t;this._snapshots[e]=this._fbos.acquire(R.NV.RGBA4,r,i);const o=this._fbos.rctx;this._bindFbo();const n=o.bindTexture(this._snapshots[e]?.colorTexture,te.g.TEXTURE_UNIT_FOR_UPDATES);o.gl.copyTexSubImage2D(Q.Ap.TEXTURE_2D,0,0,0,0,0,r,i),o.bindTexture(n,te.g.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){return this.enabled?this._snapshots[e]?.colorTexture:null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Q.hn.COLOR_BUFFER_BIT|Q.hn.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,t,r){const i=Math.min(window.devicePixelRatio,t)/e.pixelRatio,o=r?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,n=(0,be.Mv)(Math.floor(Math.max(e.fullWidth,e.fullHeight)*i*o));return Math.min(this._maxTextureWidth,this._numCascades*n)/this._numCascades}_ensureFbo(){this._handle?.fbo.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._fbos.acquire(R.NV.RGBA4,this._textureWidth,this._textureHeight)),this._handle.acquireDepth(R.zd.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=(0,s.Gz)(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,r,i){const o=this._cascades[e],n=-this._cascadeDistances[e],s=-this._cascadeDistances[e+1],a=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),l=(t[10]*s+t[14])/Math.abs(t[11]*s+t[15]);(0,q.vA)(a<l);for(let u=0;u<8;++u){(0,Te.s)(Pe,u%4==0||u%4==3?-1:1,u%4==0||u%4==1?-1:1,u<4?a:l,1);const e=De[u];(0,Te.t)(e,Pe,this._projectionViewInverse),e[0]/=e[3],e[1]/=e[3],e[2]/=e[3]}(0,m.E)(He,De[0]),o.camera.viewMatrix=(0,f.w)(Ee,this._modelViewLight,He);for(let u=0;u<8;++u)(0,m.e)(De[u],De[u],o.camera.viewMatrix);let c=De[0][2],d=De[0][2];for(let u=1;u<8;++u)c=Math.min(c,De[u][2]),d=Math.max(d,De[u][2]);c-=200,d+=200,o.camera.near=-d,o.camera.far=-c,function(e,t,r,i,o){const n=1/De[0][3],s=1/De[4][3];(0,q.vA)(n<s);let a=n+Math.sqrt(n*s);const l=Math.sin((0,ye.XM)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));a/=l,function(e,t,r,i,o,n,s,a){(0,Oe.s)(We,0,0);for(let O=0;O<4;++O)(0,Oe.i)(We,We,e[O]);(0,Oe.a)(We,We,.25),(0,Oe.s)(Ue,0,0);for(let O=4;O<8;++O)(0,Oe.i)(Ue,Ue,e[O]);(0,Oe.a)(Ue,Ue,.25),(0,Oe.l)(Be[0],e[4],e[5],.5),(0,Oe.l)(Be[1],e[5],e[6],.5),(0,Oe.l)(Be[2],e[6],e[7],.5),(0,Oe.l)(Be[3],e[7],e[4],.5);let l=0,c=(0,Oe.k)(Be[0],We);for(let O=1;O<4;++O){const e=(0,Oe.k)(Be[O],We);e<c&&(c=e,l=O)}(0,Oe.c)(Ge,Be[l],e[l+4]);const d=Ge[0];let h,u;Ge[0]=-Ge[1],Ge[1]=d,(0,Oe.c)(ke,Ue,We),(0,Oe.g)(ke,Ge)<0&&(0,Oe.n)(Ge,Ge),(0,Oe.l)(Ge,Ge,ke,r),(0,Oe.e)(Ge,Ge),h=u=(0,Oe.g)((0,Oe.c)(qe,e[0],We),Ge);for(let O=1;O<8;++O){const t=(0,Oe.g)((0,Oe.c)(qe,e[O],We),Ge);t<h?h=t:t>u&&(u=t)}(0,Oe.j)(i,We),(0,Oe.a)(qe,Ge,h-t),(0,Oe.i)(i,i,qe);let p=-1,f=1,m=0,g=0;for(let O=0;O<8;++O){(0,Oe.c)(Ze,e[O],i),(0,Oe.e)(Ze,Ze);const t=Ge[0]*Ze[1]-Ge[1]*Ze[0];t>0?t>p&&(p=t,m=O):t<f&&(f=t,g=O)}(0,q.MX)(p>0,"leftArea"),(0,q.MX)(f<0,"rightArea"),(0,Oe.a)($e,Ge,h),(0,Oe.i)($e,$e,We),(0,Oe.a)(Xe,Ge,u),(0,Oe.i)(Xe,Xe,We),Ye[0]=-Ge[1],Ye[1]=Ge[0];const v=(0,q.L)(i,e[g],Xe,(0,Oe.i)(qe,Xe,Ye),1,o),_=(0,q.L)(i,e[m],Xe,qe,1,n),y=(0,q.L)(i,e[m],$e,(0,Oe.i)(qe,$e,Ye),1,s),w=(0,q.L)(i,e[g],$e,qe,1,a);(0,q.MX)(v,"rayRay"),(0,q.MX)(_,"rayRay"),(0,q.MX)(y,"rayRay"),(0,q.MX)(w,"rayRay")}(De,a,l,Me,Ie,Ne,Le,Fe),function(e,t,r,i,o){(0,Oe.c)(et,r,i),(0,Oe.a)(et,et,.5),tt[0]=et[0],tt[1]=et[1],tt[2]=0,tt[3]=et[1],tt[4]=-et[0],tt[5]=0,tt[6]=et[0]*et[0]+et[1]*et[1],tt[7]=et[0]*et[1]-et[1]*et[0],tt[8]=1,tt[Qe(0,2)]=-(0,Oe.g)(Ke(tt,0),e),tt[Qe(1,2)]=-(0,Oe.g)(Ke(tt,1),e);let n=(0,Oe.g)(Ke(tt,0),r)+tt[Qe(0,2)],s=(0,Oe.g)(Ke(tt,1),r)+tt[Qe(1,2)],a=(0,Oe.g)(Ke(tt,0),i)+tt[Qe(0,2)],l=(0,Oe.g)(Ke(tt,1),i)+tt[Qe(1,2)];n=-(n+a)/(s+l),tt[Qe(0,0)]+=tt[Qe(1,0)]*n,tt[Qe(0,1)]+=tt[Qe(1,1)]*n,tt[Qe(0,2)]+=tt[Qe(1,2)]*n,n=1/((0,Oe.g)(Ke(tt,0),r)+tt[Qe(0,2)]),s=1/((0,Oe.g)(Ke(tt,1),r)+tt[Qe(1,2)]),tt[Qe(0,0)]*=n,tt[Qe(0,1)]*=n,tt[Qe(0,2)]*=n,tt[Qe(1,0)]*=s,tt[Qe(1,1)]*=s,tt[Qe(1,2)]*=s,tt[Qe(2,0)]=tt[Qe(1,0)],tt[Qe(2,1)]=tt[Qe(1,1)],tt[Qe(2,2)]=tt[Qe(1,2)],tt[Qe(1,2)]+=1,n=(0,Oe.g)(Ke(tt,1),t)+tt[Qe(1,2)],s=(0,Oe.g)(Ke(tt,2),t)+tt[Qe(2,2)],a=(0,Oe.g)(Ke(tt,1),r)+tt[Qe(1,2)],l=(0,Oe.g)(Ke(tt,2),r)+tt[Qe(2,2)],n=-.5*(n/s+a/l),tt[Qe(1,0)]+=tt[Qe(2,0)]*n,tt[Qe(1,1)]+=tt[Qe(2,1)]*n,tt[Qe(1,2)]+=tt[Qe(2,2)]*n,n=(0,Oe.g)(Ke(tt,1),t)+tt[Qe(1,2)],s=(0,Oe.g)(Ke(tt,2),t)+tt[Qe(2,2)],a=-s/n,tt[Qe(1,0)]*=a,tt[Qe(1,1)]*=a,tt[Qe(1,2)]*=a,o[0]=tt[0],o[1]=tt[1],o[2]=0,o[3]=tt[2],o[4]=tt[3],o[5]=tt[4],o[6]=0,o[7]=tt[5],o[8]=0,o[9]=0,o[10]=1,o[11]=0,o[12]=tt[6],o[13]=tt[7],o[14]=0,o[15]=tt[8]}(Me,Ie,Le,Fe,o.projectionMatrix),o.projectionMatrix[10]=2/(r-i),o.projectionMatrix[14]=-(r+i)/(r-i)}(r,i,c,d,o.camera),(0,f.m)(o.lightMat,o.camera.projectionMatrix,o.camera.viewMatrix);const h=this._textureHeight;o.camera.viewport=[e*h,0,h,h]}_setupMatrices(e,t){(0,f.m)(this._projectionView,e.projectionMatrix,e.viewMatrix),(0,f.i)(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===v.RT.Global?e.eye:(0,m.s)(He,0,0,1);(0,f.u)(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_clampNearFar(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}_computeCascadeDistances(e,t,r){const i=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,q.kL)(t/e,4)),i);const o=(t-e)/this._numCascades,n=(t/e)**(1/this._numCascades);let s=e,a=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=(0,ye.Cc)(s,a,this.settings.splitSchemeLambda),s*=n,a+=o}get test(){return{cascades:this._cascades,textureHeight:this._textureHeight}}}const Ee=(0,ne.a)(),Pe=(0,M.c)(),De=[];for(let lr=0;lr<8;++lr)De.push((0,M.c)());const Me=(0,se.a)(),Ie=(0,se.a)(),Ne=(0,se.a)(),Le=(0,se.a)(),Fe=(0,se.a)(),He=(0,g.c)(),Ve=[],ze=(0,ne.a)(),je=ne.I.concat(ne.I,ne.I,ne.I,ne.I),We=(0,se.a)(),Ue=(0,se.a)(),Be=[(0,se.a)(),(0,se.a)(),(0,se.a)(),(0,se.a)()],Ge=(0,se.a)(),ke=(0,se.a)(),qe=(0,se.a)(),Ze=(0,se.a)(),$e=(0,se.a)(),Xe=(0,se.a)(),Ye=(0,se.a)();function Qe(e,t){return 3*t+e}const Je=(0,se.a)();function Ke(e,t){return(0,Oe.s)(Je,e[t],e[t+3]),Je}const et=(0,se.a)(),tt=(0,we.a)();var rt=r(52495),it=r(44912),ot=r(9286);r(99730);class nt extends ot.R6{constructor(e,t,r){super(e,t),this.triangleNr=r}}class st{constructor(){this.adds=new a.A,this.removes=new a.A,this.updates=new a.A({allocator:e=>e||new at,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class at{}class lt{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var ct=r(74515),dt=r(23183);function ht(e){return e.geometry.indexCount>=1}var ut=r(15788),pt=r(72136);class ft extends I.gy{constructor(e=(0,g.c)()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}var mt=r(42649);class gt{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function vt(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let r=!0;for(;r;)r=!1,e.forEach((i=>{const o=t.get(i.to);o&&(i.to=o.to,t.delete(o.from),e.removeUnordered(o),r=!0)}))}class _t extends gt{constructor(e,t,r){super(t,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return null!=this.geometry.highlights&&this.isVisible}get hasOccludees(){return null!=this.geometry.occludees}}class yt{constructor(){this.first=0,this.count=0}}class wt{constructor(){this._numElements=0,this._instances=new Map,this.holes=new a.A({allocator:e=>e||new gt,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=Ot(),this.drawCommandsHighlight=Ot(),this.drawCommandsOccludees=Ot(),this.drawCommandsShadowHighlightRest=Ot()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,r){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,i.from=t,i.to=r,this._numElements+=i.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),r=this.holes.front();return null!=this.vao&&1===this.holes.length&&r.to===Math.floor(this.vao.byteSize/e)?(t.first=0,void(t.count=r.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const r of t)r.isVisible&&(Tt(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r),Tt(r.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,r))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function Ot(){return new a.A({allocator:e=>e||new yt,deallocator:e=>e})}function Tt(e,t){const r=e.back();if(null==r){const r=e.pushNew();return r.first=t.from,void(r.count=t.numElements)}if(function(e,t){return e.first+e.count>=t.from}(r,t)){const e=t.from-r.first+t.numElements;r.count=e}else{const r=e.pushNew();r.first=t.from,r.count=t.numElements}}class Ct{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}var St=r(40210),bt=r(6660);const xt=St.Xs+1;class Rt{constructor(e,t,r){this._rctx=e,this._locations=t,this._layout=r,this._cache=new bt.I(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const t=e.toString();let r=this._cache.pop(t);return r||(r=new K.Z(this._rctx,this._locations,{geometry:this._layout},{geometry:ee.g.createVertex(this._rctx,Q._U.STATIC_DRAW)}),r.vertexBuffers.geometry.setSize(e),r)}deleteVao(e){if(null==e)return;const t=e.byteSize.toString();this._cache.put(t,e,xt)}}let At=class extends B.Ot{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this.priority=0,this.produces=new Map}dispose(){this._glMaterials=(0,s.WD)(this._glMaterials),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache=(0,s.WD)(this._vaoCache)}initializeRenderContext(e,t){const{rctx:r}=e.renderContext;this._glMaterials=new pt.c(this.material,t??e.materialRepository),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new Rt(r,this.material.vertexAttributeLocations,(0,ut.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof mt.Z}get isDecoration(){return this.material.parameters.isDecoration}get rendersOccluded(){return!this.isEmpty&&this.material.parameters.renderOccluded!==oe.m$.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.vao.usedMemory),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(null===t)return;const r=t.vertexBufferLayout.stride/4;for(const i of e){const e=i.renderGeometry,o=this._dataByOrigin.get(e.localOrigin.id),n=o?.findBuffer(e.id);if(null==n)return;const s=n.instances.get(e.id);if(i.updateType&(dt.k.GEOMETRY|dt.k.TRANSFORMATION)){const i=Wt(t.elementCount(s.geometry.geometry)*r),o=t.vertexBufferLayout.createView(i.buffer);this._writeGeometry(e,o,0),n.vao.vertexBuffers.geometry.setSubData(i,s.from*r,0,s.numElements*r)}i.updateType&(dt.k.HIGHLIGHT|dt.k.OCCLUDEE|dt.k.VISIBILITY)&&(n.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new H.O;for(const i of e){const e=i.localOrigin;if(null==e)continue;let t=r.get(e.id,null);null==t&&(t=new Et(e.vec3),r.set(e.id,null,t)),t.changes.push(i)}for(const i of t){const e=i.localOrigin;if(null==e)continue;const t=this._dataByOrigin.get(e.id),o=t?.findBuffer(i.id);if(null==o)continue;let n=r.get(e.id,o);null==n&&(n=new Et(e.vec3),r.set(e.id,o,n)),n.changes.push(i)}return r}_addAndRemoveGeometries(e,t){if(null===this._bufferWriter||null===this._vaoCache)return;const{_bufferWriter:r,_dataByOrigin:i}=this,o=r.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach(((e,t)=>{const s=e.get(null),a=null!=s?s.changes:[];n.delete(t,null);let l=i.get(t);if(e.forEach(((e,s)=>{if(n.delete(t,s),null==s)return void(0,q.vA)(!1,"No VAO for removed geometries");if(s.instances.size===e.changes.length)return this._vaoCache.deleteVao(s.vao),(0,h.Xy)(l.buffers,s),void(0===l.buffers.length&&0===a.length&&i.delete(t));const c=s.numElements,d=s.vao.byteSize/4,u=a.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),p=e.changes.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),f=Math.min((c+u-p)*o,zt),m=f>d;f>Lt&&f<d/2?(e.changes.forEach((({id:e})=>s.deleteInstance(e))),s.instances.forEach((({geometry:e})=>a.push(e))),this._vaoCache.deleteVao(s.vao),(0,h.Xy)(l.buffers,s)):m?this._applyAndRebuild(s,a,e):this._applyRemoves(s,e)})),a.length>0)for(null==l&&(l=new Ct(s.origin),i.set(t,l)),l.buffers.forEach((e=>this._applyAdds(e,a)));a.length>0;)l.buffers.push(this._applyAndRebuild(new wt,a,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,n.Bs)(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,r){if(null!=r)for(const p of r.changes)e.deleteInstance(p.id);const i=this._bufferWriter,o=i.vertexBufferLayout.stride,n=o/4,s=Math.floor(zt/n);let a=e.numElements;for(;t.length>0;){const r=t.pop(),o=i.elementCount(r.geometry);if(a+o>s&&a>0){t.push(r);break}a+=o;const n=new _t(r,0,0);(0,q.vA)(null==e.instances.get(r.id)),e.addInstance(r.id,n)}const l=a*n,c=Wt(l),d=i.vertexBufferLayout.createView(c.buffer);let h=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,r)=>{this._writeGeometry(t.geometry,d,h);const o=h;h+=i.elementCount(t.geometry.geometry),e.updateInstance(r,o,h),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Ut(l)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,h*n),e.holes.clear();const u=e.holes.pushNew();return u.from=h,u.to=Math.floor(e.vao.byteSize/o),e.updateDrawCommands(o),e}_applyRemoves(e,t){if(0===t.changes.length||null===this._bufferWriter)return;for(const s of t.changes){const t=s.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const i=Nt.back();if(i){if(i.to===r.from){i.to=r.to;continue}if(i.from===r.to){i.from=r.from;continue}}const o=Nt.pushNew();o.from=r.from,o.to=r.to}vt(Nt);const r=this._bufferWriter.vertexBufferLayout.stride/4,i=Nt.reduce(((e,t)=>Math.max(e,t.numElements)),0)*r,o=Wt(i);o.fill(0,0,i);const n=e.vao.vertexBuffers.geometry;Nt.forAll((e=>n.setSubData(o,e.from*r,0,e.numElements*r))),e.holes.pushArray(Nt.data,Nt.length),Nt.forAll(((e,t)=>Nt.data[t]=null)),Nt.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length||null===this._bufferWriter)return;if(!function(e){return null!=e.vao}(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,o=e.numElements,n=t.reduce(((e,t)=>e+r.elementCount(t.geometry)),0),s=Math.min((o+n)*i,zt),a=4*s;if(e.vao.byteSize<Ut(zt-Lt)&&a>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);vt(e.holes);const l=new Array;for(const h of t){const t=r.elementCount(h.geometry),i=Pt(e.holes,t);l.push(i)}const c=e.vao.vertexBuffers.geometry;let d=0,u=0,p=0;const f=Wt(s),m=r.vertexBufferLayout.createView(f.buffer);t.forEach(((t,o)=>{const n=l[o];if(null==n)return;if(p!==n){const e=p-u;e>0&&c.setSubData(f,u*i,0,e*i),u=n,d=0}const s=r.elementCount(t.geometry);this._writeGeometry(t,m,d),d+=s,p=n+s;const a=new _t(t,n,n+s);(0,q.vA)(null==e.instances.get(t.id)),e.addInstance(t.id,a),e.drawCommandsDirty=!0}));const g=p-u;g>0&&c.setSubData(f,u*i,0,g*i),(0,h.$i)(t,((e,t)=>null==l[t]))}_writeGeometry(e,t,r){if(null===this._bufferWriter)return;const i=e.localOrigin.vec3;(0,q.M_)(Dt,-i[0],-i[1],-i[2]);const o=(0,f.m)(Mt,Dt,e.transformation);(0,f.i)(It,o),(0,f.t)(It,It),this._bufferWriter.write(o,It,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:r}=e;if(!this.material.produces(r.slot,t))return null;const i=t===A.V.Highlight||t===A.V.ShadowHighlight;if(i&&!this._hasHighlights)return null;const o=t===A.V.ShadowExcludeHighlight,n=!(i||o);for(const s of this._dataByOrigin.values())for(const a of s.buffers){if(i&&!a.hasHighlights)continue;const s=(i?a.drawCommandsHighlight:o&&a.needsMultipleCommands()?a.drawCommandsShadowHighlightRest:a.drawCommandsDefault)||null,l=n&&a.drawCommandsOccludees||null;if(s?.length||l?.length){const i=this._glMaterials.load(e.rctx,r.slot,t),o=null!=i?i.beginSlot(r):null;if(null!=o)return o}}return null}renderNode(e,t){const{output:r,bindParameters:i}=e,o=r===A.V.Highlight||r===A.V.ShadowHighlight,n=r===A.V.ShadowExcludeHighlight,s=!(o||n),a=e.rctx,l=e.bindParameters.slot===ue.N.OCCLUDER_MATERIAL,c=e.bindParameters.slot===ue.N.TRANSPARENT_OCCLUDER_MATERIAL;a.runAppleAmdDriverHelper(),a.bindTechnique(t,this.material.parameters,i);for(const d of this._dataByOrigin.values())for(const e of d.buffers){if(o&&!e.hasHighlights)continue;const r=(o?e.drawCommandsHighlight:n&&e.needsMultipleCommands()?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,h=s&&e.drawCommandsOccludees||null;(r?.length||h?.length)&&(t.program.bindDraw(new ft(d.origin),i,this.material.parameters),t.ensureAttributeLocations(e.vao),a.bindVAO(e.vao),r?.length&&(a.setPipelineState(t.getPipeline(!1,l,c)),r.forAll((e=>a.drawArrays(t.primitiveType,e.first,e.count)))),h?.length&&(a.setPipelineState(t.getPipeline(!0,l,c)),h.forAll((e=>a.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}};(0,i._)([(0,d.MZ)({constructOnly:!0})],At.prototype,"material",void 0),At=(0,i._)([(0,p.$)("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],At);class Et{constructor(e){this.origin=e,this.changes=new Array}}function Pt(e,t){let r;if(!e.some((e=>!(e.numElements<t||(r=e,0)))))return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const Dt=(0,ne.a)(),Mt=(0,ne.a)(),It=(0,ne.a)(),Nt=new a.A({allocator:e=>e||new gt,deallocator:null}),Lt=65536,Ft=4*Lt,Ht=1024,Vt=16777216,zt=Vt/4;let jt=new Float32Array(Lt);function Wt(e){return jt.length<e&&(jt=new Float32Array(e)),jt}function Ut(e){const t=4*e;return t<=Ht?Ht:t<Ft?(0,ye.cU)(t):Math.max(Math.min(Math.ceil(1.5*t/Ft)*Ft,Vt),t)}let Bt=class extends rt.A{constructor(e){super(e),this._pending=new Gt,this._changes=new st,this._materialRenderers=new a.A,this._sortedMaterialRenderers=new a.A,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forAll((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._materialRenderers.some((e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.length&&0===this._geometries.size}getMemoryForMaterial(e){if(null==e)return 0;const t=this._materialRenderers.find((t=>t.material===e));return t?.usedMemory??0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,r=e=>{let r=t.get(e);return r||(r=new lt,t.set(e,r)),r};return e.removes.forAll((e=>{ht(e)&&r(e.material).removes.push(e)})),e.adds.forAll((e=>{ht(e)&&r(e.material).adds.push(e)})),e.updates.forAll((e=>{ht(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1,r=!1,i=!1;return e.forEach(((e,o)=>{let n=this._materialRenderers.find((e=>e.material===o));if(!n&&e.adds.length>0){const e=new At({material:o});e.initializeRenderContext(this.rendererContext.pluginContext,this._materialRepository),n=e,this._materialRenderers.push(n),t=!0,r=!0,i=!0}if(!n)return;const s=r||n.hasHighlights,a=i||n.hasWater;n.modify(e),r=r||s!==n.hasHighlights,i=i||a!==n.hasWater,n.isEmpty&&(this._materialRenderers.removeUnordered(n),n.dispose(),t=!0)})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),r&&(this._hasHighlights=this._materialRenderers.some((e=>e.hasHighlights))),i&&(this._hasWater=this._materialRenderers.some((e=>e.hasWater))),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const r=this._validateRenderGeometries(e);for(const o of r)this._geometries.set(o.id,o);const i=this._pending.empty;for(const o of r)this._pending.adds.add(o);i&&this.notifyChange("updating"),t===dt.q.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,i=this._pending.adds;for(const o of e)i.has(o)?(this._pending.removed.add(o),i.delete(o)):this._pending.removed.has(o)||this._pending.removes.add(o),this._geometries.delete(o.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===dt.q.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=0===this._changes.updates.length;for(const i of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(i),e.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case dt.k.TRANSFORMATION:case dt.k.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case dt.k.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((r=>t=r.updateAnimation(e)||t)),t}shouldRender(e){return this._sortedMaterialRenderers.some((t=>t.prepareTechnique(e)))}render(e){this._sortedMaterialRenderers.forAll((t=>{const r=t.prepareTechnique(e);null!=r&&t.renderNode(e,r)}))}intersect(e,t,r,i,o){return this._geometries.forEach((n=>{if(i&&!i(n))return;this._intersectRenderGeometry(n,r,t,0,e,o);const s=this.rendererContext.longitudeCyclical;s&&(n.boundingSphere[0]-n.boundingSphere[3]<s.min&&this._intersectRenderGeometry(n,r,t,s.range,e,o),n.boundingSphere[0]+n.boundingSphere[3]>s.max&&this._intersectRenderGeometry(n,r,t,-s.range,e,o)),o++})),o}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear(),this._materialRenderers.forAll(((e,t)=>{e.priority=t,this._sortedMaterialRenderers.push(e)})),this._sortedMaterialRenderers.sort(((e,t)=>t.material.renderPriority===e.material.renderPriority?e.priority-t.priority:t.material.renderPriority-e.material.renderPriority))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,r,i,o,n){if(!e.visible)return;let s=0;i+=e.transformation[12],s=e.transformation[13],kt[0]=r[0]-i,kt[1]=r[1]-s,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,o,kt,((r,i,s)=>{!function(e,t,r,i,o,n,s){const a=new nt(n,s,t),l=t=>{t.set(it.dz.OVERLAY,a,e.dist,e.normal,e.transformation,r,i)};if((null==o.results.min.drapedLayerOrder||r>=o.results.min.drapedLayerOrder)&&(null==o.results.min.dist||o.results.ground.dist<=o.results.min.dist)&&l(o.results.min),o.options.store!==it.oH.MIN&&(null==o.results.max.drapedLayerOrder||r<o.results.max.drapedLayerOrder)&&(null==o.results.max.dist||o.results.ground.dist>o.results.max.dist)&&l(o.results.max),o.options.store===it.oH.ALL){const e=(0,ct.G7)(o.ray);l(e),o.results.all.push(e)}}(t,s,e.material.renderPriority,n,o,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(null==this.drapeSource.notifyGraphicGeometryChanged)return;let t;for(const r of e){const e=r.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(null==this.drapeSource.notifyGraphicVisibilityChanged)return;let t;for(const r of e){const e=r.graphicUid;null!=e&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return null==e.localOrigin&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,i._)([(0,d.MZ)()],Bt.prototype,"drapeSource",void 0),(0,i._)([(0,d.MZ)()],Bt.prototype,"updating",null),(0,i._)([(0,d.MZ)()],Bt.prototype,"rctx",null),(0,i._)([(0,d.MZ)({constructOnly:!0})],Bt.prototype,"rendererContext",void 0),(0,i._)([(0,d.MZ)()],Bt.prototype,"_materialRepository",null),(0,i._)([(0,d.MZ)()],Bt.prototype,"_localOriginFactory",null),(0,i._)([(0,d.MZ)({readOnly:!0})],Bt.prototype,"isEmpty",null),(0,i._)([(0,d.MZ)()],Bt.prototype,"_materialRenderers",void 0),(0,i._)([(0,d.MZ)()],Bt.prototype,"_geometries",void 0),Bt=(0,i._)([(0,p.$)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Bt);class Gt{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const kt=(0,se.a)();var qt=r(47705),Zt=r(33444),$t=r(58123),Xt=r(2449);class Yt extends Zt.w{initializeProgram(e){return new $t.B(e.rctx,Yt.shader.get().build(),X.D)}initializePipeline(){return this.configuration.hasAlpha?(0,Xt.Ey)({blending:(0,Xt.p3)(Q.dn.SRC_ALPHA,Q.dn.ONE,Q.dn.ONE_MINUS_SRC_ALPHA,Q.dn.ONE_MINUS_SRC_ALPHA),colorWrite:Xt.wE}):(0,Xt.Ey)({colorWrite:Xt.wE})}}Yt.shader=new qt.$(F.a,(()=>r.e(6792).then(r.bind(r,76792))));class Qt extends V.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,i._)([(0,V.W)()],Qt.prototype,"hasAlpha",void 0);var Jt=r(91080),Kt=r(75268),er=r(36004);class tr extends Zt.w{initializeProgram(e){return new $t.B(e.rctx,tr.shader.get().build(),X.D)}initializePipeline(){return(0,Xt.Ey)({blending:(0,Xt.ox)(Q.dn.ONE,Q.dn.ONE_MINUS_SRC_ALPHA),colorWrite:Xt.wE})}}tr.shader=new qt.$(er.a,(()=>r.e(6008).then(r.bind(r,26008))));var rr=r(93399);let ir=class extends B.RW{get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new er.O,this.hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new a.A,this._passParameters=new F.T,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new G.i,this.worldToPCSRatio=1,this.events=new o.A,this.longitudeCyclical=null,this.produces=new Map([[ue.N.DRAPED_MATERIAL,e=>e!==A.V.Highlight||this.hasHighlights],[ue.N.DRAPED_WATER,()=>!0]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextureRepository:r,stippleTextureRepository:i,markerTextureRepository:o}=t;this._shaderTechniqueRepository=new z({rctx:this._rctx,viewingMode:v.RT.Local,stippleTextureRepository:i,markerTextureRepository:o,waterTextureRepository:r}),this._renderContext=new ve(this._rctx,new Ae(e,this.view.state.viewingMode),null),this.addHandles([(0,l.wB)((()=>r.updating),(()=>this.events.emit("content-changed")),l.pc),(0,l.wB)((()=>this.spatialReference),(e=>this._localOriginFactory=new ie.g(e)),l.pc),(0,l.on)((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new Z(t.textureRepository,this._shaderTechniqueRepository,(e=>{(e.parameters.renderOccluded&ar)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=ue.N.DRAPED_MATERIAL,this._bindParameters.mainDepth=function(e){const t=new re.R(1);return t.samplingMode=Q.Cj.NEAREST,new te.g(e,t,new Uint8Array([255,255,255,255]))}(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=pe.y.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new Kt.$p((0,g.f)(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(rr.W6.STAGE,this))}destroy(){this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=(0,s.Gz)(this._debugTextureTechnique),this._passParameters.texture=(0,s.WD)(this._passParameters.texture),this._bindParameters.mainDepth=(0,s.WD)(this._bindParameters.mainDepth),this._shaderTechniqueRepository=(0,s.pR)(this._shaderTechniqueRepository),this.disposeOverlays()}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,n.Bs)(this._renderers,(e=>e.updating))}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMemoryForMaterial(e){return Array.from(this._renderers.values()).reduce(((t,r)=>t+r.getMemoryForMaterial(e)),0)}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Bt)}createDrapeSourceRenderer(e,t,r){const i=this._renderers.get(e);null!=i&&i.destroy();const o=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,o),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles((0,l.wB)((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),o}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(){this._renderTargets?.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,c.bw)(e,(e=>e.drapeTargetType===_.sv.WithoutRasterImage))}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=(0,c.bw)(e,(e=>e.drapeSourceType===_.Om.Features)),this._hasDrapedRasterSource=(0,c.bw)(e,(e=>e.drapeSourceType===_.Om.RasterImage))):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){null==this._overlays&&(this._renderTargets=new P(this.view._stage.renderer.fboCache),this._overlays=[new C,new C]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=(0,s.WD)(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){if(null!=e)return e===b.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?this._renderTargets?.getTexture(b.Color):this._renderTargets?.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let r=!1;for(const[i,o]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&o.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=(0,n.Bs)(this._renderers,(e=>e.hasHighlights)),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(rr.Bb,(e=>e.updatePolicy===Jt.q.SYNC))}get isEmpty(){return!y.b.OVERLAY_DRAW_DEBUG_TEXTURE&&!(0,n.Bs)(this._renderers,(e=>!e.isEmpty))}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}get mode(){return this.isEmpty?L.Disabled:this._renderTargets?.getTexture(b.WaterNormal)?L.EnabledWithWater:this._renderTargets?.getTexture(b.Color)?L.Enabled:L.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach((r=>t=r.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const e of this._overlays)this.longitudeCyclical?e.setupGeometryViewsCyclical(this.longitudeCyclical):e.setupGeometryViewsDirect();for(const t of this._renderTargets.targets)(t.content!==b.ColorNoRasterImage||this._needsColorWithoutRasterImage)&&(this._drawTarget(w.vr.INNER,t,e),this._drawTarget(w.vr.OUTER,t,e))}}_drawTarget(e,t,r){const i=this._overlays[e],o=i.canvasGeometries;if(0===o.numViews)return;const{alignPixelEnabled:n,contentPixelRatio:s}=r;this._screenToWorldRatio=s*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const a=t.output;if(this.isEmpty||a===A.V.Highlight&&!this.hasHighlights||a===A.V.Normal&&!this.hasWater||!i.hasSomeSizedView())return;const l=this._rctx;this._camera.pixelRatio=i.pixelRatio*s,this._renderContext.output=a,this._bindParameters.alignPixelEnabled=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=a===A.V.Normal?ue.N.DRAPED_WATER:ue.N.DRAPED_MATERIAL;const c=y.b.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==b.Occluded;if(!c&&!this._sortedRenderers.some((({renderer:e})=>e.shouldRender(this._renderContext))))return;const d=i.resolution;this._rctx.setViewport(e===w.vr.INNER?0:d,0,d,d);const h=2*i.resolution,u=i.resolution,p=t.fbo;if(p.bind(l,h,u),e===w.vr.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(Q.hn.COLOR_BUFFER_BIT)),t.content===b.Occluded&&(this._renderContext.renderOccludedMask=ar),c)for(let f=0;f<o.numViews;f++)this._setViewParameters(o.extents[f],i),this._ensureDebugPatternResources(i.resolution,nr[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._passParameters,null),this._rctx.screen.draw();this._sortedRenderers.forAll((({drapeSource:r,renderer:n})=>{if(t.content===b.ColorNoRasterImage&&r.drapeSourceType===_.Om.RasterImage)return;const{fullOpacity:s}=r,c=null!=s&&s<1&&a===A.V.Color?this.bindTemporaryFramebuffer(h,u):null;for(let e=0;e<o.numViews;e++)this._setViewParameters(o.extents[e],i),n.render(this._renderContext);if(c){p.bind(l,h,u),this._overlayParameters.texture=c.colorTexture,this._overlayParameters.opacity=s,this._overlayParameters.overlayIndex=e;const t=this.pluginContext.techniqueRepository.acquire(tr);this._rctx.bindTechnique(t,this._overlayParameters,this._renderContext.bindParameters),this._rctx.screen.draw(),t.release(),c.release()}})),l.bindFramebuffer(null),e===w.vr.OUTER&&p.generateMipMap(),this._renderContext.resetRenderOccludedMask()}bindTemporaryFramebuffer(e,t){const r=this.view._stage.renderer.fboCache,i=r.acquire(R.NV.RGBA,e,t);return r.rctx.bindFramebuffer(i.fbo),r.rctx.clearSafe(Q.hn.COLOR_BUFFER_BIT),i}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){let o=0;for(const n of this._renderers.values())o=n.intersect?.(e,t,r,i,o)??o}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers;this._renderers.forEach(((t,r)=>{const i=e.indexOf(r.layer),o=i>=0,n=this._renderers.size*(r.renderGroup??(o?_.O7.MapLayer:_.O7.ViewLayer))+(o?i:0);this._sortedRenderers.push(new or(r,t,n))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],(0,f.x)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,f.d)(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=(0,n.Bs)(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateRendersOccluded(){const e=(0,n.Bs)(this._renderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_ensureDebugPatternResources(e,t){if((0,m.s)(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let s=0;s<e;s++)for(let t=0;t<e;t++){const o=Math.floor(t/10),n=Math.floor(s/10);o<2||n<2||10*o>e-20||10*n>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&o&&1&n?1&t^1&s?0:255:1&o^1&n?0:128)}const o=new re.R(e);o.samplingMode=Q.Cj.NEAREST,this._passParameters.texture=new te.g(this._rctx,o,r);const n=new Qt;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(Yt,n)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};(0,i._)([(0,d.MZ)()],ir.prototype,"hasHighlights",void 0),(0,i._)([(0,d.MZ)()],ir.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,i._)([(0,d.MZ)({autoDestroy:!0})],ir.prototype,"_shaderTechniqueRepository",void 0),(0,i._)([(0,d.MZ)({constructOnly:!0})],ir.prototype,"view",void 0),(0,i._)([(0,d.MZ)()],ir.prototype,"worldToPCSRatio",void 0),(0,i._)([(0,d.MZ)()],ir.prototype,"spatialReference",void 0),(0,i._)([(0,d.MZ)({type:Boolean,readOnly:!0})],ir.prototype,"updating",null),(0,i._)([(0,d.MZ)()],ir.prototype,"isEmpty",null),ir=(0,i._)([(0,p.$)("esri.views.3d.terrain.OverlayRenderer")],ir);class or{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const nr=[[1,.5,.5],[.5,.5,1]],sr=-2,ar=oe.m$.OccludeAndTransparent},36572:(e,t,r)=>{var i,o,n,s;r.d(t,{vr:()=>i}),function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"}(i||(i={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(o||(o={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(n||(n={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(s||(s={}))},56289:(e,t,r)=>{r.d(t,{s:()=>d});var i=r(34328),o=r(60840),n=r(35449),s=r(45160),a=r(99152),l=r(50645);const c=8;function d(e,t){const r=e.vertex;r.uniforms.add(new n.m("intrinsicWidth",(e=>e.width))),t.vvSize?(e.attributes.add(l.r.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new o.t("vvSizeMinSize",(e=>e.vvSize.minSize)),new o.t("vvSizeMaxSize",(e=>e.vvSize.maxSize)),new o.t("vvSizeOffset",(e=>e.vvSize.offset)),new o.t("vvSizeFactor",(e=>e.vvSize.factor))),r.code.add(a.H`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(l.r.SIZE,"float"),r.code.add(a.H`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(l.r.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add(new s.x("vvOpacityValues",(e=>e.vvOpacity.values),c),new s.x("vvOpacityOpacities",(e=>e.vvOpacity.opacityValues),c)),r.code.add(a.H`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(a.H`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.include(i.A,t),e.attributes.add(l.r.COLORFEATUREATTRIBUTE,"float"),r.code.add(a.H`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(e.attributes.add(l.r.COLOR,"vec4"),r.code.add(a.H`vec4 getColor(){
return applyOpacity(color);
}`))}},16917:(e,t,r)=>{r.d(t,{K:()=>n});var i=r(72563),o=r(99152);function n(e){e.uniforms.add(new i.e("alignPixelEnabled",((e,t)=>t.alignPixelEnabled))),e.code.add(o.H`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),e.code.add(o.H`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)}},97085:(e,t,r)=>{r.d(t,{Q:()=>h,R:()=>d});var i=r(54009),o=r(6916),n=r(63592),s=r(1411),a=r(35449),l=r(99152),c=r(50645);const d=.5;function h(e,t){e.include(o.Y6),e.attributes.add(c.r.POSITION,"vec3"),e.attributes.add(c.r.NORMAL,"vec3"),e.attributes.add(c.r.AUXPOS1,"vec4");const r=e.vertex;(0,n.NB)(r,t),(0,n.yu)(r,t),r.uniforms.add(new s.E("viewport",((e,t)=>t.camera.fullViewport)),new a.m("polygonOffset",(e=>e.shaderPolygonOffset)),new a.m("cameraGroundRelative",((e,t)=>t.camera.aboveGround?1:-1))),t.hasVerticalOffset&&(0,i.V)(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add(l.H`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.code.add(l.H`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${t.multipassEnabled?l.H.float(0):l.H`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),t.draped&&!t.hasVerticalOffset||(0,n.S7)(r),t.draped||(r.uniforms.add(new a.m("perDistancePixelRatio",((e,t)=>Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)))),r.code.add(l.H`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${l.H.float(d)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),t.screenCenterOffsetUnitsEnabled&&(0,n.Nz)(r),t.hasScreenSizePerspective&&(0,o.OH)(r),r.code.add(l.H`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offset of labels with respect to objects.
      // It also pulls the label towards the viewer so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.hasVerticalOffset?l.H`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled?"":l.H`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)}},36985:(e,t,r)=>{r.d(t,{I:()=>a});var i=r(16917),o=r(46823),n=r(80600),s=r(99152);function a(e,t){const{vertex:r,fragment:a}=e;r.include(i.K),t.multipassEnabled&&(r.include(o.H),e.varyings.add("depth","float")),r.code.add(s.H`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassEnabled?s.H`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.include(n.Q,t),a.code.add(s.H`
  void main() {
    fragColor = vec4(1);
    ${t.multipassEnabled?s.H`
        if(terrainDepthTest(depth)) {
          fragColor.g = 0.5;
        }`:""}
  }
  `)}},15354:(e,t,r)=>{var i;r.d(t,{D:()=>i}),function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(i||(i={}))},3097:(e,t,r)=>{r.d(t,{y:()=>c});var i=r(16917),o=r(15354),n=r(1411),s=r(35449),a=r(99152),l=r(79856);function c(e){e.vertex.uniforms.add(new s.m("renderTransparentlyOccludedHUD",((e,t)=>t.hudRenderStyle===o.D.Occluded?1:t.hudRenderStyle===o.D.NotOccluded?0:.75)),new n.E("viewport",((e,t)=>t.camera.fullViewport)),new l.N("hudVisibilityTexture",((e,t)=>t.hudVisibility?.colorTexture))),e.vertex.include(i.K),e.vertex.code.add(a.H`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}},79870:(e,t,r)=>{r.d(t,{v:()=>n,z:()=>o});var i=r(99152);function o(e){e.fragment.code.add(i.H`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function n(e){e.fragment.code.add(i.H`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},6821:(e,t,r)=>{r.d(t,{q:()=>m,h:()=>g});var i=r(70224),o=r(63592),n=r(1411),s=r(35449),a=r(99152),l=r(79856);r(51859),r(41746),r(6940),r(45758);function c(e){return e.pattern.map((t=>Math.round(t*e.pixelRatio)))}function d(e){if(null==e)return 1;const t=c(e);return Math.floor(t.reduce(((e,t)=>e+t)))}function h(e){return c(e).reduce(((e,t)=>Math.max(e,t)))}var u=r(25102),p=r(52712);const f=(0,p.c)();function m(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const r=!(t.draped&&t.stipplePreferContinuous),{vertex:c,fragment:d}=e;d.include(i.W),t.draped||((0,o.yu)(c,t),c.uniforms.add(new s.m("worldToScreenPerDistanceRatio",((e,t)=>1/t.camera.perScreenPixelRatio))),c.code.add(a.H`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),c.code.add(a.H`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${v};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),c.code.add(a.H`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),c.code.add(a.H`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),(0,o.Nz)(c),c.code.add(a.H`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),d.uniforms.add(new l.N("stipplePatternTexture",(e=>e.stippleTexture)),new s.m("stipplePatternSDFNormalizer",(e=>function(e){return e?(Math.floor(.5*(h(e)-1))+.5)/e.pixelRatio:1}(e.stipplePattern))),new s.m("stipplePatternPixelSizeInv",(e=>1/g(e)))),d.code.add(a.H`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),t.stippleOffColorEnabled?(d.uniforms.add(new n.E("stippleOffColor",(e=>function(e){return null==e?p.Z:4===e.length?e:(0,u.s)(f,e[0],e[1],e[2],1)}(e.stippleOffColor)))),d.code.add(a.H`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):d.code.add(a.H`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(a.H`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}function g(e){const t=e.stipplePattern;return t?d(e.stipplePattern)/t.pixelRatio:1}const v=a.H.float(.4)},2119:(e,t,r)=>{r.d(t,{r:()=>l});var i=r(50980),o=r(63592),n=r(35449),s=r(99152),a=r(58376);function l(e,t){const{vertex:r,constants:l}=e;l.add("markerSizePerLineWidth","float",i.PV),(0,o.Nz)(r),null==r.uniforms.get("markerScale")&&r.constants.add("markerScale","float",1),r.code.add(s.H`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),t.space===a.lM.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new n.m("perRenderPixelRatio",((e,t)=>t.camera.perRenderPixelRatio))),r.code.add(s.H`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}},46823:(e,t,r)=>{r.d(t,{H:()=>a,U:()=>l});var i=r(67726),o=r(54473),n=r(99152),s=r(79856);function a(e){e.include(i.D),e.uniforms.add(new s.N("geometryDepthTexture",((e,t)=>t.multipassGeometry.linearDepth?.colorTexture)),new o.G("nearFar",((e,t)=>t.camera.nearFar))),e.code.add(n.H`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}class l{}},22455:(e,t,r)=>{r.d(t,{n:()=>o});var i=r(99152);function o(e,t){t.spherical?e.vertex.code.add(i.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(i.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?e.vertex.code.add(i.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(i.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},65554:(e,t,r)=>{r.d(t,{E:()=>b});var i=r(79870),o=r(99152);function n(e){e.fragment.code.add(o.H`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var s=r(17666),a=r(67726),l=r(54473),c=r(35449),d=r(20778),h=r(79856);function u(e,t){const r=e.fragment;r.include(a.D),r.uniforms.add(new l.G("nearFar",((e,t)=>t.camera.nearFar))),r.uniforms.add(new h.N("depthMap",((e,t)=>t.linearDepth?.colorTexture))),r.uniforms.add(new d.X("proj",((e,t)=>t.camera.projectionMatrix))),r.uniforms.add(new c.m("invResolutionHeight",((e,t)=>1/t.camera.height))),r.uniforms.add(new d.X("reprojectionMatrix",((e,t)=>t.ssr.reprojectionMatrix))),r.code.add(o.H`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}var p=r(92504),f=r(99817),m=r(66386),g=r(58718),v=r(84323),_=r(696),y=r(72563),w=r(60840),O=r(99198),T=r(57198);class C extends O.n{constructor(e,t){super(e,"samplerCube",T.c.Pass,((r,i,o)=>r.bindTexture(e,t(i,o))))}}function S(e){const t=e.fragment;t.uniforms.add(new d.X("rotationMatrixClouds",((e,t)=>t.cloudsFade.parallax.transform)),new d.X("rotationMatrixCloudsCrossFade",((e,t)=>t.cloudsFade.parallaxNew.transform)),new w.t("anchorPosition",((e,t)=>t.cloudsFade.parallax.anchorPointClouds)),new w.t("anchorPositionCrossFade",((e,t)=>t.cloudsFade.parallaxNew.anchorPointClouds)),new c.m("cloudsHeight",(()=>v.k9)),new c.m("radiusCurvatureCorrectionFactor",((e,t)=>t.cloudsFade.parallax.radiusCurvatureCorrectionFactor)),new c.m("totalFadeInOut",((e,t)=>1-t.cloudsFade.opacity)),new c.m("crossFadeAnchorFactor",((e,t)=>(0,p.qE)(t.cloudsFade.fadeFactor,0,1))),new C("cubeMap",((e,t)=>t.cloudsFade.data?.cubeMap?.colorTexture??null)),new y.e("crossFade",((e,t)=>t.cloudsFade.fadeMode===g.OQ.CROSS_FADE)),new y.e("readChannelsRG",((e,t)=>t.cloudsFade.readChannels===m.c.RG)),new y.e("fadeTextureChannels",((e,t)=>t.cloudsFade.renderingStage===m.c2.FADING))),t.constants.add("planetRadius","float",f.$O.radius),t.code.add(o.H`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.code.add(o.H`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.code.add(o.H`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),(0,_.Gc)(t),(0,_.O4)(t),t.code.add(o.H`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.code.add(o.H`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),t.code.add(o.H`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),t.code.add(o.H`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),t.code.add(o.H`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function b(e,t){e.include(s.f,t),e.include(n),e.include(i.v),t.hasCloudsReflections&&e.include(S,t),t.hasScreenSpaceReflections&&e.include(u,t);const r=e.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(o.H`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new c.m("lightingSpecularStrength",((e,t)=>t.lighting.mainLight.specularStrength)),new c.m("lightingEnvironmentStrength",((e,t)=>t.lighting.mainLight.environmentStrength))),r.code.add(o.H`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.hasCloudsReflections&&r.code.add(o.H`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),t.hasScreenSpaceReflections?(r.uniforms.add(new d.X("view",((e,t)=>t.camera.viewMatrix)),new h.N("lastFrameColorTexture",((e,t)=>t.ssr.lastFrameColor?.colorTexture)),new c.m("fadeFactorSSR",((e,t)=>t.ssr.fadeFactor))),r.code.add(o.H`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(o.H`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.hasCloudsReflections?t.hasScreenSpaceReflections?r.code.add(o.H`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(o.H`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(o.H`return waterRenderedColor;
}`)}},41679:(e,t,r)=>{r.d(t,{V:()=>u});var i=r(58680),o=r(78286),n=r(25102),s=r(52712),a=r(79870),l=(r(64062),r(54473)),c=r(1411),d=r(99152),h=r(79856);function u(e){e.fragment.uniforms.add(new h.N("texWaveNormal",(e=>e.waveNormal)),new h.N("texWavePerturbation",(e=>e.wavePerturbation)),new c.E("waveParams",(e=>(0,n.s)(p,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset))),new l.G("waveDirection",(e=>(0,i.s)(f,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)))),e.include(a.z),e.fragment.code.add(d.H`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const p=(0,s.c)(),f=(0,o.a)()},36549:(e,t,r)=>{r.d(t,{i:()=>C});var i,o=r(66866),n=r(52495),s=r(539),a=r(92504),l=r(89882),c=r(21564),d=(r(73446),r(85569),r(39831),r(63863)),h=r(37046),u=r(56192),p=r(58680),f=r(78286),m=r(21839),g=r(22279),v=r(25102),_=r(52712),y=r(94982),w=r(32532),O=r(16597),T=r(10714);let C=i=class extends n.A{constructor(e={}){super(e),this._center=(0,g.c)(),this._up=(0,g.c)(),this._viewUp=(0,g.c)(),this._viewForward=(0,g.c)(),this._viewRight=(0,g.c)(),this._ray=(0,w.vt)(),this._viewport=(0,_.f)(0,0,1,1),this._padding=(0,_.f)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,f.f)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,u.a)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,u.a)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,u.a)(),this._frustumDirty=!0,this._frustum=(0,y.vt)(),this._fullViewport=(0,_.c)(),this._pixelRatio=1,this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return(0,m.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,h.h)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=(0,v.b)((0,_.c)(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&(0,v.e)(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=(0,v.b)((0,_.c)(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&(0,v.e)(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[E.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[E.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[E.RIGHT]+this._padding[E.LEFT]}set fullWidth(e){this.width=e-(this._padding[E.RIGHT]+this._padding[E.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[E.TOP]+this._padding[E.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[E.TOP]+this._padding[E.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[E.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[E.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){(0,v.h)(this._padding,e)||(this._viewport[0]+=e[E.LEFT]-this._padding[E.LEFT],this._viewport[1]+=e[E.BOTTOM]-this._padding[E.BOTTOM],this._viewport[2]-=e[E.RIGHT]+e[E.LEFT]-(this._padding[E.RIGHT]+this._padding[E.LEFT]),this._viewport[3]-=e[E.TOP]+e[E.BOTTOM]-(this._padding[E.TOP]+this._padding[E.BOTTOM]),(0,v.c)(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,h.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this._aspect,o=(0,h.q)((0,u.a)(),-i*(1+2*this._padding[E.LEFT]/e),i*(1+2*this._padding[E.RIGHT]/e),-r*(1+2*this._padding[E.BOTTOM]/t),r*(1+2*this._padding[E.TOP]/t),this.near,this.far),n=this._get("projectionMatrix");return n&&(0,h.a)(n,o)?n:o}get inverseProjectionMatrix(){return(0,h.i)((0,u.a)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,u.a)()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+r*r))}(this._fov,this.width,this.height)}set fovX(e){this._fov=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/t)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/Math.sqrt(t*t+r*r))}(this._fov,this.width,this.height)}set fovY(e){this._fov=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/r)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,m.o)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,h.i)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,h.t)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,m.c)(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,(0,v.c)(this._viewport,e.viewport),this.notifyChange("_viewport"),(0,v.c)(this._padding,e.padding),this.notifyChange("_padding"),(0,p.j)(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,h.h)(this._viewMatrix,e.viewMatrix),(0,m.c)(this._viewRight,e.viewRight),(0,m.c)(this._viewUp,e.viewUp),(0,m.c)(this._viewForward,e.viewForward)),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,y.C)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,h.h)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,v.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new i).copyFrom(this)}equals(e){return(0,m.h)(this.eye,e.eye)&&(0,m.h)(this.center,e.center)&&(0,m.h)(this.up,e.up)&&(0,v.h)(this._viewport,e.viewport)&&(0,v.h)(this._padding,e.padding)&&(0,p.m)(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||(0,v.i)(e.screenPadding,this.screenPadding)>=t||(0,v.i)(this.screenViewport,e.screenViewport)>=t)return!1;(0,m.u)(x,e.eye,e.center),(0,m.u)(R,this.eye,this.center);const r=(0,m.j)(x,R),i=(0,m.F)(x),o=(0,m.F)(R),n=5e-4;return r*r>=(1-1e-10)*i*o&&(0,m.y)(e.eye,this.eye)<Math.max(i,o)*n*n}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,O.gr)(this.viewForward,(0,m.f)(x,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,l.gs)()){return e[0]=(this.padding[E.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[E.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e[0]=this.padding[E.LEFT]+this.width*t,e[1]=this.padding[E.BOTTOM]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){e!==S&&(0,m.c)(S,e),S[3]=1,(0,v.t)(S,S,this.projectionMatrix);const r=Math.abs(S[3]);(0,m.i)(S,S,1/r);const i=this.fullViewport;t[0]=(0,a.Cc)(0,i[0]+i[2],.5+.5*S[0]),t[1]=(0,a.Cc)(0,i[1]+i[3],.5+.5*S[1]),t[2]=.5*(S[2]+1),t[3]=r}unapplyProjection(e,t){const r=this.fullViewport;S[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],S[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],S[2]=(2*e[2]-1)*e[3],S[3]=e[3],null!=this.inverseProjectionMatrix&&((0,v.t)(S,S,this.inverseProjectionMatrix),t[0]=S[0],t[1]=S[1],t[2]=S[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,A),this.renderToScreen(A,t),t}projectToRenderScreen(e,t){if(S[0]=e[0],S[1]=e[1],S[2]=e[2],S[3]=1,(0,v.t)(S,S,this.viewProjectionMatrix),0===S[3])return null;(0,m.i)(S,S,1/Math.abs(S[3]));const r=this.fullViewport;return"x"in t?(t.x=(0,a.Cc)(0,r[0]+r[2],.5+.5*S[0]),t.y=(0,a.Cc)(0,r[1]+r[3],.5+.5*S[1])):(t[0]=(0,a.Cc)(0,r[0]+r[2],.5+.5*S[0]),t[1]=(0,a.Cc)(0,r[1]+r[3],.5+.5*S[1]),t.length>2&&(t[2]=.5*(S[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,A),t)}unprojectFromRenderScreen(e,t){if((0,h.m)(b,this.projectionMatrix,this.viewMatrix),!(0,h.i)(b,b))return null;const r=this.fullViewport;return S[0]=2*(e[0]-r[0])/r[2]-1,S[1]=2*(e[1]-r[1])/r[3]-1,S[2]=2*e[2]-1,S[3]=1,(0,v.t)(S,S,b),0===S[3]?null:(t[0]=S[0]/S[3],t[1]=S[1]/S[3],t[2]=S[2]/S[3],t)}constrainWindowSize(e,t,r,i){const o=e*this.pixelRatio,n=t*this.pixelRatio,s=Math.max(o-r/2,0),a=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(o-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0),d=r-l- -Math.min(this.fullWidth-o-r/2,0),h=i-c- -Math.min(n-i/2,0);return[Math.round(s),Math.round(a),Math.round(d),Math.round(h)]}computeUp(e){e===T.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){(0,m.f)(x,this.center,this.eye);const e=(0,m.l)(this.center);e<1?((0,m.s)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,m.j)(x,this.center))>.9999*(0,m.l)(x)*e||((0,m.b)(this._up,x,this.center),(0,m.b)(this._up,this._up,x),(0,m.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,m.C)(x,this.eye,this.center),Math.abs(x[2])<=.9999&&((0,m.i)(x,x,x[2]),(0,m.s)(this._up,-x[0],-x[1],1-x[2]),(0,m.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,r=""){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,m.h)(e,t)||((0,m.c)(t,e),this._markViewDirty(),r.length&&this.notifyChange(r)):s.A.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,y.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,h.u)(this._viewMatrix,this.eye,this.center,this.up),(0,m.s)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,m.s)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,m.s)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,o._)([(0,c.MZ)()],C.prototype,"_center",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"_up",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"_viewport",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"_padding",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"_fov",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"_nearFar",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"_pixelRatio",void 0),(0,o._)([(0,c.MZ)()],C.prototype,"pixelRatio",null),(0,o._)([(0,c.MZ)()],C.prototype,"eye",null),(0,o._)([(0,c.MZ)()],C.prototype,"center",null),(0,o._)([(0,c.MZ)()],C.prototype,"up",null),(0,o._)([(0,c.MZ)({readOnly:!0})],C.prototype,"nearFar",null),(0,o._)([(0,c.MZ)()],C.prototype,"near",null),(0,o._)([(0,c.MZ)()],C.prototype,"far",null),(0,o._)([(0,c.MZ)()],C.prototype,"viewport",null),(0,o._)([(0,c.MZ)({readOnly:!0})],C.prototype,"screenViewport",null),(0,o._)([(0,c.MZ)({readOnly:!0})],C.prototype,"screenPadding",null),(0,o._)([(0,c.MZ)()],C.prototype,"x",null),(0,o._)([(0,c.MZ)()],C.prototype,"y",null),(0,o._)([(0,c.MZ)()],C.prototype,"width",null),(0,o._)([(0,c.MZ)()],C.prototype,"height",null),(0,o._)([(0,c.MZ)()],C.prototype,"fullWidth",null),(0,o._)([(0,c.MZ)()],C.prototype,"fullHeight",null),(0,o._)([(0,c.MZ)({readOnly:!0})],C.prototype,"_aspect",null),(0,o._)([(0,c.MZ)()],C.prototype,"padding",null),(0,o._)([(0,c.MZ)({readOnly:!0})],C.prototype,"projectionMatrix",null),(0,o._)([(0,c.MZ)({readOnly:!0})],C.prototype,"inverseProjectionMatrix",null),(0,o._)([(0,c.MZ)()],C.prototype,"fov",null),(0,o._)([(0,c.MZ)()],C.prototype,"fovX",null),(0,o._)([(0,c.MZ)()],C.prototype,"fovY",null),C=i=(0,o._)([(0,d.$)("esri.views.3d.webgl-engine.lib.Camera")],C);const S=(0,_.c)(),b=(0,u.a)(),x=(0,g.c)(),R=(0,g.c)(),A=(0,l.r_)();var E;!function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(E||(E={}))},72136:(e,t,r)=>{r.d(t,{c:()=>o});var i=r(91013);class o{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,r){if(!this._material.produces(t,r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));const o=this._map.get(r);if(null!=o){if(o.ensureResources(e)===i.Am.LOADED)return o;this._repository.requestRender()}return null}}},94643:(e,t,r)=>{r.d(t,{zC:()=>re,C1:()=>S,EE:()=>X,nW:()=>Y,td:()=>E,_B:()=>ee,Nq:()=>J,DJ:()=>q,uX:()=>k,Z8:()=>K,CM:()=>G,Gj:()=>$,Ho:()=>B,Nb:()=>Q,Xl:()=>oe,xh:()=>te});var i,o=r(21839),n=r(80952),s=r(22279),a=r(90166),l=r(50961),c=r(42965),d=r(38774),h=r(32532),u=r(70807);!function(e){e.length=function(e,t){const r=e[t],i=e[t+1],o=e[t+2];return Math.sqrt(r*r+i*i+o*o)},e.normalize=function(e,t){const r=e[t],i=e[t+1],o=e[t+2],n=1/Math.sqrt(r*r+i*i+o*o);e[t]*=n,e[t+1]*=n,e[t+2]*=n},e.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},e.add=function(e,t,r,i,o,n=t){(o=o||e)[n]=e[t]+r[i],o[n+1]=e[t+1]+r[i+1],o[n+2]=e[t+2]+r[i+2]},e.subtract=function(e,t,r,i,o,n=t){(o=o||e)[n]=e[t]-r[i],o[n+1]=e[t+1]-r[i+1],o[n+2]=e[t+2]-r[i+2]}}(i||(i={}));var p=r(52997),f=r(59568),m=r(58947),g=r(50645);const v=i,_=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],y=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],w=[0,0,1,0,1,1,0,1],O=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],T=new Array(36);for(let ae=0;ae<6;ae++)for(let e=0;e<6;e++)T[6*ae+e]=ae;const C=new Array(36);for(let ae=0;ae<6;ae++)C[6*ae]=0,C[6*ae+1]=1,C[6*ae+2]=2,C[6*ae+3]=2,C[6*ae+4]=3,C[6*ae+5]=0;function S(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(24);for(let i=0;i<8;i++)r[3*i]=_[i][0]*t[0],r[3*i+1]=_[i][1]*t[1],r[3*i+2]=_[i][2]*t[2];return new f.V(e,[[g.r.POSITION,new u.n(r,O,3,!0)],[g.r.NORMAL,new u.n(y,T,3)],[g.r.UV0,new u.n(w,C,2)]])}const b=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],x=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],R=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],A=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function E(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(18);for(let i=0;i<6;i++)r[3*i]=b[i][0]*t[0],r[3*i+1]=b[i][1]*t[1],r[3*i+2]=b[i][2]*t[2];return new f.V(e,[[g.r.POSITION,new u.n(r,R,3,!0)],[g.r.NORMAL,new u.n(x,A,3)]])}const P=(0,n.f)(-.5,0,-.5),D=(0,n.f)(.5,0,-.5),M=(0,n.f)(0,0,.5),I=(0,n.f)(0,.5,0),N=(0,n.c)(),L=(0,n.c)(),F=(0,n.c)(),H=(0,n.c)(),V=(0,n.c)();(0,o.f)(N,P,I),(0,o.f)(L,P,D),(0,o.b)(F,N,L),(0,o.n)(F,F),(0,o.f)(N,D,I),(0,o.f)(L,D,M),(0,o.b)(H,N,L),(0,o.n)(H,H),(0,o.f)(N,M,I),(0,o.f)(L,M,P),(0,o.b)(V,N,L),(0,o.n)(V,V);const z=[P,D,M,I],j=[0,-1,0,F[0],F[1],F[2],H[0],H[1],H[2],V[0],V[1],V[2]],W=[0,1,2,3,1,0,3,2,1,3,0,2],U=[0,0,0,1,1,1,2,2,2,3,3,3];function B(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(12);for(let i=0;i<4;i++)r[3*i]=z[i][0]*t[0],r[3*i+1]=z[i][1]*t[1],r[3*i+2]=z[i][2]*t[2];return new f.V(e,[[g.r.POSITION,new u.n(r,W,3,!0)],[g.r.NORMAL,new u.n(j,U,3)]])}function G(e,t,r,i,o={uv:!0}){const n=-Math.PI,s=2*Math.PI,a=-Math.PI/2,d=Math.PI,h=Math.max(3,Math.floor(r)),p=Math.max(2,Math.floor(i)),m=(h+1)*(p+1),v=(0,l.oe)(3*m),_=(0,l.oe)(3*m),y=(0,l.oe)(2*m),w=[];let O=0;for(let l=0;l<=p;l++){const e=[],r=l/p,i=a+r*d,o=Math.cos(i);for(let a=0;a<=h;a++){const l=a/h,c=n+l*s,d=Math.cos(c)*o,u=Math.sin(i),p=-Math.sin(c)*o;v[3*O]=d*t,v[3*O+1]=u*t,v[3*O+2]=p*t,_[3*O]=d,_[3*O+1]=u,_[3*O+2]=p,y[2*O]=l,y[2*O+1]=r,e.push(O),++O}w.push(e)}const T=new Array;for(let l=0;l<p;l++)for(let e=0;e<h;e++){const t=w[l][e],r=w[l][e+1],i=w[l+1][e+1],o=w[l+1][e];0===l?(T.push(t),T.push(i),T.push(o)):l===p-1?(T.push(t),T.push(r),T.push(i)):(T.push(t),T.push(r),T.push(i),T.push(i),T.push(o),T.push(t))}const C=[[g.r.POSITION,new u.n(v,T,3,!0)],[g.r.NORMAL,new u.n(_,T,3,!0)]];return o.uv&&C.push([g.r.UV0,new u.n(y,T,2,!0)]),o.offset&&(C[0][0]=g.r.OFFSET,C.push([g.r.POSITION,new u.n(Float64Array.from(o.offset),(0,c.EH)(T.length),3,!0)])),new f.V(e,C)}function k(e,t,r,i){const o=function(e,t,r){const i=e;let o,n;if(r)o=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const e=i*(1+Math.sqrt(5))/2;o=[-i,e,0,i,e,0,-i,-e,0,i,-e,0,0,-i,e,0,i,e,0,-i,-e,0,i,-e,e,0,-i,e,0,i,-e,0,-i,-e,0,i],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let l=0;l<o.length;l+=3)v.scale(o,l,e/v.length(o,l));let s={};function a(t,r){t>r&&([t,r]=[r,t]);const i=t.toString()+"."+r.toString();if(s[i])return s[i];let n=o.length;return o.length+=3,v.add(o,3*t,o,3*r,o,n),v.scale(o,n,e/v.length(o,n)),n/=3,s[i]=n,n}for(let l=0;l<t;l++){const e=n.length,t=new Array(4*e);for(let r=0;r<e;r+=3){const e=n[r],i=n[r+1],o=n[r+2],s=a(e,i),l=a(i,o),c=a(o,e),d=4*r;t[d]=e,t[d+1]=s,t[d+2]=c,t[d+3]=i,t[d+4]=l,t[d+5]=s,t[d+6]=o,t[d+7]=c,t[d+8]=l,t[d+9]=s,t[d+10]=l,t[d+11]=c}n=t,s={}}const c=(0,l.Wz)(o);for(let l=0;l<c.length;l+=3)v.normalize(c,l);return[[g.r.POSITION,new u.n((0,l.Wz)(o),n,3,!0)],[g.r.NORMAL,new u.n(c,n,3,!0)]]}(t,r,i);return new f.V(e,o)}function q(e,t,r,i,o,n,s,a,l=null){const d=r?[r[0],r[1],r[2]]:[0,0,0],h=t?[t[0],t[1],t[2]]:[0,0,1];s=s||[0,0];const m=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],v=null!=o&&2===o.length?o:[1,1],_=(0,c.EH)(1),y=[[g.r.POSITION,new u.n(d,_,3,!0)],[g.r.NORMAL,new u.n(h,_,3,!0)],[g.r.UV0,new u.n(s,_,s.length)],[g.r.COLOR,new u.n(m,_,4,!0)],[g.r.SIZE,new u.n(v,_,2)]];if(null!=n){const e=[n[0],n[1],n[2],n[3]];y.push([g.r.AUXPOS1,new u.n(e,_,4)])}if(null!=a){const e=[a[0],a[1],a[2],a[3]];y.push([g.r.FEATUREATTRIBUTE,new u.n(e,_,4)])}return new f.V(e,y,null,p.X.Point,l)}const Z=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function $(e,t=Z){const r=new Array(12);for(let s=0;s<4;s++)for(let e=0;e<3;e++)r[3*s+e]=t[s][e];const i=[0,1,2,2,3,0],o=[0,0,0,0,0,0],n=[[g.r.POSITION,new u.n(r,i,3,!0)],[g.r.NORMAL,new u.n([0,0,1],o,3,!0)],[g.r.UV0,new u.n([0,0,1,0,1,1,0,1],i,2,!0)],[g.r.COLOR,new u.n([255,255,255,255],o,4,!0)]];return new f.V(e,n)}function X(e,t,r,i,o,s=!0,a=!0){let c=0;const d=r,h=t;let p=(0,n.f)(0,c,0),m=(0,n.f)(0,c+h,0),v=(0,n.f)(0,-1,0),_=(0,n.f)(0,1,0);o&&(c=h,m=(0,n.f)(0,0,0),p=(0,n.f)(0,c,0),v=(0,n.f)(0,1,0),_=(0,n.f)(0,-1,0));const y=[m,p],w=[v,_],O=i+2,T=Math.sqrt(h*h+d*d);if(o)for(let l=i-1;l>=0;l--){const e=l*(2*Math.PI/i),t=(0,n.f)(Math.cos(e)*d,c,Math.sin(e)*d);y.push(t);const r=(0,n.f)(h*Math.cos(e)/T,-d/T,h*Math.sin(e)/T);w.push(r)}else for(let l=0;l<i;l++){const e=l*(2*Math.PI/i),t=(0,n.f)(Math.cos(e)*d,c,Math.sin(e)*d);y.push(t);const r=(0,n.f)(h*Math.cos(e)/T,d/T,h*Math.sin(e)/T);w.push(r)}const C=new Array,S=new Array;if(s){for(let e=3;e<y.length;e++)C.push(1),C.push(e-1),C.push(e),S.push(0),S.push(0),S.push(0);C.push(y.length-1),C.push(2),C.push(1),S.push(0),S.push(0),S.push(0)}if(a){for(let e=3;e<y.length;e++)C.push(e),C.push(e-1),C.push(0),S.push(e),S.push(e-1),S.push(1);C.push(0),C.push(2),C.push(y.length-1),S.push(1),S.push(2),S.push(w.length-1)}const b=(0,l.oe)(3*O);for(let n=0;n<O;n++)b[3*n]=y[n][0],b[3*n+1]=y[n][1],b[3*n+2]=y[n][2];const x=(0,l.oe)(3*O);for(let n=0;n<O;n++)x[3*n]=w[n][0],x[3*n+1]=w[n][1],x[3*n+2]=w[n][2];const R=[[g.r.POSITION,new u.n(b,C,3,!0)],[g.r.NORMAL,new u.n(x,S,3,!0)]];return new f.V(e,R)}function Y(e,t,r,i,s,a,c){const d=s?(0,n.a)(s):(0,n.f)(1,0,0),h=a?(0,n.a)(a):(0,n.f)(0,0,0);c??=!0;const p=(0,n.c)();(0,o.n)(p,d);const m=(0,n.c)();(0,o.i)(m,p,Math.abs(t));const v=(0,n.c)();(0,o.i)(v,m,-.5),(0,o.g)(v,v,h);const _=(0,n.f)(0,1,0);Math.abs(1-(0,o.j)(p,_))<.2&&(0,o.s)(_,0,0,1);const y=(0,n.c)();(0,o.b)(y,p,_),(0,o.n)(y,y),(0,o.b)(_,y,p);const w=2*i+(c?2:0),O=i+(c?2:0),T=(0,l.oe)(3*w),C=(0,l.oe)(3*O),S=(0,l.oe)(2*w),b=new Array(3*i*(c?4:2)),x=new Array(3*i*(c?4:2));c&&(T[3*(w-2)]=v[0],T[3*(w-2)+1]=v[1],T[3*(w-2)+2]=v[2],S[2*(w-2)]=0,S[2*(w-2)+1]=0,T[3*(w-1)]=T[3*(w-2)]+m[0],T[3*(w-1)+1]=T[3*(w-2)+1]+m[1],T[3*(w-1)+2]=T[3*(w-2)+2]+m[2],S[2*(w-1)]=1,S[2*(w-1)+1]=1,C[3*(O-2)]=-p[0],C[3*(O-2)+1]=-p[1],C[3*(O-2)+2]=-p[2],C[3*(O-1)]=p[0],C[3*(O-1)+1]=p[1],C[3*(O-1)+2]=p[2]);const R=(e,t,r)=>{b[e]=t,x[e]=r};let A=0;const E=(0,n.c)(),P=(0,n.c)();for(let n=0;n<i;n++){const e=n*(2*Math.PI/i);(0,o.i)(E,_,Math.sin(e)),(0,o.i)(P,y,Math.cos(e)),(0,o.g)(E,E,P),C[3*n]=E[0],C[3*n+1]=E[1],C[3*n+2]=E[2],(0,o.i)(E,E,r),(0,o.g)(E,E,v),T[3*n]=E[0],T[3*n+1]=E[1],T[3*n+2]=E[2],S[2*n]=n/i,S[2*n+1]=0,T[3*(n+i)]=T[3*n]+m[0],T[3*(n+i)+1]=T[3*n+1]+m[1],T[3*(n+i)+2]=T[3*n+2]+m[2],S[2*(n+i)]=n/i,S[2*n+1]=1;const t=(n+1)%i;R(A++,n,n),R(A++,n+i,n),R(A++,t,t),R(A++,t,t),R(A++,n+i,n),R(A++,t+i,t)}if(c){for(let e=0;e<i;e++){const t=(e+1)%i;R(A++,w-2,O-2),R(A++,e,O-2),R(A++,t,O-2)}for(let e=0;e<i;e++){const t=(e+1)%i;R(A++,e+i,O-1),R(A++,w-1,O-1),R(A++,t+i,O-1)}}const D=[[g.r.POSITION,new u.n(T,b,3,!0)],[g.r.NORMAL,new u.n(C,x,3,!0)],[g.r.UV0,new u.n(S,b,2,!0)]];return new f.V(e,D)}function Q(e,t,r,i,o,n){i=i||10,o=null==o||o,(0,m.vA)(t.length>1);const s=[],a=[];for(let l=0;l<i;l++){s.push([0,-l-1,-(l+1)%i-1]);const e=l/i*2*Math.PI;a.push([Math.cos(e)*r,Math.sin(e)*r])}return J(e,a,t,[[0,0,0]],s,o,n)}function J(e,t,r,i,a,c,p=(0,n.f)(0,0,0)){const m=t.length,v=(0,l.oe)(r.length*m*3+(6*i.length||0)),_=(0,l.oe)(r.length*m*3+(i?6:0)),y=new Array,w=new Array;let O=0,T=0;const C=(0,n.c)(),S=(0,n.c)(),b=(0,n.c)(),x=(0,n.c)(),R=(0,n.c)(),A=(0,n.c)(),E=(0,n.c)(),P=(0,s.c)(),D=(0,n.c)(),M=(0,n.c)(),I=(0,n.c)(),N=(0,n.c)(),L=(0,n.c)(),F=(0,d.vt)();(0,o.s)(D,0,1,0),(0,o.f)(S,r[1],r[0]),(0,o.n)(S,S),c?((0,o.g)(P,r[0],p),(0,o.n)(b,P)):(0,o.s)(b,0,0,1),oe(S,b,D,D,R,b,ne),(0,o.c)(x,b),(0,o.c)(N,R);for(let n=0;n<i.length;n++)(0,o.i)(A,R,i[n][0]),(0,o.i)(P,b,i[n][2]),(0,o.g)(A,A,P),(0,o.g)(A,A,r[0]),v[O++]=A[0],v[O++]=A[1],v[O++]=A[2];_[T++]=-S[0],_[T++]=-S[1],_[T++]=-S[2];for(let o=0;o<a.length;o++)y.push(a[o][0]>0?a[o][0]:-a[o][0]-1+i.length),y.push(a[o][1]>0?a[o][1]:-a[o][1]-1+i.length),y.push(a[o][2]>0?a[o][2]:-a[o][2]-1+i.length),w.push(0),w.push(0),w.push(0);let H=i.length;const V=i.length-1;for(let n=0;n<r.length;n++){let e=!1;n>0&&((0,o.c)(C,S),n<r.length-1?((0,o.f)(S,r[n+1],r[n]),(0,o.n)(S,S)):e=!0,(0,o.g)(M,C,S),(0,o.n)(M,M),(0,o.g)(I,r[n-1],x),(0,d.O_)(r[n],M,F),(0,d.Ui)(F,(0,h.LV)(I,C),P)?((0,o.f)(P,P,r[n]),(0,o.n)(b,P),(0,o.b)(R,M,b),(0,o.n)(R,R)):oe(M,x,N,D,R,b,ne),(0,o.c)(x,b),(0,o.c)(N,R)),c&&((0,o.g)(P,r[n],p),(0,o.n)(L,P));for(let i=0;i<m;i++)if((0,o.i)(A,R,t[i][0]),(0,o.i)(P,b,t[i][1]),(0,o.g)(A,A,P),(0,o.n)(E,A),_[T++]=E[0],_[T++]=E[1],_[T++]=E[2],(0,o.g)(A,A,r[n]),v[O++]=A[0],v[O++]=A[1],v[O++]=A[2],!e){const e=(i+1)%m;y.push(H+i),y.push(H+m+i),y.push(H+e),y.push(H+e),y.push(H+m+i),y.push(H+m+e);for(let t=0;t<6;t++){const e=y.length-6;w.push(y[e+t]-V)}}H+=m}const z=r[r.length-1];for(let n=0;n<i.length;n++)(0,o.i)(A,R,i[n][0]),(0,o.i)(P,b,i[n][1]),(0,o.g)(A,A,P),(0,o.g)(A,A,z),v[O++]=A[0],v[O++]=A[1],v[O++]=A[2];const j=T/3;_[T++]=S[0],_[T++]=S[1],_[T++]=S[2];const W=H-m;for(let o=0;o<a.length;o++)y.push(a[o][0]>=0?H+a[o][0]:-a[o][0]-1+W),y.push(a[o][2]>=0?H+a[o][2]:-a[o][2]-1+W),y.push(a[o][1]>=0?H+a[o][1]:-a[o][1]-1+W),w.push(j),w.push(j),w.push(j);const U=[[g.r.POSITION,new u.n(v,y,3,!0)],[g.r.NORMAL,new u.n(_,w,3,!0)]];return new f.V(e,U)}function K(e,t,r,i){(0,m.vA)(t.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),(0,m.vA)(3===t[0].length,"createPolylineGeometry(): malformed vertex"),(0,m.vA)(null==r||r.length===t.length,"createPolylineGeometry: need same number of points and normals"),(0,m.vA)(null==r||3===r[0].length,"createPolylineGeometry(): malformed normal");const o=(0,a.jh)(3*t.length),n=new Array(2*(t.length-1));let s=0,d=0;for(let a=0;a<t.length;a++){for(let e=0;e<3;e++)o[s++]=t[a][e];a>0&&(n[d++]=a-1,n[d++]=a)}const h=[[g.r.POSITION,new u.n(o,n,3,!0)]];if(r){const e=(0,l.oe)(3*r.length);let i=0;for(let o=0;o<t.length;o++)for(let t=0;t<3;t++)e[i++]=r[o][t];h.push([g.r.NORMAL,new u.n(e,n,3,!0)])}return i&&h.push([g.r.COLOR,new u.n(i,(0,c.tM)(i.length/4),4)]),new f.V(e,h,null,p.X.Line)}function ee(e,t,r,i,o,n=0){const s=new Array(18),a=[[-r,n,o/2],[i,n,o/2],[0,t+n,o/2],[-r,n,-o/2],[i,n,-o/2],[0,t+n,-o/2]];for(let l=0;l<6;l++)s[3*l]=a[l][0],s[3*l+1]=a[l][1],s[3*l+2]=a[l][2];return new f.V(e,[[g.r.POSITION,new u.n(s,[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5],3,!0)]])}function te(e,t){const r=e.getMutableAttribute(g.r.POSITION).data;for(let i=0;i<r.length;i+=3){const e=r[i],n=r[i+1],s=r[i+2];(0,o.s)(se,e,n,s),(0,o.e)(se,se,t),r[i]=se[0],r[i+1]=se[1],r[i+2]=se[2]}}function re(e,t=e){const r=e.attributes,i=r.get(g.r.POSITION).data,o=r.get(g.r.NORMAL).data;if(o){const e=t.getMutableAttribute(g.r.NORMAL).data;for(let t=0;t<o.length;t+=3){const r=o[t+1];e[t+1]=-o[t+2],e[t+2]=r}}if(i){const e=t.getMutableAttribute(g.r.POSITION).data;for(let t=0;t<i.length;t+=3){const r=i[t+1];e[t+1]=-i[t+2],e[t+2]=r}}}function ie(e,t,r,i,n){return!(Math.abs((0,o.j)(t,e))>n||((0,o.b)(r,e,t),(0,o.n)(r,r),(0,o.b)(i,r,e),(0,o.n)(i,i),0))}function oe(e,t,r,i,o,n,s){return ie(e,t,o,n,s)||ie(e,r,o,n,s)||ie(e,i,o,n,s)}const ne=.99619469809,se=(0,n.c)()},24734:(e,t,r)=>{r.d(t,{g:()=>v});var i=r(65061),o=r(21839),n=r(22279),s=r(52712),a=r(84119),l=r(70807),c=r(52997),d=r(59568),h=r(32926),u=r(55103),p=r(53834),f=r(50645),m=r(54671),g=r(96824);class v{constructor(e){this._originSR=e,this._rootOriginId="root/"+(0,i.L)(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=p.Q.rootOrigin;if(null!=t)return this._origins.set(this._rootOriginId,(0,h.f)(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const r=(0,h.f)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,r),r}const r=this._gridSize,i=Math.round(e[0]/r),n=Math.round(e[1]/r),s=Math.round(e[2]/r),a=`${i}/${n}/${s}`;let l=this._origins.get(a);const c=.5*r;if((0,o.f)(_,e,t.vec3),_[0]=Math.abs(_[0]),_[1]=Math.abs(_[1]),_[2]=Math.abs(_[2]),_[0]<c&&_[1]<c&&_[2]<c){if(l){const t=Math.max(..._);if((0,o.f)(_,e,l.vec3),_[0]=Math.abs(_[0]),_[1]=Math.abs(_[1]),_[2]=Math.abs(_[2]),Math.max(..._)<t)return l}return t}return l||(l=(0,h.f)(i*r,n*r,s*r,a),this._origins.set(a,l)),l}_drawOriginBox(e,t=(0,s.f)(1,1,0,1)){const r=window.view,i=r._stage,o=t.toString();if(!this._objects.has(o)){this._material=new g.W({width:2,color:t}),i.add(this._material);const e=new m.x(i,{pickable:!1}),r=new u.B({castShadow:!1});i.add(r),e.add(r),this._objects.set(o,r)}const n=this._objects.get(o),h=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],p=h.length,v=new Array(3*p),_=new Array,y=.5*this._gridSize;for(let s=0;s<p;s++)v[3*s]=e[0]+(1&h[s]?y:-y),v[3*s+1]=e[1]+(2&h[s]?y:-y),v[3*s+2]=e[2]+(4&h[s]?y:-y),s>0&&_.push(s-1,s);(0,a.projectBuffer)(v,this._originSR,0,v,r.renderSpatialReference,0,p);const w=new d.V(this._material,[[f.r.POSITION,new l.n(v,_,3,!0)]],null,c.X.Line);i.add(w),n.addGeometry(w)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const _=(0,n.c)()},74515:(e,t,r)=>{r.d(t,{G7:()=>O,hz:()=>v});var i=r(37046),o=r(56192),n=r(21839),s=r(22279),a=r(25102),l=r(52712),c=r(32532),d=r(10714),h=r(44912),u=r(9286),p=r(99730),f=r(689);const m=1e-5;class g{constructor(e){this.options=new h.H6,this._results=new _,this.transform=new f.dg,this.tolerance=m,this.verticalOffset=null,this._ray=(0,c.vt)(),this._rayEnd=(0,s.c)(),this._rayBeginTransformed=(0,s.c)(),this._rayEndTransformed=(0,s.c)(),this.viewingMode=e??d.RT.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,r){this.resetWithRay((0,c.Cr)(e,t,this._ray),r)}resetWithRay(e,t){this.camera=t,e!==this._ray&&(0,c.C)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===d.RT.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,n.g)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,r,i,o){this.point=t,this.filterPredicate=i,this.tolerance=r??m;const n=(0,f.ou)(this.verticalOffset);if(e&&e.length>0){const t=o?e=>{o(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const r of e){const e=r.getSpatialQueryAccelerator?.();null!=e?(null!=n?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,n):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):r.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometries;if(!t)return;const r=e.effectiveTransformation,i=(0,f.ou)(this.verticalOffset);for(const s of t){if(!s.visible)continue;const{material:t,id:a}=s;this.transform.setAndInvalidateLazyTransforms(r,s.transformation),(0,n.e)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),(0,n.e)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;null!=i&&(i.objectTransform=this.transform),t.intersect(s,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,r,i,n,s,c)=>{if(t>=0){if(null!=this.filterPredicate&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;const d=n?this._results.hud:this._results,p=n?n=>{const l=new u.B$(e,a,i,c);n.set(h.dz.HUD,l,t,r,o.I,s)}:o=>o.set(h.dz.OBJECT,{object:e,geometryId:a,triangleNr:i},t,r,l,s);if((null==d.min.drapedLayerOrder||s>=d.min.drapedLayerOrder)&&(null==d.min.dist||t<d.min.dist)&&p(d.min),this.options.store!==h.oH.MIN&&(null==d.max.drapedLayerOrder||s<d.max.drapedLayerOrder)&&(null==d.max.dist||t>d.max.dist)&&p(d.max),this.options.store===h.oH.ALL)if(n){const e=new w(this._ray);p(e),this._results.hud.all.push(e)}else{const e=new y(this._ray);p(e),this._results.all.push(e)}}}))}}sortResults(e=this._results.all){e.sort(((e,t)=>e.dist!==t.dist?(e.dist??0)-(t.dist??0):e.drapedLayerOrder!==t.drapedLayerOrder?(e.drapedLayerOrder??Number.MAX_VALUE)-(t.drapedLayerOrder??Number.MAX_VALUE):(t.drapedLayerGraphicOrder??Number.MIN_VALUE)-(e.drapedLayerGraphicOrder??Number.MIN_VALUE)))}}function v(e){return new g(e)}class _{constructor(){this.min=new y((0,c.vt)()),this.max=new y((0,c.vt)()),this.hud={min:new w((0,c.vt)()),max:new w((0,c.vt)()),all:new Array},this.ground=new y((0,c.vt)()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}}class y{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,n.i)(T,this.ray.direction,this.dist),(0,n.l)(T)):null}getIntersectionPoint(e){return!!(0,p.i3)(this)&&((0,n.i)(T,this.ray.direction,this.dist),(0,n.g)(e,this.ray.origin,T),!0)}getTransformedNormal(e){return(0,n.c)(C,this.normal),C[3]=0,(0,a.t)(C,C,this.transformation),(0,n.c)(e,C),(0,n.n)(e,e)}constructor(e){this.intersector=h.dz.OBJECT,this.normal=(0,s.c)(),this.transformation=(0,o.a)(),this._ray=(0,c.vt)(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=h.dz.OBJECT,(0,c.C)(e,this._ray)}set(e,t,r,a,l,c,d){this.intersector=e,this.dist=r,(0,n.c)(this.normal,a??s.d),(0,i.h)(this.transformation,l??o.I),this.target=t,this.drapedLayerOrder=c,this.drapedLayerGraphicOrder=d}copy(e){(0,c.C)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,n.c)(this.normal,e.normal),(0,i.h)(this.transformation,e.transformation)}}class w extends y{constructor(){super(...arguments),this.intersector=h.dz.HUD}}function O(e){return new y(e)}const T=(0,s.c)(),C=(0,l.c)()},44912:(e,t,r)=>{var i,o;r.d(t,{H6:()=>n,dz:()=>i,oH:()=>o}),function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"}(i||(i={}));class n{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=o.ALL}}!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(o||(o={}))},9286:(e,t,r)=>{r.d(t,{B$:()=>n,R6:()=>a});var i=r(22279);class o{constructor(e,t,r){this.object=e,this.geometryId=t,this.triangleNr=r}}class n extends o{constructor(e,t,r,o){super(e,t,r),this.center=null!=o?(0,i.g)(o):null}}class s{constructor(e){this.layerUid=e}}class a extends s{constructor(e,t){super(e),this.graphicUid=t}}},32926:(e,t,r)=>{r.d(t,{f:()=>n});var i=r(22279);class o{constructor(e,t){this.vec3=e,this.id=t}}function n(e,t,r,n){return new o((0,i.f)(e,t,r),n)}},23183:(e,t,r)=>{var i,o;r.d(t,{k:()=>o,q:()=>i}),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(i||(i={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(o||(o={}))},55103:(e,t,r)=>{r.d(t,{B:()=>g});var i=r(37046),o=r(56192),n=r(21839),s=r(22279),a=r(96245),l=r(72699),c=r(91013),d=r(71077),h=r(52997),u=r(22775),p=r(58947),f=r(50645),m=r(29688);class g extends d.J{get geometries(){return this._geometries}get transformation(){return this._transformation??o.I}set transformation(e){this._transformation=(0,i.h)(this._transformation??(0,o.a)(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?(0,i.h)(this._shaderTransformation??(0,o.a)(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=h.X.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new v),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){(0,p.vA)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("geometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,r=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:t,sync:r}),(0,f.b)(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new u.X(c.Mg.MaskOccludee);for(const t of this._geometries)t.occludees=(0,m.Ci)(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=(0,m.PC)(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new u.X(c.Mg.Highlight);for(const t of this._geometries)t.highlights=(0,m.Ci)(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=(0,m.PC)(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return(0,i.m)(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=(0,o.a)()){return(0,i.m)(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new _,this._validateBoundingVolume(this._bvWorldSpace,S.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new _,this._validateBoundingVolume(this._bvObjectSpace,S.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,t){const r=t===S.ObjectSpace;for(const i of this._geometries){const t=i.boundingInfo;t&&y(t,e,r?i.transformation:this.getCombinedShaderTransformation(i))}(0,n.p)(e.bounds,e.min,e.max,.5);for(const i of this._geometries){const t=i.boundingInfo;if(null==t)continue;const o=r?i.transformation:this.getCombinedShaderTransformation(i),s=(0,l.hG)(o);(0,n.e)(C,t.center,o);const a=(0,n.o)(C,e.bounds),c=t.radius*s;e.bounds[3]=Math.max(e.bounds[3],a+c)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,t){this._parentLayer&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class v{constructor(){this.min=(0,s.f)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=(0,s.f)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class _ extends v{constructor(){super(...arguments),this.bounds=(0,a.c)()}}function y(e,t,r){const o=e.bbMin,s=e.bbMax;if((0,i.y)(r)){const e=(0,n.s)(w,r[12],r[13],r[14]);(0,n.g)(O,o,e),(0,n.g)(T,s,e);for(let r=0;r<3;++r)t.min[r]=Math.min(t.min[r],O[r]),t.max[r]=Math.max(t.max[r],T[r])}else if((0,n.e)(O,o,r),(0,n.h)(o,s))for(let i=0;i<3;++i)t.min[i]=Math.min(t.min[i],O[i]),t.max[i]=Math.max(t.max[i],O[i]);else{(0,n.e)(T,s,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],O[e],T[e]),t.max[e]=Math.max(t.max[e],O[e],T[e]);for(let e=0;e<3;++e){(0,n.c)(O,o),(0,n.c)(T,s),O[e]=s[e],T[e]=o[e],(0,n.e)(O,O,r),(0,n.e)(T,T,r);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],O[e],T[e]),t.max[e]=Math.max(t.max[e],O[e],T[e])}}}const w=(0,s.c)(),O=(0,s.c)(),T=(0,s.c)(),C=(0,s.c)();var S;!function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"}(S||(S={}))},91337:(e,t,r)=>{r.d(t,{A:()=>F});var i=r(90086),o=r(63678),n=r(21839),s=r(22279),a=r(94982),l=r(32532),c=r(96245),d=r(58947);class h{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new u,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),u.clearPool(),C[0]=null,A.prune(),N.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const r=u.acquire();for(let i=0;i<t;i++){const t=e[i];this._isDegenerate(t)?this._degenerateObjects.add(t):(r.init(this._root),this._add(t,r))}u.release(r)}remove(e,t=null){this._objectCount-=e.length;const r=u.acquire();for(const i of e){const e=null!=t?t:(0,c.h)(this.objectToBoundingSphere(i),E);y(e[3])?(r.init(this._root),this._remove(i,e,r)):this._degenerateObjects.delete(i)}u.release(r),this._shrink()}update(e,t){if(!y(t[3])&&this._isDegenerate(e))return;const r=function(e){return C[0]=e,C}(e);this.remove(r,t),this.add(r)}forEachAlongRay(e,t,r){const i=(0,l.LV)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(i,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,r,i){const o=(0,l.LV)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(o,e,i))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(o,e,i)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(o,e,i)&&r(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,r,i=()=>!0,o=1/0){let s=1/0,l=1/0,d=null;const h=v(e,t),u=n=>{if(--o,!i(n))return;const h=this.objectToBoundingSphere(n);if(!(0,a.m7)(r,h))return;const u=_(e,t,(0,c.g)(h)),p=u-h[3],f=u+h[3];p<s&&(s=p,l=f,d=n)};return this._forEachNodeDepthOrdered(this._root,(i=>{if(o<=0||!(0,a.m7)(r,i.bounds))return!1;if((0,n.i)(b,h,i.halfSize),(0,n.g)(b,b,i.bounds),_(e,t,b)>l)return!1;const s=i.node;return s.terminals.forAll((e=>u(e))),null!==s.residents&&s.residents.forAll((e=>u(e))),!0}),e,t),d}forEachInDepthRange(e,t,r,i,o,s,l){let d=-1/0,u=1/0;const p={setRange:e=>{r===h.DepthOrder.FRONT_TO_BACK?(d=Math.max(d,e.near),u=Math.min(u,e.far)):(d=Math.max(d,-e.far),u=Math.min(u,-e.near))}};p.setRange(i);const f=_(t,r,e),m=v(t,r),g=v(t,-r),y=e=>{if(!l(e))return;const i=this.objectToBoundingSphere(e),n=(0,c.g)(i),h=_(t,r,n)-f,m=h-i[3],g=h+i[3];m>u||g<d||!(0,a.m7)(s,i)||o(e,p)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!(0,a.m7)(s,e.bounds))return!1;if((0,n.i)(b,m,e.halfSize),(0,n.g)(b,b,e.bounds),_(t,r,b)-f>u)return!1;if((0,n.i)(b,g,e.halfSize),(0,n.g)(b,b,e.bounds),_(t,r,b)-f<d)return!1;const i=e.node;return i.terminals.forAll((e=>y(e))),null!==i.residents&&i.residents.forAll((e=>y(e))),!0}),t,r)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize,t.depth)))}forEachNeighbor(e,t){const r=(0,c.a)(t),i=(0,c.g)(t),o=t=>{const o=this.objectToBoundingSphere(t),s=(0,c.a)(o),a=r+s;return!((0,n.a)((0,c.g)(o),i)-a*a<=0)||e(t)};let s=!0;const a=e=>{s&&(s=o(e))};this._forEachNode(this._root,(e=>{const t=(0,c.a)(e.bounds),o=r+t;if((0,n.a)((0,c.g)(e.bounds),i)-o*o>0)return!1;const l=e.node;return l.terminals.forAll(a),s&&null!==l.residents&&l.residents.forAll(a),s})),s&&this.forEachDegenerateObject(a)}_intersectsNode(e,t){return m(t.bounds,2*-t.halfSize,x),m(t.bounds,2*t.halfSize,R),(0,d.O_)(e.origin,e.direction,x,R)}_intersectsNodeWithOffset(e,t,r){return m(t.bounds,2*-t.halfSize,x),m(t.bounds,2*t.halfSize,R),r.applyToMinMax(x,R),(0,d.O_)(e.origin,e.direction,x,R)}_intersectsObject(e,t){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||(0,c.j)(r,e)}_intersectsObjectWithOffset(e,t,r){const i=this.objectToBoundingSphere(t);return!(i[3]>0)||(0,c.j)(r.applyToBoundingSphere(i),e)}_forEachNode(e,t){let r=u.acquire().init(e);const i=[r];for(;0!==i.length;){if(r=i.pop(),t(r)&&!r.isLeaf())for(let e=0;e<r.node.children.length;e++)r.node.children[e]&&i.push(u.acquire().init(r).advance(e));u.release(r)}}_forEachNodeDepthOrdered(e,t,r,i=h.DepthOrder.FRONT_TO_BACK){let o=u.acquire().init(e);const n=[o];for(function(e,t,r){if(!N.length)for(let i=0;i<8;++i)N.push({index:0,distance:0});for(let i=0;i<8;++i){const r=w[i];N.data[i].index=i,N.data[i].distance=_(e,t,r)}N.sort(((e,t)=>e.distance-t.distance));for(let i=0;i<8;++i)r[i]=N.data[i].index}(r,i,L);0!==n.length;){if(o=n.pop(),t(o)&&!o.isLeaf())for(let e=7;e>=0;--e){const t=L[e];o.node.children[t]&&n.push(u.acquire().init(o).advance(t))}u.release(o)}}_remove(e,t,r){A.clear();const i=r.advanceTo(t,((e,t)=>{A.push(e.node),A.push(t)}))?r.node.terminals:r.node.residents;if(i.removeUnordered(e),0===i.length)for(let o=A.length-2;o>=0;o-=2){const e=A.data[o],t=A.data[o+1];if(!this._purge(e,t))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new o.A({shrink:!0})),!0)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let r=0;r<t.length;r++){const i=u.acquire().init(e);this._add(t.at(r),i),u.release(i)}}_grow(e,t){if(0!==t&&(g(e,t,(e=>this.objectToBoundingSphere(e)),P),y(P[3])&&!this._fitsInsideTree(P)))if(this._nodeIsEmpty(this._root.node))(0,c.h)(P,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(P);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(P,e):this._growRootAsSubNode(e),u.release(e)}}_rebuildTree(e,t){(0,n.c)(D,t.bounds),D[3]=t.halfSize,g([e,D],2,(e=>e),M);const r=u.acquire().init(this._root);this._root.initFrom(null,M,M[3]),this._root.increaseHalfSize(1.25),this._forEachNode(r,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),u.release(r)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,(e=>(r=Math.max(r,e.depth),r+t<=this._maximumDepth))),r+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],r=e;let i=-1/0;const o=this._root.bounds,n=this._root.halfSize;for(let a=0;a<3;a++){const e=o[a]-n-(r[a]-t),s=r[a]+t-(o[a]+n),l=Math.max(0,Math.ceil(e/(2*n))),c=Math.max(0,Math.ceil(s/(2*n)))+1,d=2**Math.ceil(Math.log(l+c)*Math.LOG2E);i=Math.max(i,d),I[a].min=l,I[a].max=c}for(let a=0;a<3;a++){let e=I[a].min,t=I[a].max;const r=(i-(e+t))/2;e+=Math.ceil(r),t+=Math.floor(r);const s=o[a]-n-e*n*2;S[a]=s+(t+e)*n}const s=i*n;return S[3]=s*T,u.acquire().initFrom(null,S,s,0)}_growRootAsSubNode(e){const t=this._root.node;(0,n.c)(P,this._root.bounds),P[3]=this._root.halfSize,this._root.init(e),e.advanceTo(P,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let r=0,i=0;for(;i<t.length&&null==e;)r=i++,e=t[r];for(;i<t.length;)if(t[i++])return-1;return r}_isDegenerate(e){return!y(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:r}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:r,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(e){const t=e.children.map((e=>e?this._nodeToJSON(e):null)),r=e.residents?.map((e=>this.objectToBoundingSphere(e))),i=e.terminals?.map((e=>this.objectToBoundingSphere(e)));return{children:t,residents:r,terminals:i}}static fromJSON(e){const t=new h((e=>e),{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class u{constructor(){this.bounds=(0,c.c)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,r,i=this.depth){return this.node=null!=e?e:u.createEmptyNode(),null!=t&&(0,c.h)(t,this.bounds),this.halfSize=r,this.depth=i,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*T}advance(e){let t=this.node.children[e];t||(t=u.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const r=w[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,r=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}const i=this._childIndex(e);t&&t(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new o.A({shrink:!0}),residents:new o.A({shrink:!0})}}static acquire(){return u._pool.acquire()}static release(e){u._pool.release(e)}static clearPool(){u._pool.prune()}}function p(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function f(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function m(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function g(e,t,r,i){if(1===t){const t=r(e[0]);(0,c.h)(t,i)}else{x[0]=1/0,x[1]=1/0,x[2]=1/0,R[0]=-1/0,R[1]=-1/0,R[2]=-1/0;for(let i=0;i<t;i++){const t=r(e[i]);y(t[3])&&(p(x,t),f(R,t))}(0,n.p)(i,x,R,.5),i[3]=Math.max(R[0]-x[0],R[1]-x[1],R[2]-x[2])/2}}function v(e,t){let r,i=1/0;for(let o=0;o<8;++o){const n=_(e,t,O[o]);n<i&&(i=n,r=O[o])}return r}function _(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function y(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}u._pool=new i.A(u),function(e){var t;(t=e.DepthOrder||(e.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(h||(h={}));const w=[(0,s.f)(-1,-1,-1),(0,s.f)(1,-1,-1),(0,s.f)(-1,1,-1),(0,s.f)(1,1,-1),(0,s.f)(-1,-1,1),(0,s.f)(1,-1,1),(0,s.f)(-1,1,1),(0,s.f)(1,1,1)],O=[(0,s.f)(-1,-1,-1),(0,s.f)(-1,-1,1),(0,s.f)(-1,1,-1),(0,s.f)(-1,1,1),(0,s.f)(1,-1,-1),(0,s.f)(1,-1,1),(0,s.f)(1,1,-1),(0,s.f)(1,1,1)],T=Math.sqrt(3),C=[null];const S=(0,c.c)(),b=(0,s.c)(),x=(0,s.c)(),R=(0,s.c)(),A=new o.A,E=(0,c.c)(),P=(0,c.c)(),D=(0,c.c)(),M=(0,c.c)(),I=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],N=new o.A,L=[0,0,0,0,0,0,0,0],F=h},2007:(e,t,r)=>{r.d(t,{$:()=>c});var i=r(65061),o=r(37046),n=r(56192),s=r(21839),a=r(96245),l=r(72699);class c{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=(0,n.a)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,i.L)(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,null!=t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){(0,o.h)(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){null==e?this._shaderTransformation=null:(this._shaderTransformation??=(0,n.a)(),(0,o.m)(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(null==this._boundingSphere&&(this._boundingSphere??=(0,a.c)(),(0,s.e)(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,l.hG)(this.shaderTransformation)),this._boundingSphere):a.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return null==this._shaderTransformation?this.transformation:this._shaderTransformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}},91080:(e,t,r)=>{var i;r.d(t,{q:()=>i}),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(i||(i={}))},11459:(e,t,r)=>{r.d(t,{Z:()=>o});var i=r(80976);class o extends i.Z{}},54671:(e,t,r)=>{r.d(t,{x:()=>u});var i=r(17306),o=r(1436),n=r(6267),s=r(63678),a=r(71077),l=r(52997);const c=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var d=r(91337),h=r(91080);class u extends a.J{get objects(){return this._objects}constructor(e,t,r=""){super(),this.stage=e,this.apiLayerUid=r,this.type=l.X.Layer,this.events=new i.A,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new s.A,this._objectsAdded=new s.A,this._handles=new o.A,this.apiLayerUid=r,this.visible=t?.visible??!0,this.pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??h.q.ASYNC,this._disableOctree=t?.disableOctree??!1,e.add(this);for(const i of c)this._handles.add(this.events.on(i,(t=>e.handleEvent(i,t))))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),null!=this._octree&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),null!=this._octree&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),null!=this._octree&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),null!=this._octree){for(let e=0;e<t.length;)this._objectsAdded.removeUnordered(t[e])?(t[e]=t[t.length-1],t.length-=1):++e;this._octree.remove(t)}}}sync(){this.updatePolicy!==h.q.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){null==this._octree||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return null==this._octree&&this._objects.length>50&&!this._disableOctree?(this._octree=new d.A((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):null!=this._octree&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=(0,n.pR)(this._octree),this._objectsAdded.clear()}}},99730:(e,t,r)=>{r.d(t,{i3:()=>o});r(21839);var i=r(22279);r(28769),r(44912);function o(e){return null!=e?.dist}(0,i.c)()},53834:(e,t,r)=>{r.d(t,{G:()=>i,Q:()=>o});const i={stableRendering:!1},o={rootOrigin:null}},32504:(e,t,r)=>{r.d(t,{v:()=>E});var i=r(39831),o=r(52712),n=r(11110),s=r(55274),a=r(91013),l=r(67341),c=r(1931),d=r(38323),h=r(50645),u=r(25146),p=r(52873),f=r(17745),m=r(47705),g=r(33444),v=r(13148),_=r(58123),y=r(98546),w=r(81868),O=r(17504),T=r(2449);f.S;class C extends g.w{initializeProgram(e){return new _.B(e.rctx,C.shader.get().build(this.configuration),v.D)}_createPipeline(e,t){const r=this.configuration,i=e===w.y.NONE,o=e===w.y.FrontFace;return(0,T.Ey)({blending:r.output!==s.V.Color&&r.output!==s.V.Alpha||!r.transparent?null:i?c.V0:(0,c.ez)(e),culling:(0,T.Xt)(r.cullFace),depthTest:{func:(0,c.K_)(e)},depthWrite:(i||o)&&r.writeDepth?T.kn:null,colorWrite:T.wE,stencilWrite:r.hasOccludees?y.v0:null,stencilTest:r.hasOccludees?t?y.a9:y.qh:null,polygonOffset:i||o?r.polygonOffset?S:null:(0,c.aB)(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}C.shader=new m.$(O.C,(()=>r.e(4788).then(r.bind(r,34788))));const S={factor:1,units:1};var b=r(66866),x=r(69948),R=r(9319);class A extends R.E{constructor(){super(...arguments),this.output=s.V.Color,this.cullFace=a.s2.None,this.transparencyPassType=w.y.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1}}(0,b._)([(0,x.W)({count:s.V.COUNT})],A.prototype,"output",void 0),(0,b._)([(0,x.W)({count:a.s2.COUNT})],A.prototype,"cullFace",void 0),(0,b._)([(0,x.W)({count:w.y.COUNT})],A.prototype,"transparencyPassType",void 0),(0,b._)([(0,x.W)()],A.prototype,"hasSlicePlane",void 0),(0,b._)([(0,x.W)()],A.prototype,"hasVertexColors",void 0),(0,b._)([(0,x.W)()],A.prototype,"transparent",void 0),(0,b._)([(0,x.W)()],A.prototype,"polygonOffset",void 0),(0,b._)([(0,x.W)()],A.prototype,"enableOffset",void 0),(0,b._)([(0,x.W)()],A.prototype,"writeDepth",void 0),(0,b._)([(0,x.W)()],A.prototype,"hasOccludees",void 0),(0,b._)([(0,x.W)()],A.prototype,"multipassEnabled",void 0),(0,b._)([(0,x.W)()],A.prototype,"cullAboveGround",void 0),(0,b._)([(0,x.W)()],A.prototype,"objectAndLayerIdColorInstanced",void 0),(0,b._)([(0,x.W)()],A.prototype,"vvColor",void 0),(0,b._)([(0,x.W)({constValue:!1})],A.prototype,"occlusionPass",void 0),(0,b._)([(0,x.W)({constValue:!0})],A.prototype,"hasVvInstancing",void 0),(0,b._)([(0,x.W)({constValue:!1})],A.prototype,"vvSize",void 0),(0,b._)([(0,x.W)({constValue:!1})],A.prototype,"vvOpacity",void 0);class E extends p.W{constructor(e){super(e,new D),this.supportsEdges=!0,this._configuration=new A}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<c.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}produces(e,t){return!!(t===s.V.Color||t===s.V.Alpha||t===s.V.Highlight||t===s.V.Depth&&this.parameters.writeLinearDepth||t===s.V.ObjectAndLayerIdColor)&&(e===d.N.DRAPED_MATERIAL||(t===s.V.Highlight?e===d.N.OPAQUE_MATERIAL:e===(this._isTransparent?this.parameters.writeDepth?d.N.TRANSPARENT_MATERIAL:d.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:d.N.OPAQUE_MATERIAL)))}createGLMaterial(e){return new P(e)}createBufferWriter(){const e=(0,n.BP)().vec3f(h.r.POSITION);return(0,i.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(h.r.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(h.r.COLORFEATUREATTRIBUTE):e.vec4u8(h.r.COLOR),new u.Z(e)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}}class P extends l.A{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==s.V.Color&&this._output!==s.V.Alpha||this._updateOccludeeState(e),this.ensureTechnique(C,e)}}class D extends f.S{constructor(){super(...arguments),this.color=o.Z,this.forceTransparentMode=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=a.s2.None,this.hasOccludees=!1}}},27776:(e,t,r)=>{r.d(t,{Ci:()=>n,Dq:()=>l,dB:()=>a,zK:()=>s});var i=r(11110),o=r(50645);const n=(0,i.BP)().vec3f(o.r.POSITION),s=(0,i.BP)().vec3f(o.r.POSITION).vec2f(o.r.UV0),a=(0,i.BP)().vec3f(o.r.POSITION).vec4u8(o.r.COLOR),l=((0,i.BP)().vec3f(o.r.POSITION).vec4u8(o.r.OBJECTANDLAYERIDCOLOR),(0,i.BP)().vec3f(o.r.POSITION).vec2f(o.r.UV0).vec4u8(o.r.OBJECTANDLAYERIDCOLOR));(0,i.BP)().vec3f(o.r.POSITION).vec4u8(o.r.COLOR).vec4u8(o.r.OBJECTANDLAYERIDCOLOR)},62331:(e,t,r)=>{r.d(t,{R:()=>$});var i=r(39831),o=r(92504),n=r(46615),s=r(76287),a=r(37046),l=r(56192),c=r(58680),d=r(78286),h=r(21839),u=r(22279),p=r(52712);function f(e){return function(e){return e instanceof Float32Array&&e.length>=16}(e)||function(e){return Array.isArray(e)&&e.length>=16}(e)}var m=r(80510),g=r(57813),v=r(69463),_=r(19620),y=r(11110),w=r(55274),O=r(97085),T=r(89140),C=r(45722),S=r(38323),b=r(28953),x=r(58947),R=r(50645);class A{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var E=r(81500),P=r(29117),D=r(69726),M=r(10714),I=r(47705),N=r(33444),L=r(13148),F=r(1931),H=r(58123),V=r(81868),z=r(41746),j=r(2449);class W extends N.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===M.RT.Global}initializeProgram(e){return new H.B(e.rctx,W.shader.get().build(this.configuration),L.D)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,r=e===V.y.NONE,i=e===V.y.FrontFace,o=this.configuration.hasPolygonOffset?U:null,n=(r||i)&&t.output!==w.V.Highlight&&(t.depthEnabled||t.occlusionPass)?j.kn:null;return(0,j.Ey)({blending:t.output===w.V.Color||t.output===w.V.Alpha||t.output===w.V.Highlight?r?B:(0,F.ez)(e):null,depthTest:{func:z.MT.LEQUAL},depthWrite:n,colorWrite:j.wE,polygonOffset:o})}get primitiveType(){return this.configuration.occlusionPass?z.WR.POINTS:z.WR.TRIANGLES}}W.shader=new I.$(D.H,(()=>r.e(5466).then(r.bind(r,35466))));const U={factor:0,units:-4},B=(0,j.ox)(z.dn.ONE,z.dn.ONE_MINUS_SRC_ALPHA);var G=r(66866),k=r(69948),q=r(9319);class Z extends q.E{constructor(){super(...arguments),this.output=w.V.Color,this.transparencyPassType=V.y.NONE,this.screenCenterOffsetUnitsEnabled=!1,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}}(0,G._)([(0,k.W)({count:w.V.COUNT})],Z.prototype,"output",void 0),(0,G._)([(0,k.W)({count:V.y.COUNT})],Z.prototype,"transparencyPassType",void 0),(0,G._)([(0,k.W)()],Z.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,G._)([(0,k.W)()],Z.prototype,"spherical",void 0),(0,G._)([(0,k.W)()],Z.prototype,"occlusionTestEnabled",void 0),(0,G._)([(0,k.W)()],Z.prototype,"signedDistanceFieldEnabled",void 0),(0,G._)([(0,k.W)()],Z.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,G._)([(0,k.W)()],Z.prototype,"vvSize",void 0),(0,G._)([(0,k.W)()],Z.prototype,"vvColor",void 0),(0,G._)([(0,k.W)()],Z.prototype,"hasVerticalOffset",void 0),(0,G._)([(0,k.W)()],Z.prototype,"hasScreenSizePerspective",void 0),(0,G._)([(0,k.W)()],Z.prototype,"debugDrawLabelBorder",void 0),(0,G._)([(0,k.W)()],Z.prototype,"hasSlicePlane",void 0),(0,G._)([(0,k.W)()],Z.prototype,"hasPolygonOffset",void 0),(0,G._)([(0,k.W)()],Z.prototype,"depthEnabled",void 0),(0,G._)([(0,k.W)()],Z.prototype,"pixelSnappingEnabled",void 0),(0,G._)([(0,k.W)()],Z.prototype,"draped",void 0),(0,G._)([(0,k.W)()],Z.prototype,"multipassEnabled",void 0),(0,G._)([(0,k.W)()],Z.prototype,"cullAboveGround",void 0),(0,G._)([(0,k.W)()],Z.prototype,"occlusionPass",void 0),(0,G._)([(0,k.W)()],Z.prototype,"objectAndLayerIdColorInstanced",void 0),(0,G._)([(0,k.W)({constValue:!0})],Z.prototype,"hasSliceInVertexProgram",void 0),(0,G._)([(0,k.W)({constValue:!1})],Z.prototype,"hasVvInstancing",void 0);class $ extends C.im{constructor(e){super(e,new me),this._configuration=new Z}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.isDraped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===S.N.OCCLUSION_PIXELS&&this.parameters.occlusionTest&&(e===w.V.Color||e===w.V.Alpha),e===w.V.Color&&(this._configuration.debugDrawLabelBorder=!!_.b.LABELS_SHOW_BORDER),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(e,t,r,i,o,s){if(!(r.options.selectionMode&&r.options.hud&&e.visible&&r.point))return;const l=this.parameters,c=r.point,d=r.camera;let{scaleX:p,scaleY:f}=this._getScreenScale(e);p*=d.pixelRatio,f*=d.pixelRatio,(0,n.f)(oe,t),e.attributes.has(R.r.FEATUREATTRIBUTE)&&function(e){const t=e[0],r=e[1],i=e[2],o=e[3],n=e[4],s=e[5],a=e[6],l=e[7],c=e[8],d=1/Math.sqrt(t*t+r*r+i*i),h=1/Math.sqrt(o*o+n*n+s*s),u=1/Math.sqrt(a*a+l*l+c*c);e[0]=t*d,e[1]=r*d,e[2]=i*d,e[3]=o*h,e[4]=n*h,e[5]=s*h,e[6]=a*u,e[7]=l*u,e[8]=c*u}(oe);const m=e.attributes.get(R.r.POSITION),g=e.attributes.get(R.r.SIZE),v=e.attributes.get(R.r.NORMAL),_=e.attributes.get(R.r.AUXPOS1);(0,x.vA)(m.size>=3);const y=(0,D.c)(l),w="screen"===this.parameters.centerOffsetUnits;for(let n=0;n<m.data.length/m.size;n++){const e=n*m.size;(0,h.s)(K,m.data[e],m.data[e+1],m.data[e+2]),(0,h.e)(K,K,t);const i=n*g.size;pe[0]=g.data[i]*p,pe[1]=g.data[i+1]*f,(0,h.e)(K,K,d.viewMatrix);const o=n*_.size;if((0,h.s)(ae,_.data[o],_.data[o+1],_.data[o+2]),!w&&(K[0]+=ae[0],K[1]+=ae[1],0!==ae[2])){const e=ae[2];(0,h.n)(ae,K),(0,h.f)(K,K,(0,h.i)(ae,ae,e))}const O=n*v.size;if((0,h.s)(ee,v.data[O],v.data[O+1],v.data[O+2]),this._normalAndViewAngle(ee,oe,d,de),this._applyVerticalOffsetTransformationView(K,de,d,Q),d.applyProjection(K,te),te[0]>-1){w&&(ae[0]||ae[1])&&(te[0]+=ae[0]*d.pixelRatio,0!==ae[1]&&(te[1]+=(0,b.m0)(ae[1],Q.factorAlignment)*d.pixelRatio),d.unapplyProjection(te,K)),te[0]+=this.parameters.screenOffset[0]*d.pixelRatio,te[1]+=this.parameters.screenOffset[1]*d.pixelRatio,te[0]=Math.floor(te[0]),te[1]=Math.floor(te[1]),(0,b.MD)(pe,Q.factor,pe);const e=he*d.pixelRatio;let t=0;if(l.textureIsSignedDistanceField&&(t=l.outlineSize*d.pixelRatio/2),Y(c,te[0],te[1],pe,e,t,l,y)){const e=r.ray;if((0,h.e)(ie,K,(0,a.i)(se,d.viewMatrix)),te[0]=c[0],te[1]=c[1],d.unprojectFromRenderScreen(te,K)){const t=(0,u.c)();(0,h.c)(t,e.direction);const r=1/(0,h.l)(t);(0,h.i)(t,t,r),s((0,h.o)(e.origin,K)*r,t,-1,!0,1,ie)}}}}}intersectDraped(e,t,r,i,o,n){const s=e.attributes.get(R.r.POSITION),a=e.attributes.get(R.r.SIZE),l=this.parameters,c=(0,D.c)(l);let{scaleX:d,scaleY:h}=this._getScreenScale(e);d*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const u=ue*e.screenToWorldRatio;for(let p=0;p<s.data.length/s.size;p++){const t=p*s.size,r=s.data[t],f=s.data[t+1],m=p*a.size;pe[0]=a.data[m]*d,pe[1]=a.data[m+1]*h;let g=0;l.textureIsSignedDistanceField&&(g=l.outlineSize*e.screenToWorldRatio/2),Y(i,r,f,pe,u,g,l,c)&&o(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new _e(this)}_normalAndViewAngle(e,t,r,i){return f(t)&&(t=(0,n.f)(ne,t)),(0,h.t)(i.normal,e,t),(0,h.e)(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=(0,h.j)(re,fe),i}_updateScaleInfo(e,t,r){const i=this.parameters;null!=i.screenSizePerspective?(0,b.cJ)(r,t,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),null!=i.screenSizePerspectiveAlignment?(0,b.cJ)(r,t,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,t,r,i,o,n,s){const a=this._normalAndViewAngle(t,r,o,de);return this._applyVerticalGroundOffsetView(e,a,o,s),this._applyVerticalOffsetTransformationView(s,a,o,n),this._applyPolygonOffsetView(s,a,i[3],o,s),this._applyCenterOffsetView(s,i,s),s}applyShaderOffsetsNDC(e,t,r,i,o){return this._applyCenterOffsetNDC(e,t,r,i),null!=o&&(0,h.c)(o,i),this._applyPolygonOffsetNDC(i,t,r,i),i}_applyPolygonOffsetView(e,t,r,i,n){const s=i.aboveGround?1:-1;let a=Math.sign(r);0===a&&(a=s);const l=s*a;if(this.parameters.shaderPolygonOffset<=0)return(0,h.c)(n,e);const c=(0,o.qE)(Math.abs(t.cosAngle),.01,1),d=1-Math.sqrt(1-c*c)/c/i.viewport[2];return(0,h.i)(n,e,l>0?d:1/d),n}_applyVerticalGroundOffsetView(e,t,r,i){const o=(0,h.l)(e),n=r.aboveGround?1:-1,s=r.computeRenderPixelSizeAtDist(o)*O.R,a=(0,h.i)(K,t.normal,n*s);return(0,h.g)(i,e,a),i}_applyVerticalOffsetTransformationView(e,t,r,i){const o=this.parameters;if(!o.verticalOffset?.screenLength){if(o.screenSizePerspective||o.screenSizePerspectiveAlignment){const r=(0,h.l)(e);this._updateScaleInfo(i,r,t.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}const n=(0,h.l)(e),s=o.screenSizePerspectiveAlignment??o.screenSizePerspective,a=(0,P.kE)(r,n,o.verticalOffset,t.cosAngle,s);return this._updateScaleInfo(i,n,t.cosAngle),(0,h.i)(t.normal,t.normal,a),(0,h.g)(e,e,t.normal)}_applyCenterOffsetView(e,t,r){const i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,h.c)(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&((0,h.n)(ee,r),(0,h.g)(r,r,(0,h.i)(ee,ee,t[2])))),r}_applyCenterOffsetNDC(e,t,r,i){const o="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,h.c)(i,e),o||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i}_applyPolygonOffsetNDC(e,t,r,i){const o=this.parameters.shaderPolygonOffset;if(e!==i&&(0,h.c)(i,e),o){const e=r.aboveGround?1:-1,n=e*Math.sign(t[3]);i[2]-=(n||e)*o}return i}produces(e,t){if(t===w.V.Color||t===w.V.Alpha||t===w.V.Highlight||t===w.V.ObjectAndLayerIdColor){if(e===S.N.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:t,occlusionTest:r}=this.parameters;return e===(t?S.N.LABEL_MATERIAL:S.N.HUD_MATERIAL)||r&&e===S.N.OCCLUSION_PIXELS}return!1}createGLMaterial(e){return new X(e)}calculateRelativeScreenBounds(e,t,r=(0,m.vt)()){return function(e,t,r,i=J){(0,c.j)(i,e.anchorPosition),i[0]*=-t[0],i[1]*=-t[1],i[0]+=e.screenOffset[0]*r,i[1]+=e.screenOffset[1]*r}(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}_getScreenScale(e){const t=e.attributes.get(R.r.FEATUREATTRIBUTE);if(null==t)return{scaleX:1,scaleY:1};const r=(0,p.b)(t.data,ce),[i,o]=(0,v.VC)(le,this.parameters,r);return{scaleX:i,scaleY:o}}}class X extends T.m{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(W,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}}function Y(e,t,r,i,o,n,s,a){let l=t-o-(a[0]>0?i[0]*a[0]:0),c=l+i[0]+2*o,d=r-o-(a[1]>0?i[1]*a[1]:0),h=d+i[1]+2*o;const u=s.distanceFieldBoundingBox;return s.textureIsSignedDistanceField&&null!=u&&(l+=i[0]*u[0],d+=i[1]*u[1],c-=i[0]*(1-u[2]),h-=i[1]*(1-u[3]),l-=n,c+=n,d-=n,h+=n),e[0]>l&&e[0]<c&&e[1]>d&&e[1]<h}const Q=new class{constructor(){this.factor=new A,this.factorAlignment=new A}},J=(0,d.a)(),K=(0,u.c)(),ee=(0,u.c)(),te=(0,p.c)(),re=(0,u.c)(),ie=(0,u.c)(),oe=(0,s.a)(),ne=(0,s.a)(),se=(0,l.a)(),ae=(0,u.c)(),le=(0,p.c)(),ce=(0,p.c)(),de={normal:re,cosAngle:0},he=1,ue=2,pe=[0,0],fe=(0,u.f)(0,0,1);class me extends T.N{constructor(){super(...arguments),this.renderOccluded=C.m$.Occlude,this.isDecoration=!1,this.color=(0,p.f)(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=(0,d.f)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,p.f)(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.isDraped=!1}}const ge=(0,y.BP)().vec3f(R.r.POSITION).vec3f(R.r.NORMAL).vec2f(R.r.UV0).vec4u8(R.r.COLOR).vec2f(R.r.SIZE).vec4f(R.r.AUXPOS1).vec4f(R.r.FEATUREATTRIBUTE),ve=ge.clone().vec4u8(R.r.OBJECTANDLAYERIDCOLOR);class _e{constructor(e){this._material=e,this.vertexBufferLayout=(0,i.A)("enable-feature:objectAndLayerId-rendering")?ve:ge}elementCount(e){return 6*e.attributes.get(R.r.POSITION).indices.length}write(e,t,r,i,o){(0,E.Hk)(r.attributes.get(R.r.POSITION),e,i.position,o,6),(0,E.p1)(r.attributes.get(R.r.NORMAL),t,i.normal,o,6);const n=r.attributes.get(R.r.UV0).data;let s,a,l,c;if(null==n||n.length<4){const e=this._material.parameters;s=0,a=0,l=e.texCoordScale[0],c=e.texCoordScale[1]}else s=n[0],a=n[1],l=n[2],c=n[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);let d=r.attributes.get(R.r.POSITION).indices.length,h=o;const u=i.uv0;for(let g=0;g<d;++g)u.set(h,0,s),u.set(h,1,a),h++,u.set(h,0,l),u.set(h,1,a),h++,u.set(h,0,l),u.set(h,1,c),h++,u.set(h,0,l),u.set(h,1,c),h++,u.set(h,0,s),u.set(h,1,c),h++,u.set(h,0,s),u.set(h,1,a),h++;(0,E.tb)(r.attributes.get(R.r.COLOR),4,i.color,o,6);const{data:p,indices:f}=r.attributes.get(R.r.SIZE);d=f.length;const m=i.size;h=o;for(let g=0;g<d;++g){const e=p[2*f[g]],t=p[2*f[g]+1];for(let r=0;r<6;++r)m.set(h,0,e),m.set(h,1,t),h++}if(r.attributes.get(R.r.AUXPOS1)?(0,E.Ut)(r.attributes.get(R.r.AUXPOS1),i.auxpos1,o,6):(0,E.Pq)(i.auxpos1,o,6*d),r.attributes.get(R.r.FEATUREATTRIBUTE)?(0,E.Ut)(r.attributes.get(R.r.FEATUREATTRIBUTE),i.featureAttribute,o,6):(0,E.Pq)(i.featureAttribute,o,6*d),null!=r.objectAndLayerIdColor){const e=r.attributes.get(R.r.POSITION)?.indices;if(e){const t=e.length,n=i.getField(R.r.OBJECTANDLAYERIDCOLOR,g.XP);(0,E.tH)(r.objectAndLayerIdColor,n,t,o,6)}}}}},96824:(e,t,r)=>{r.d(t,{W:()=>H});var i=r(39831),o=r(539),n=r(92504),s=r(89882),a=r(58680),l=r(21839),c=r(22279),d=r(52712),h=r(94982),u=r(22759),p=r(38774),f=r(11110),m=r(55274),g=r(67341),v=r(45722),_=r(38323),y=r(58947),w=r(50645),O=r(17745),T=r(58376),C=r(50126),S=r(47705),b=r(33444),x=r(1931),R=r(58123),A=r(98546),E=r(81868),P=r(41746),D=r(2449);const M=new Map([[w.r.POSITION,0],[w.r.SUBDIVISIONFACTOR,1],[w.r.UV0,2],[w.r.AUXPOS1,3],[w.r.AUXPOS2,4],[w.r.COLOR,5],[w.r.COLORFEATUREATTRIBUTE,5],[w.r.SIZE,6],[w.r.SIZEFEATUREATTRIBUTE,6],[w.r.OPACITYFEATUREATTRIBUTE,7],[w.r.OBJECTANDLAYERIDCOLOR,8]]);class I extends b.w{initializeProgram(e){return new R.B(e.rctx,I.shader.get().build(this.configuration),M)}_makePipelineState(e,t){const r=this.configuration,i=e===E.y.NONE,o=e===E.y.FrontFace;return(0,D.Ey)({blending:r.output===m.V.Color||r.output===m.V.Alpha?i?x.V0:(0,x.ez)(e):null,depthTest:{func:(0,x.K_)(e)},depthWrite:i?r.writeDepth?D.kn:null:(0,x.XO)(e),colorWrite:D.wE,stencilWrite:r.hasOccludees?A.v0:null,stencilTest:r.hasOccludees?t?A.a9:A.qh:null,polygonOffset:i||o?r.hasPolygonOffset?N:null:x.SE})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?N:null;this._occluderPipelineTransparent=(0,D.Ey)({blending:x.V0,polygonOffset:t,depthTest:A.sf,depthWrite:null,colorWrite:D.wE,stencilWrite:null,stencilTest:A.mK}),this._occluderPipelineOpaque=(0,D.Ey)({blending:x.V0,polygonOffset:t,depthTest:A.sf,depthWrite:null,colorWrite:D.wE,stencilWrite:A.r8,stencilTest:A.I$}),this._occluderPipelineMaskWrite=(0,D.Ey)({blending:null,polygonOffset:t,depthTest:A.m,depthWrite:null,colorWrite:null,stencilWrite:A.v0,stencilTest:A.a9})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?P.WR.LINES:P.WR.TRIANGLE_STRIP}getPipeline(e,t,r){return e?this._occludeePipelineState:this.configuration.occluder?r?this._occluderPipelineTransparent:t?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}}I.shader=new S.$(C.R,(()=>r.e(7274).then(r.bind(r,97274))));const N={factor:0,units:-4};var L,F=r(16906);!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(L||(L={}));class H extends v.im{constructor(e){super(e,new z),this._configuration=new F.Q,this._vertexAttributeLocations=M}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===_.N.DRAPED_MATERIAL;const r=null!=this.parameters.stipplePattern&&e!==m.V.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&null!=this.parameters.stippleOffColor,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=null!=this.parameters.markerParameters&&function(e){return e.anchor===T.kJ.Tip&&e.hideOnShortSegments&&"begin-end"===e.placement&&e.worldSpace}(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&null!=this.parameters.innerColor,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===v.m$.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,r,i,o,s){if(!r.options.selectionMode)return;const a=e.attributes.get(w.r.POSITION).data,l=e.attributes.get(w.r.SIZE);let c=this.parameters.width;if(this.parameters.vvSize){const t=e.attributes.get(w.r.SIZEFEATUREATTRIBUTE).data[0];c*=(0,n.qE)(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else l&&(c*=l.data[0]);const d=i[0],h=i[1],u=(c/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE,f=0;for(let m=0;m<a.length-5;m+=3){const e=a[m],t=a[m+1],r=d-e,i=h-t,o=a[m+3]-e,s=a[m+4]-t,l=(0,n.qE)((o*r+s*i)/(o*o+s*s),0,1),c=o*l-r,u=s*l-i,g=c*c+u*u;g<p&&(p=g,f=m/3)}p<u*u&&o(s.dist,s.normal,f,!1)}intersect(e,t,r,i,s,c){if(!r.options.selectionMode||!e.visible)return;if(!(0,y.zH)(t))return void o.A.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const d=e.attributes,f=d.get(w.r.POSITION).data;let m=this.parameters.width;if(this.parameters.vvSize){const e=d.get(w.r.SIZEFEATUREATTRIBUTE).data[0];m*=(0,n.qE)(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else d.has(w.r.SIZE)&&(m*=d.get(w.r.SIZE).data[0]);const g=r.camera,v=Z;(0,a.j)(v,r.point);const _=m*g.pixelRatio/2+4*g.pixelRatio;(0,l.s)(ie[0],v[0]-_,v[1]+_,0),(0,l.s)(ie[1],v[0]+_,v[1]+_,0),(0,l.s)(ie[2],v[0]+_,v[1]-_,0),(0,l.s)(ie[3],v[0]-_,v[1]-_,0);for(let o=0;o<4;o++)if(!g.unprojectFromRenderScreen(ie[o],oe[o]))return;(0,p.Cr)(g.eye,oe[0],oe[1],ne),(0,p.Cr)(g.eye,oe[1],oe[2],se),(0,p.Cr)(g.eye,oe[2],oe[3],ae),(0,p.Cr)(g.eye,oe[3],oe[0],le);let O=Number.MAX_VALUE,T=0;const C=U(this.parameters,d)?f.length-2:f.length-5;for(let o=0;o<C;o+=3){B[0]=f[o]+t[12],B[1]=f[o+1]+t[13],B[2]=f[o+2]+t[14];const e=(o+3)%f.length;if(G[0]=f[e]+t[12],G[1]=f[e+1]+t[13],G[2]=f[e+2]+t[14],(0,p.mN)(ne,B)<0&&(0,p.mN)(ne,G)<0||(0,p.mN)(se,B)<0&&(0,p.mN)(se,G)<0||(0,p.mN)(ae,B)<0&&(0,p.mN)(ae,G)<0||(0,p.mN)(le,B)<0&&(0,p.mN)(le,G)<0)continue;if(g.projectToRenderScreen(B,$),g.projectToRenderScreen(G,X),$[2]<0&&X[2]>0){(0,l.f)(k,B,G);const e=g.frustum,t=-(0,p.mN)(e[h.FB.NEAR],B)/(0,l.j)(k,(0,p.qb)(e[h.FB.NEAR]));(0,l.i)(k,k,t),(0,l.g)(B,B,k),g.projectToRenderScreen(B,$)}else if($[2]>0&&X[2]<0){(0,l.f)(k,G,B);const e=g.frustum,t=-(0,p.mN)(e[h.FB.NEAR],G)/(0,l.j)(k,(0,p.qb)(e[h.FB.NEAR]));(0,l.i)(k,k,t),(0,l.g)(G,G,k),g.projectToRenderScreen(G,X)}else if($[2]<0&&X[2]<0)continue;$[2]=0,X[2]=0;const r=(0,u.kb)((0,u.Cr)($,X,J),v);r<O&&(O=r,(0,l.c)(Y,B),(0,l.c)(Q,G),T=o/3)}const S=r.rayBegin,b=r.rayEnd;if(O<_*_){let e=Number.MAX_VALUE;if((0,u.ld)((0,u.Cr)(Y,Q,J),(0,u.Cr)(S,b,K),q)){(0,l.f)(q,q,S);const t=(0,l.l)(q);(0,l.i)(q,q,1/t),e=t/(0,l.o)(S,b)}c(e,q,T,!1)}}get _layout(){const e=(0,f.BP)().vec3f(w.r.POSITION).f32(w.r.SUBDIVISIONFACTOR).vec2f(w.r.UV0).vec3f(w.r.AUXPOS1).vec3f(w.r.AUXPOS2);return this.parameters.vvSize?e.f32(w.r.SIZEFEATUREATTRIBUTE):e.f32(w.r.SIZE),this.parameters.vvColor?e.f32(w.r.COLORFEATUREATTRIBUTE):e.vec4f(w.r.COLOR),this.parameters.vvOpacity&&e.f32(w.r.OPACITYFEATUREATTRIBUTE),(0,i.A)("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(w.r.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new j(this._layout,this.parameters)}produces(e,t){return(t===m.V.Color||t===m.V.Alpha||t===m.V.Highlight||t===m.V.Depth||t===m.V.ObjectAndLayerIdColor)&&(e===_.N.DRAPED_MATERIAL||(this.parameters.renderOccluded===v.m$.OccludeAndTransparentStencil?e===_.N.OPAQUE_MATERIAL||e===_.N.OCCLUDER_MATERIAL||e===_.N.TRANSPARENT_OCCLUDER_MATERIAL:t===m.V.Color||t===m.V.Alpha?e===(this.parameters.writeDepth?_.N.TRANSPARENT_MATERIAL:_.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===_.N.OPAQUE_MATERIAL))}createGLMaterial(e){return new V(e)}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),null!=e.markerParameters&&(e.markerScale=e.markerParameters.width/e.width)}}class V extends g.A{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==m.V.Color&&this._output!==m.V.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.ensureTechnique(I,e)}}class z extends O.S{constructor(){super(...arguments),this.width=0,this.color=d.O,this.join="miter",this.cap=F.x.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class j{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t,this.numJoinSubdivisions=0;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=C.r+r}}_isClosed(e){return U(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.attributes.get(w.r.POSITION).indices.length/2+1,r=this._isClosed(e);let i=r?2:4;return i+=((r?t:t-1)-(r?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(e,t,r,o,n){const s=ee,a=te,c=re,d=r.attributes.get(w.r.POSITION),h=d.indices,u=d.data.length/3,p=r.attributes.get(w.r.DISTANCETOSTART)?.data;h&&h.length!==2*(u-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,m=0;const g=this.vertexBufferLayout.fields.has(w.r.SIZEFEATUREATTRIBUTE);g?m=r.attributes.get(w.r.SIZEFEATUREATTRIBUTE).data[0]:r.attributes.has(w.r.SIZE)&&(f=r.attributes.get(w.r.SIZE).data[0]);let v=[1,1,1,1],_=0;const y=this.vertexBufferLayout.fields.has(w.r.COLORFEATUREATTRIBUTE);y?_=r.attributes.get(w.r.COLORFEATUREATTRIBUTE).data[0]:r.attributes.has(w.r.COLOR)&&(v=r.attributes.get(w.r.COLOR).data);const O=(0,i.A)("enable-feature:objectAndLayerId-rendering")?r.objectAndLayerIdColor:null;let T=0;const C=this.vertexBufferLayout.fields.has(w.r.OPACITYFEATUREATTRIBUTE);C&&(T=r.attributes.get(w.r.OPACITYFEATUREATTRIBUTE).data[0]);const S=new Float32Array(o.buffer),b=(0,i.A)("enable-feature:objectAndLayerId-rendering")?new Uint8Array(o.buffer):null,x=this.vertexBufferLayout.stride/4;let R=n*x;const A=R;let E=0;const P=p?(e,t,r)=>E=p[r]:(e,t,r)=>E+=(0,l.o)(e,t),D=(0,i.A)("enable-feature:objectAndLayerId-rendering"),M=(e,t,r,i,o,n,s)=>{if(S[R++]=t[0],S[R++]=t[1],S[R++]=t[2],S[R++]=i,S[R++]=s,S[R++]=o,S[R++]=e[0],S[R++]=e[1],S[R++]=e[2],S[R++]=r[0],S[R++]=r[1],S[R++]=r[2],S[R++]=g?m:f,y)S[R++]=_;else{const e=Math.min(4*n,v.length-4);S[R++]=v[e],S[R++]=v[e+1],S[R++]=v[e+2],S[R++]=v[e+3]}C&&(S[R++]=T),D&&(null!=O&&(b[4*R]=O[0],b[4*R+1]=O[1],b[4*R+2]=O[2],b[4*R+3]=O[3]),R++)};R+=x,(0,l.s)(a,d.data[0],d.data[1],d.data[2]),e&&(0,l.e)(a,a,e);const I=this._isClosed(r);if(I){const t=d.data.length-3;(0,l.s)(s,d.data[t],d.data[t+1],d.data[t+2]),e&&(0,l.e)(s,s,e)}else(0,l.s)(c,d.data[3],d.data[4],d.data[5]),e&&(0,l.e)(c,c,e),M(a,a,c,1,L.LEFT_CAP_START,0,0),M(a,a,c,1,L.RIGHT_CAP_START,0,0),(0,l.c)(s,a),(0,l.c)(a,c);const N=I?0:1,F=I?u:u-1;for(let i=N;i<F;i++){const t=(i+1)%u*3;(0,l.s)(c,d.data[t],d.data[t+1],d.data[t+2]),e&&(0,l.e)(c,c,e),P(s,a,i),M(s,a,c,0,L.LEFT_JOIN_END,i,E),M(s,a,c,0,L.RIGHT_JOIN_END,i,E);const r=this.numJoinSubdivisions;for(let e=0;e<r;++e){const t=(e+1)/(r+1);M(s,a,c,t,L.LEFT_JOIN_END,i,E),M(s,a,c,t,L.RIGHT_JOIN_END,i,E)}M(s,a,c,1,L.LEFT_JOIN_START,i,E),M(s,a,c,1,L.RIGHT_JOIN_START,i,E),(0,l.c)(s,a),(0,l.c)(a,c)}I?((0,l.s)(c,d.data[3],d.data[4],d.data[5]),e&&(0,l.e)(c,c,e),E=P(s,a,F),M(s,a,c,0,L.LEFT_JOIN_END,N,E),M(s,a,c,0,L.RIGHT_JOIN_END,N,E)):(E=P(s,a,F),M(s,a,a,0,L.LEFT_CAP_END,F,E),M(s,a,a,0,L.RIGHT_CAP_END,F,E)),W(S,A+x,S,A,x),R=W(S,R-x,S,R,x),this._parameters.wireframe&&this._addWireframeVertices(o,A,R,x)}_addWireframeVertices(e,t,r,i){const o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let s=0;const a=e=>s=W(n,e,o,s,i);for(let l=0;l<n.length-1;l+=2*i)a(l),a(l+2*i),a(l+1*i),a(l+2*i),a(l+1*i),a(l+3*i)}}function W(e,t,r,i,o){for(let n=0;n<o;n++)r[i++]=e[t++];return i}function U(e,t){return!!e.isClosed&&t.get(w.r.POSITION).indices.length>2}const B=(0,c.c)(),G=(0,c.c)(),k=(0,c.c)(),q=(0,c.c)(),Z=(0,c.c)(),$=(0,s.r_)(),X=(0,s.r_)(),Y=(0,c.c)(),Q=(0,c.c)(),J=(0,u.vt)(),K=(0,u.vt)(),ee=(0,c.c)(),te=(0,c.c)(),re=(0,c.c)(),ie=[(0,s.r_)(),(0,s.r_)(),(0,s.r_)(),(0,s.r_)()],oe=[(0,c.c)(),(0,c.c)(),(0,c.c)(),(0,c.c)()],ne=(0,p.vt)(),se=(0,p.vt)(),ae=(0,p.vt)(),le=(0,p.vt)()},52873:(e,t,r)=>{r.d(t,{W:()=>n});var i=r(45722),o=r(29117);class n extends i.im{intersect(e,t,r,i,n,s){return(0,o.Uy)(e,r,i,n,void 0,s)}}},42649:(e,t,r)=>{r.d(t,{Z:()=>M,d:()=>I});var i=r(39831),o=r(60882),n=r(78286),s=r(22279),a=r(52712),l=r(55274),c=r(46068),d=r(45722),h=r(1931),u=r(38323),p=r(25146),f=r(27776),m=r(52873),g=r(67341),v=r(66866),_=r(10714),y=r(39486),w=(r(41679),r(47705)),O=r(33444),T=r(69948),C=r(13148),S=r(58123),b=r(81868),x=r(9319),R=r(33006),A=r(2449);class E extends O.w{initializeConfiguration(e,t){t.spherical=e.viewingMode===_.RT.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new S.B(e.rctx,E.shader.get().build(this.configuration),C.D)}_setPipelineState(e){const t=this.configuration,r=e===b.y.NONE,i=e===b.y.FrontFace;return(0,A.Ey)({blending:t.output!==l.V.Normal&&t.output!==l.V.Highlight&&t.output!==l.V.ObjectAndLayerIdColor&&t.transparent?r?h.V0:(0,h.ez)(e):null,depthTest:{func:(0,h.K_)(e)},depthWrite:r?t.writeDepth?A.kn:null:(0,h.XO)(e),colorWrite:A.wE,polygonOffset:r||i?null:(0,h.aB)(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}E.shader=new w.$(R.W,(()=>r.e(114).then(r.bind(r,40114))));class P extends x.E{constructor(){super(...arguments),this.output=l.V.Color,this.transparencyPassType=b.y.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.isDraped=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}}(0,v._)([(0,T.W)({count:l.V.COUNT})],P.prototype,"output",void 0),(0,v._)([(0,T.W)({count:b.y.COUNT})],P.prototype,"transparencyPassType",void 0),(0,v._)([(0,T.W)()],P.prototype,"spherical",void 0),(0,v._)([(0,T.W)()],P.prototype,"receiveShadows",void 0),(0,v._)([(0,T.W)()],P.prototype,"hasSlicePlane",void 0),(0,v._)([(0,T.W)()],P.prototype,"transparent",void 0),(0,v._)([(0,T.W)()],P.prototype,"enableOffset",void 0),(0,v._)([(0,T.W)()],P.prototype,"writeDepth",void 0),(0,v._)([(0,T.W)()],P.prototype,"hasScreenSpaceReflections",void 0),(0,v._)([(0,T.W)()],P.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,v._)([(0,T.W)()],P.prototype,"hasCloudsReflections",void 0),(0,v._)([(0,T.W)()],P.prototype,"objectAndLayerIdColorInstanced",void 0),(0,v._)([(0,T.W)()],P.prototype,"isDraped",void 0),(0,v._)([(0,T.W)()],P.prototype,"multipassEnabled",void 0),(0,v._)([(0,T.W)()],P.prototype,"cullAboveGround",void 0),(0,v._)([(0,T.W)({constValue:!1})],P.prototype,"occlusionPass",void 0),(0,v._)([(0,T.W)({constValue:y.A9.Water})],P.prototype,"pbrMode",void 0),(0,v._)([(0,T.W)({constValue:!0})],P.prototype,"useCustomDTRExponentForWater",void 0),(0,v._)([(0,T.W)({constValue:!0})],P.prototype,"highStepCount",void 0),(0,v._)([(0,T.W)({constValue:!1})],P.prototype,"useFillLights",void 0);class D extends g.A{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){const t=null!=e.ssr.lastFrameColor;t!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:t})}_updateCloudsReflectionState(e){const t=null!=e.cloudsFade.data;t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===l.V.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(E,e)}}class M extends m.W{constructor(e){super(e,new I),this._configuration=new P,this._animation=new c.a}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<h.xt,this._configuration.multipassEnabled=t.multipassEnabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this._animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<N;const r=this._animation.advance(e);return this.setParameters({timeElapsed:(0,o.y)(this._animation.time)*this.parameters.animationSpeed},!1),this._animation.enabled&&r}produces(e,t){switch(t){case l.V.Normal:return e===u.N.DRAPED_WATER;case l.V.Color:if(this.parameters.isDraped)return e===u.N.DRAPED_MATERIAL;break;case l.V.Alpha:break;case l.V.Highlight:case l.V.ObjectAndLayerIdColor:return e===u.N.OPAQUE_MATERIAL||e===u.N.DRAPED_MATERIAL;default:return!1}let r=u.N.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?u.N.TRANSPARENT_MATERIAL:u.N.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===r}createGLMaterial(e){return new D(e)}createBufferWriter(){return new p.Z((0,i.A)("enable-feature:objectAndLayerId-rendering")?f.Dq:f.zK)}get test(){return{animationEnabled:this._animation.enabled}}}class I extends d.qA{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=(0,n.f)(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=(0,a.f)(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=(0,s.c)(),this.modelTransformation=null}}const N=35e3},86868:(e,t,r)=>{r.d(t,{Xq:()=>a,wk:()=>s});const i={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},o={dash:i.dash,"dash-dot":[...i.dash,...i.dot],dot:i.dot,"long-dash":i["long-dash"],"long-dash-dot":[...i["long-dash"],...i.dot],"long-dash-dot-dot":[...i["long-dash"],...i.dot,...i.dot],none:null,"short-dash":i["short-dash"],"short-dash-dot":[...i["short-dash"],...i["short-dot"]],"short-dash-dot-dot":[...i["short-dash"],...i["short-dot"],...i["short-dot"]],"short-dot":i["short-dot"],solid:null},n=8;function s(e){return{pattern:[e,e],pixelRatio:2}}function a(e){return null!=e&&"style"===e.type?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(o[e],n):null}(e.style):null}},58376:(e,t,r)=>{r.d(t,{Dt:()=>d,kJ:()=>o,lM:()=>i});var i,o,n=r(66866),s=r(55274),a=r(69948),l=r(81868),c=r(9319);!function(e){e[e.Draped=0]="Draped",e[e.Screen=1]="Screen",e[e.World=2]="World",e[e.COUNT=3]="COUNT"}(i||(i={})),function(e){e[e.Center=0]="Center",e[e.Tip=1]="Tip",e[e.COUNT=2]="COUNT"}(o||(o={}));class d extends c.E{constructor(){super(...arguments),this.output=s.V.Color,this.transparencyPassType=l.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=i.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=o.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===i.Draped}}(0,n._)([(0,a.W)({count:s.V.COUNT})],d.prototype,"output",void 0),(0,n._)([(0,a.W)({count:l.y.COUNT})],d.prototype,"transparencyPassType",void 0),(0,n._)([(0,a.W)()],d.prototype,"occluder",void 0),(0,n._)([(0,a.W)()],d.prototype,"hasSlicePlane",void 0),(0,n._)([(0,a.W)()],d.prototype,"writeDepth",void 0),(0,n._)([(0,a.W)({count:i.COUNT})],d.prototype,"space",void 0),(0,n._)([(0,a.W)()],d.prototype,"hideOnShortSegments",void 0),(0,n._)([(0,a.W)()],d.prototype,"hasCap",void 0),(0,n._)([(0,a.W)({count:o.COUNT})],d.prototype,"anchor",void 0),(0,n._)([(0,a.W)()],d.prototype,"hasTip",void 0),(0,n._)([(0,a.W)()],d.prototype,"vvSize",void 0),(0,n._)([(0,a.W)()],d.prototype,"vvColor",void 0),(0,n._)([(0,a.W)()],d.prototype,"vvOpacity",void 0),(0,n._)([(0,a.W)()],d.prototype,"hasOccludees",void 0),(0,n._)([(0,a.W)()],d.prototype,"multipassEnabled",void 0),(0,n._)([(0,a.W)()],d.prototype,"cullAboveGround",void 0),(0,n._)([(0,a.W)({constValue:!1})],d.prototype,"occlusionPass",void 0),(0,n._)([(0,a.W)({constValue:!0})],d.prototype,"hasVvInstancing",void 0),(0,n._)([(0,a.W)({constValue:!0})],d.prototype,"hasSliceTranslatedView",void 0)},16906:(e,t,r)=>{r.d(t,{Q:()=>c,x:()=>i});var i,o=r(66866),n=r(55274),s=r(69948),a=r(81868),l=r(9319);!function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"}(i||(i={}));class c extends l.E{constructor(){super(...arguments),this.output=n.V.Color,this.capType=i.BUTT,this.transparencyPassType=a.y.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}}(0,o._)([(0,s.W)({count:n.V.COUNT})],c.prototype,"output",void 0),(0,o._)([(0,s.W)({count:i.COUNT})],c.prototype,"capType",void 0),(0,o._)([(0,s.W)({count:a.y.COUNT})],c.prototype,"transparencyPassType",void 0),(0,o._)([(0,s.W)()],c.prototype,"occluder",void 0),(0,o._)([(0,s.W)()],c.prototype,"hasSlicePlane",void 0),(0,o._)([(0,s.W)()],c.prototype,"hasPolygonOffset",void 0),(0,o._)([(0,s.W)()],c.prototype,"writeDepth",void 0),(0,o._)([(0,s.W)()],c.prototype,"draped",void 0),(0,o._)([(0,s.W)()],c.prototype,"stippleEnabled",void 0),(0,o._)([(0,s.W)()],c.prototype,"stippleOffColorEnabled",void 0),(0,o._)([(0,s.W)()],c.prototype,"stipplePreferContinuous",void 0),(0,o._)([(0,s.W)()],c.prototype,"roundJoins",void 0),(0,o._)([(0,s.W)()],c.prototype,"applyMarkerOffset",void 0),(0,o._)([(0,s.W)()],c.prototype,"vvSize",void 0),(0,o._)([(0,s.W)()],c.prototype,"vvColor",void 0),(0,o._)([(0,s.W)()],c.prototype,"vvOpacity",void 0),(0,o._)([(0,s.W)()],c.prototype,"falloffEnabled",void 0),(0,o._)([(0,s.W)()],c.prototype,"innerColorEnabled",void 0),(0,o._)([(0,s.W)()],c.prototype,"hasOccludees",void 0),(0,o._)([(0,s.W)()],c.prototype,"multipassEnabled",void 0),(0,o._)([(0,s.W)()],c.prototype,"cullAboveGround",void 0),(0,o._)([(0,s.W)()],c.prototype,"wireframe",void 0),(0,o._)([(0,s.W)()],c.prototype,"objectAndLayerIdColorInstanced",void 0),(0,o._)([(0,s.W)({constValue:!1})],c.prototype,"occlusionPass",void 0),(0,o._)([(0,s.W)({constValue:!0})],c.prototype,"hasVvInstancing",void 0),(0,o._)([(0,s.W)({constValue:!0})],c.prototype,"hasSliceTranslatedView",void 0)}}]);